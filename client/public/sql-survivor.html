<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Learn SQL with Survivor</title>
<link href="https://fonts.googleapis.com/css2?family=Newsreader:opsz,wght@6..72,300;6..72,400;6..72,600;6..72,700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
@font-face {
  font-family: 'Survivant';
  src: url('/survivant.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}
</style>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--torch:#d4611e;--jungle:#2e6b47;--sand:#f5e6cc;--dark:#1a1612;--gray:#8a7e70;--light-bg:#f9f6f1;--page-bg:#f4f0e8;--border:#e0d8cc;--white:#fff}
body{font-family:'Newsreader',Georgia,serif;background:var(--page-bg);color:var(--dark);line-height:1.6}
.mono{font-family:'JetBrains Mono','Fira Code',monospace}
header{background:linear-gradient(135deg,#1a1612,#2a2218);padding:20px 32px 12px;border-bottom:3px solid var(--torch)}
.header-inner{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.header-title{font-size:28px;font-weight:700;color:var(--torch);letter-spacing:1px}
.header-label{font-size:10px;font-weight:700;letter-spacing:3px;color:var(--gray);text-transform:uppercase}

/* Torch Tracker */
.torch-tracker{max-width:1100px;margin:0 auto;padding:8px 0 6px;display:flex;gap:4px;align-items:flex-end;justify-content:center;flex-wrap:wrap}
.torch-item{display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;transition:transform 0.2s;min-width:36px}
.torch-item:hover{transform:scale(1.15)}
.torch-flame{font-size:22px;transition:all 0.3s;filter:grayscale(1) opacity(0.3)}
.torch-flame.lit{filter:grayscale(0) opacity(1);animation:flicker 2s ease-in-out infinite alternate}
.torch-flame.active{filter:grayscale(0) opacity(1);transform:scale(1.2)}
.torch-num{font-size:9px;font-weight:700;color:#6a6258}
.torch-num.lit{color:var(--torch)}
.torch-num.active{color:var(--torch);font-weight:800}
@keyframes flicker{0%{transform:scale(1) rotate(-2deg)}50%{transform:scale(1.05) rotate(1deg)}100%{transform:scale(1) rotate(-1deg)}}

nav{background:var(--dark);border-bottom:1px solid #3a3228;position:sticky;top:0;z-index:100}
.nav-inner{max-width:1100px;margin:0 auto;display:flex}
.nav-btn{padding:12px 20px;border:none;border-bottom:2px solid transparent;background:transparent;color:#6a6258;font-size:13px;font-weight:600;cursor:pointer;letter-spacing:.5px;transition:all .2s}
.nav-btn:hover{color:#c4b8a8}
.nav-btn.active{color:#e8dfd4;border-bottom-color:var(--torch)}
.api-gear{background:none;border:none;color:#6a6258;font-size:15px;cursor:pointer;padding:12px 10px}
.api-bar{background:#2a2218;border-bottom:1px solid #3a3228;overflow:hidden;transition:max-height .3s}
.api-bar-inner{max-width:1100px;margin:0 auto;padding:10px 24px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.api-bar label{font-size:11px;color:var(--gray);white-space:nowrap}
.api-bar input{flex:1;min-width:180px;padding:5px 10px;border-radius:5px;border:1px solid #4a4038;background:#1a1612;color:#e8dfd4;font-size:12px;outline:none}
.api-bar .api-save{padding:5px 14px;border-radius:5px;border:1px solid var(--torch);background:var(--torch);color:var(--white);font-size:11px;font-weight:600;cursor:pointer}
.api-bar .api-status{font-size:10px;color:#6a8a5a}

main{max-width:1100px;margin:0 auto;padding:28px 24px}
h2{font-size:24px;color:var(--torch);margin-bottom:6px}
.subtitle{font-size:14px;color:#6a6258;line-height:1.6;margin-bottom:24px}

/* Module Grid */
.module-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.module-card{text-align:left;padding:20px;background:var(--white);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.04);position:relative;overflow:hidden}
.module-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.08);transform:translateY(-1px)}
.module-card.done{background:#f0faf2;border:2px solid var(--jungle)}
.module-card .badge{position:absolute;top:10px;right:10px;background:var(--jungle);color:var(--white);font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px}
.module-card .icon{font-size:32px;margin-bottom:6px}
.module-card .mod-label{font-size:10px;color:var(--torch);font-weight:700;letter-spacing:1px;margin-bottom:3px}
.module-card h3{font-size:15px;font-weight:600;margin-bottom:10px}
.module-card .count{font-size:12px;color:var(--gray);margin-bottom:10px}
.progress-bar{display:flex;align-items:center;gap:10px}
.progress-track{flex:1;height:7px;background:#e8e0d4;border-radius:4px;overflow:hidden;min-width:60px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--torch),#e8943e);border-radius:4px;transition:width .5s}
.progress-count{font-size:12px;font-weight:700;color:var(--gray);white-space:nowrap}

.back-btn{display:inline-flex;align-items:center;gap:5px;background:none;border:none;color:var(--gray);font-size:13px;cursor:pointer;padding:0 0 16px;font-family:inherit}
.back-btn:hover{color:var(--torch)}
.concept-box{background:var(--light-bg);border:1px solid var(--border);border-radius:12px;padding:20px;margin:12px 0 28px;border-left:4px solid var(--jungle)}
.concept-box .label{font-size:10px;font-weight:700;color:var(--jungle);letter-spacing:1px;margin-bottom:8px}
.concept-box p{font-size:14px;line-height:1.7;color:#3a3228;margin-bottom:10px}
.concept-box .tip{font-size:12px;color:var(--gray);font-style:italic;margin-top:6px}

/* Code Block */
.code-block{position:relative;background:#1a1612;border-radius:7px;padding:14px 18px;margin:10px 0;font-size:12px;line-height:1.7;color:#e8dfd4;overflow-x:auto;border:1px solid #3a3228}
.code-block pre{margin:0;white-space:pre-wrap;word-wrap:break-word}
.code-block .copy-btn{position:absolute;top:6px;right:6px;background:#2a2420;border:1px solid #4a4038;border-radius:3px;color:#c4b8a8;font-size:10px;padding:2px 8px;cursor:pointer}
.code-block .copy-btn.copied{background:var(--jungle);color:var(--white)}
.kw{color:#d4843e;font-weight:600}.str{color:#8fbc6f}.cmt{color:#6a6258}

/* Scenario */
.scenario{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.scenario.done{border:2px solid var(--jungle);box-shadow:0 0 0 3px rgba(46,107,71,.1)}
.scenario.wrong{border:2px solid #c0392b;box-shadow:0 0 0 3px rgba(192,57,43,.1)}
.scenario-top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px}
.scenario .s-label{font-size:11px;color:var(--torch);font-weight:700;letter-spacing:1px}
.scenario h4{font-size:15px;font-weight:600;margin-top:3px}
.check-btn{flex-shrink:0;width:26px;height:26px;border-radius:50%;border:2px solid #ccc;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--white);transition:all .2s}
.check-btn.done{border-color:var(--jungle);background:var(--jungle)}
.question{font-size:14px;line-height:1.6;color:#3a3228;margin-bottom:10px}
.table-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px}
.table-tag{font-size:10px;font-weight:600;padding:2px 8px;border-radius:5px;background:#f0ebe2;color:#8a7060;border:1px solid #e0d4c4;position:relative;cursor:help}
.table-tag:hover .table-tag-cols{display:block}
.table-tag-cols{display:none;position:absolute;top:calc(100% + 6px);left:0;z-index:200;background:#1a1612;border:1px solid #4a4038;border-radius:7px;padding:8px 12px;min-width:220px;max-width:340px;box-shadow:0 6px 20px rgba(0,0,0,.4)}
.table-tag-cols .ttc-name{font-size:9px;font-weight:700;color:var(--torch);letter-spacing:1px;margin-bottom:6px}
.table-tag-cols .ttc-cols{display:flex;flex-wrap:wrap;gap:4px}
.table-tag-cols .ttc-col{font-size:10px;background:#2a2218;color:#c4b8a8;padding:2px 7px;border-radius:4px;font-family:'JetBrains Mono',monospace;white-space:nowrap}
.editor-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--gray);margin-bottom:5px}
.sql-editor{width:100%;min-height:70px;padding:10px 12px;font-size:12px;line-height:1.6;background:#faf8f5;border:1px solid var(--border);border-radius:7px;resize:vertical;color:var(--dark);outline:none}
.sql-editor:focus{border-color:var(--torch);box-shadow:0 0 0 3px rgba(212,97,30,.1)}
.toggle-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.toggle-row button{padding:6px 13px;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.hint-btn{border:1px solid #e0c97a;background:transparent;color:#9a7b20}
.hint-btn.open{background:#fdf5e0}
.answer-btn{border:1px solid #7bb88a;background:transparent;color:var(--jungle)}
.answer-btn.open{background:#eaf5ec}
.ai-toggle{border:1px solid #7ba3c8;background:transparent;color:#3b7ab5}
.ai-toggle.open{background:#e8f0f8}
.check-query-btn{border:1px solid var(--torch);background:var(--torch);color:var(--white)}
.check-query-btn:hover{background:#c0551a}
.hint-box{margin-top:10px;padding:10px 14px;background:#fdf8e8;border-radius:7px;border-left:3px solid #e0c97a;font-size:13px;color:#7a6520;font-style:italic;line-height:1.5}
.answer-header{margin-top:10px;padding:3px 10px;background:#eaf5ec;border-radius:7px 7px 0 0;border-left:3px solid var(--jungle);display:inline-block;font-size:10px;font-weight:700;color:var(--jungle);letter-spacing:1px}

/* Query feedback */
.feedback-box{margin-top:10px;padding:12px 14px;border-radius:7px;font-size:13px;line-height:1.6}
.feedback-box.correct{background:#eaf5ec;border-left:3px solid var(--jungle);color:#1a5a2a}
.feedback-box.incorrect{background:#fef0ee;border-left:3px solid #c0392b;color:#7a1a1a}
.feedback-box .fb-line{margin:3px 0;padding:2px 6px;border-radius:3px}
.fb-right{background:rgba(46,107,71,.1);color:#1a5a2a}
.fb-wrong{background:rgba(192,57,43,.1);color:#7a1a1a;text-decoration:line-through}
.fb-missing{background:rgba(212,97,30,.1);color:#8a4a10}

/* AI Chat */
.ai-section{margin-top:14px;border-top:1px dashed var(--border);padding-top:14px}
.ai-panel{margin-top:10px;background:#f8f9fc;border:1px solid #d4dde8;border-radius:9px;overflow:hidden}
.ai-messages{max-height:280px;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px}
.ai-msg{padding:8px 12px;border-radius:7px;font-size:13px;line-height:1.6;max-width:88%;white-space:pre-wrap;word-wrap:break-word}
.ai-msg.user{background:#e0ecf5;color:#1a3a5c;align-self:flex-end;border-bottom-right-radius:2px}
.ai-msg.assistant{background:var(--white);color:#2a2a2a;align-self:flex-start;border:1px solid #e4e8ed;border-bottom-left-radius:2px}
.ai-msg.system{background:#fdf8e8;color:#7a6520;align-self:center;font-size:11px;font-style:italic;text-align:center}
.ai-msg.error{background:#fdeaea;color:#8b2020;align-self:center;font-size:12px}
.ai-input-row{display:flex;border-top:1px solid #d4dde8}
.ai-input{flex:1;padding:10px 12px;border:none;outline:none;font-size:13px;font-family:inherit;background:var(--white)}
.ai-send{padding:10px 16px;border:none;background:#3b7ab5;color:var(--white);font-weight:600;font-size:13px;cursor:pointer}
.ai-send:disabled{background:#a0b8cc;cursor:not-allowed}

/* Bonus section */
.bonus-section{margin-top:24px;padding:20px;background:#fef9f0;border:2px dashed #e0c97a;border-radius:12px}
.bonus-title{font-size:14px;font-weight:700;color:#9a7b20;margin-bottom:12px;display:flex;align-items:center;gap:8px}

/* Live Practice */
.live-section{margin-top:28px;padding:20px;background:#050e07;border:2px solid #2e6b47;border-radius:12px}
.live-title{font-size:14px;font-weight:700;color:#6ab57a;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.live-q{background:#0d1a10;border:1px solid #1e4a2a;border-radius:10px;padding:18px;margin-bottom:14px}
.live-q:last-child{margin-bottom:0}
.live-q-label{font-size:10px;font-weight:700;color:#6ab57a;letter-spacing:1px;margin-bottom:4px}
.live-q-title{font-size:15px;font-weight:600;color:#e8dfd4;margin-bottom:8px}
.live-challenge{font-size:14px;line-height:1.6;color:#b4c8b8;margin-bottom:12px}
.live-editor{width:100%;min-height:70px;padding:10px 12px;font-size:12px;line-height:1.6;background:#060c08;border:1px solid #2a3d2e;border-radius:7px;resize:vertical;color:#e8dfd4;outline:none;font-family:'JetBrains Mono','Fira Code',monospace}
.live-editor:focus{border-color:#6ab57a;box-shadow:0 0 0 3px rgba(106,181,122,.12)}
.live-run-btn{padding:7px 18px;border-radius:6px;border:none;background:#2e6b47;color:#fff;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:.5px;transition:background .2s;font-family:'JetBrains Mono',monospace}
.live-run-btn:hover:not(:disabled){background:#1f5234}
.live-run-btn:disabled{background:#142a1c;color:#4a7a5a;cursor:not-allowed}
.live-results-box{margin-top:14px;background:#060c08;border:1px solid #1e3a24;border-radius:8px;overflow:hidden;display:none}
.live-results-box.visible{display:block}
.live-results-hdr{background:#0d1a10;padding:7px 14px;border-bottom:1px solid #1e3a24;display:flex;align-items:center;gap:8px}
.live-results-lbl{font-size:10px;font-weight:700;color:#6ab57a;letter-spacing:1.5px}
.live-results-ct{font-size:10px;color:#5a7a5a;background:#0a1a0c;padding:1px 7px;border-radius:8px}
.live-results-ms{font-size:10px;color:#5a7a5a}
.live-results-body{overflow-x:auto;max-height:280px;overflow-y:auto}
.live-hint-btn{border:1px solid #6a5a20;background:transparent;color:#9a8a40;padding:5px 12px;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.live-hint-btn.open{background:#1a1500;border-color:#9a8a40}
.live-answer-btn{border:1px solid #2e6b47;background:transparent;color:#6ab57a;padding:5px 12px;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.live-answer-btn.open{background:#0d1a10}

/* Module nav */
.mod-nav{display:flex;justify-content:space-between;margin-top:28px;padding-top:20px;border-top:1px solid var(--border)}
.mod-nav button{padding:9px 18px;border-radius:7px;font-size:13px;cursor:pointer;font-family:inherit}
.mod-nav .prev{border:1px solid var(--border);background:var(--white);color:#3a3228}
.mod-nav .next{border:1px solid var(--torch);background:var(--torch);color:var(--white);font-weight:600}

/* Tables */
.table-card{background:var(--white);border:1px solid var(--border);border-radius:9px;padding:16px 20px;margin-bottom:10px}
.table-name{font-size:15px;font-weight:700;color:var(--torch)}
.table-rows{font-size:11px;color:var(--gray);background:var(--page-bg);padding:2px 8px;border-radius:10px}
.table-desc{font-size:13px;color:#6a6258;margin-bottom:6px}
.table-cols{font-size:11px;color:var(--gray);background:var(--light-bg);padding:5px 9px;border-radius:5px}

/* Cheat */
.cheat-table{background:var(--white);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.cheat-header{display:grid;grid-template-columns:130px 1fr 1fr;background:var(--dark);padding:10px 18px}
.cheat-header span{font-size:10px;font-weight:700;color:var(--gray);letter-spacing:1px}
.cheat-row{display:grid;grid-template-columns:130px 1fr 1fr;padding:9px 18px;border-top:1px solid #eee}
.cheat-row:nth-child(even){background:var(--light-bg)}
.cheat-kw{font-weight:700;color:var(--torch);font-size:12px}
.cheat-does{font-size:13px;color:#3a3228}
.cheat-ex{font-size:11px;color:#6a6258}
.ops-box{margin-top:36px;background:var(--dark);border-radius:10px;padding:22px 26px}
.ops-label{font-size:10px;font-weight:700;color:var(--torch);letter-spacing:1px;margin-bottom:10px}
.ops-box p{color:#c4b8a8;font-size:13px;line-height:1.7;margin-bottom:14px}
.ops-flow{display:flex;flex-wrap:wrap;gap:7px;align-items:center}
.ops-kw{font-size:13px;font-weight:700;color:#d4843e;background:#2a2218;padding:3px 10px;border-radius:5px}
.ops-arrow{color:#4a4038;font-size:14px}

/* Modal overlay */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s}
.modal-box{background:#1a1612;border:2px solid var(--torch);border-radius:16px;padding:36px 40px;max-width:520px;width:90%;text-align:center;animation:popIn .4s;position:relative}
.modal-box h3{font-size:22px;color:var(--torch);margin-bottom:12px}
.modal-box p{font-size:15px;color:#c4b8a8;line-height:1.7;margin-bottom:20px}
.modal-box .modal-btn{padding:10px 28px;border:none;border-radius:8px;background:var(--torch);color:var(--white);font-size:15px;font-weight:600;cursor:pointer;font-family:inherit}
.modal-box .modal-btn:hover{background:#c0551a}
.modal-box .wrong-list{text-align:left;margin:12px 0 20px;padding:0 16px}
.modal-box .wrong-list li{color:#e8943e;font-size:14px;margin:4px 0}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes popIn{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}

/* Tribe has spoken animation */
.tribe-spoken-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1001;display:flex;align-items:center;justify-content:center;flex-direction:column;animation:fadeIn .5s}
.tribe-spoken-text{font-size:42px;font-weight:700;color:var(--torch);text-align:center;animation:torchReveal 1.5s ease-out;text-shadow:0 0 40px rgba(212,97,30,.6)}
.tribe-spoken-sub{font-size:18px;color:#c4b8a8;margin-top:12px;animation:torchReveal 1.5s ease-out .3s both}
.tribe-flame-row{font-size:48px;margin-bottom:20px;animation:torchReveal 1s ease-out}
@keyframes torchReveal{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

footer{text-align:center;padding:28px 24px;color:var(--gray);font-size:12px;border-top:1px solid var(--border);margin-top:36px}
.hidden{display:none}
@media(max-width:600px){.header-inner{flex-direction:column;align-items:flex-start}.cheat-header,.cheat-row{grid-template-columns:90px 1fr 1fr}}

/* ===== BLACK BACKGROUND + FLICKERING TORCHES ===== */
html,body{background:#000 !important}
header,nav,main,footer{position:relative;z-index:1}
#bg-torches{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.bt-wrap{position:absolute;bottom:0;display:flex;flex-direction:column;align-items:center}
.bt-flames{position:relative;width:44px;height:70px}
.bt-glow{position:absolute;top:-10px;left:50%;transform:translateX(-50%);width:80px;height:80px;border-radius:50%;background:radial-gradient(ellipse at center,rgba(212,97,30,0.45) 0%,rgba(212,97,30,0.15) 40%,transparent 70%);animation:glowPulse var(--dur,1.8s) ease-in-out infinite alternate}
.bt-f{position:absolute;bottom:0;border-radius:50% 50% 20% 20%;transform-origin:bottom center;animation:btFlame var(--dur,1.8s) ease-in-out infinite alternate}
.bt-f1{left:10px;width:22px;height:50px;background:radial-gradient(ellipse at 50% 100%,#fff 0%,#ffe066 20%,#ff7c00 60%,transparent 100%);animation-duration:var(--dur)}
.bt-f2{left:13px;width:16px;height:36px;background:radial-gradient(ellipse at 50% 100%,#fff 0%,#ffcc00 30%,#ff4400 75%,transparent 100%);animation-duration:calc(var(--dur)*0.75);animation-direction:alternate-reverse}
.bt-f3{left:16px;width:11px;height:22px;background:radial-gradient(ellipse at 50% 100%,rgba(255,255,200,0.9) 0%,#ff6600 55%,transparent 100%);animation-duration:calc(var(--dur)*1.2)}
@keyframes btFlame{0%{transform:scaleX(1) scaleY(1) rotate(-4deg);opacity:.85}25%{transform:scaleX(.88) scaleY(1.12) rotate(3deg);opacity:1}50%{transform:scaleX(1.1) scaleY(.93) rotate(-2deg);opacity:.88}75%{transform:scaleX(.93) scaleY(1.08) rotate(4deg);opacity:1}100%{transform:scaleX(1) scaleY(1) rotate(-3deg);opacity:.9}}
@keyframes glowPulse{0%{opacity:.45;transform:translateX(-50%) scale(1)}100%{opacity:.85;transform:translateX(-50%) scale(1.35)}}
.bt-head{width:28px;height:18px;background:linear-gradient(180deg,#8b5e1a,#5a3810);border-radius:5px 5px 3px 3px;border:1px solid #3a2408;box-shadow:0 0 8px rgba(212,97,30,0.4)}
.bt-pole{width:9px;background:linear-gradient(180deg,#6b4510,#3a2408);border-radius:5px}

/* ===== PLAYGROUND TAB ===== */
#tab-playground{padding-top:4px}
.pg-layout{display:grid;grid-template-columns:1fr;gap:16px}
.pg-editor-panel{background:var(--white);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.pg-editor-header{background:#1a1612;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.pg-editor-label{font-size:10px;font-weight:700;color:var(--torch);letter-spacing:1.5px}
.pg-run-btn{padding:7px 18px;border-radius:6px;border:none;background:var(--torch);color:var(--white);font-size:12px;font-weight:700;cursor:pointer;letter-spacing:.5px;transition:background .2s}
.pg-run-btn:hover:not(:disabled){background:#c0551a}
.pg-run-btn:disabled{background:#5a4a3a;color:#8a7e70;cursor:not-allowed}
.pg-clear-btn{padding:7px 14px;border-radius:6px;border:1px solid #4a4038;background:transparent;color:#8a7e70;font-size:12px;cursor:pointer;transition:all .2s}
.pg-clear-btn:hover{border-color:#6a5a4a;color:#c4b8a8}
.pg-textarea{width:100%;min-height:120px;max-height:320px;padding:14px 18px;font-size:13px;line-height:1.7;background:#1a1612;border:none;border-top:1px solid #3a3228;color:#e8dfd4;resize:vertical;outline:none;font-family:'JetBrains Mono','Fira Code',monospace}
.pg-textarea:focus{border-top-color:var(--torch)}
.pg-meta-row{padding:8px 16px;background:#12100e;border-top:1px solid #2a2218;display:flex;gap:16px;align-items:center;flex-wrap:wrap;min-height:32px}
.pg-meta-item{font-size:11px;color:#6a6258}
.pg-status-dot{width:7px;height:7px;border-radius:50%;background:#3a3228;display:inline-block;margin-right:6px;flex-shrink:0}
.pg-status-dot.ready{background:var(--jungle)}
.pg-status-dot.loading{background:#e0c97a;animation:blink .8s step-end infinite}
.pg-status-dot.error{background:#c0392b}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.pg-loading-overlay{padding:60px 24px;text-align:center;color:#6a6258}
.pg-spinner{font-size:36px;display:inline-block;margin-bottom:12px;animation:spin 2s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.pg-loading-bar-track{width:260px;height:6px;background:#e0d8cc;border-radius:3px;margin:14px auto 0;overflow:hidden}
.pg-loading-bar-fill{height:100%;background:linear-gradient(90deg,var(--torch),#e8943e);border-radius:3px;width:0%;transition:width .3s}
.pg-table-list{background:#1a1612;border:1px solid #3a3228;border-radius:12px;padding:14px 16px}
.pg-table-list-label{font-size:10px;font-weight:700;color:var(--torch);letter-spacing:1.5px;margin-bottom:10px}
.pg-table-chip{display:inline-block;margin:3px 3px;padding:3px 9px;background:#2a2218;border:1px solid #4a4038;border-radius:5px;font-size:11px;color:#c4b8a8;cursor:pointer;transition:all .2s;font-family:'JetBrains Mono',monospace}
.pg-table-chip:hover{background:#3a3228;color:var(--torch);border-color:var(--torch)}
.pg-results-panel{background:#1a1612;border:1px solid #3a3228;border-radius:12px;overflow:hidden}
.pg-results-header{background:#1a1612;padding:9px 16px;border-bottom:1px solid #3a3228;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.pg-results-label{font-size:10px;font-weight:700;color:var(--torch);letter-spacing:1.5px}
.pg-results-count{font-size:11px;color:#8a7e70;background:#2a2218;padding:2px 8px;border-radius:10px}
.pg-results-time{font-size:11px;color:#8a7e70}
.pg-results-body{overflow-x:auto;max-height:420px;overflow-y:auto;background:#1a1612}
.pg-table{width:100%;border-collapse:collapse;font-size:12px}
.pg-table th{background:#0e0c0a;color:var(--torch);font-weight:700;font-size:10px;letter-spacing:.8px;padding:8px 12px;text-align:left;position:sticky;top:0;white-space:nowrap;border-bottom:1px solid #3a3228}
.pg-table td{padding:7px 12px;border-bottom:1px solid #2a2218;color:#c4b8a8;white-space:nowrap;max-width:300px;overflow:hidden;text-overflow:ellipsis}
.pg-table tr:nth-child(even) td{background:#141210}
.pg-table tr:hover td{background:#2a2218}
.pg-null-cell{color:#5a5248;font-style:italic;font-size:11px}
.pg-error-box{padding:16px 20px;background:#1a0c0c;border-left:4px solid #c0392b;margin:12px;border-radius:6px;font-family:'JetBrains Mono','Fira Code',monospace;font-size:12px;color:#e87878;line-height:1.6;white-space:pre-wrap;word-break:break-word}
.pg-placeholder{padding:40px 24px;text-align:center;color:#5a5248;font-size:14px}

/* Table detail modal */
.pg-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000;display:none;align-items:center;justify-content:center;animation:fadeIn .2s}
.pg-modal-overlay.visible{display:flex}
.pg-modal-box{background:var(--white);border-radius:14px;width:90%;max-width:780px;max-height:82vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:popIn .25s}
.pg-modal-header{background:#1a1612;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-shrink:0}
.pg-modal-title{font-size:14px;font-weight:700;color:var(--torch);font-family:'JetBrains Mono',monospace}
.pg-modal-subtitle{font-size:11px;color:#6a6258;margin-top:2px}
.pg-modal-close{background:none;border:none;color:#6a6258;font-size:20px;cursor:pointer;line-height:1;padding:2px 6px;border-radius:4px}
.pg-modal-close:hover{color:#c4b8a8;background:#2a2218}
.pg-modal-body{overflow-y:auto;padding:0}
.pg-modal-section-label{font-size:10px;font-weight:700;color:var(--gray);letter-spacing:1.5px;padding:12px 18px 6px;background:var(--light-bg);border-bottom:1px solid var(--border)}
.pg-col-grid{display:flex;flex-wrap:wrap;gap:6px;padding:12px 18px 14px}
.pg-col-pill{font-size:11px;padding:3px 10px;border-radius:12px;background:var(--page-bg);border:1px solid var(--border);color:#3a3228;font-family:'JetBrains Mono',monospace}
.pg-modal-use-btn{margin:0 18px 14px;padding:7px 16px;border-radius:6px;border:none;background:var(--torch);color:var(--white);font-size:12px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace;display:inline-block}
.pg-modal-use-btn:hover{background:#c0551a}

/* ===== FINAL TRIBAL COUNCIL ===== */
.ftc-hero{text-align:center;padding:36px 24px 20px;background:linear-gradient(180deg,#0d0a06,#1a1208);border:1px solid #3a2e1e;border-radius:16px;margin-bottom:20px}
.ftc-torches{font-size:32px;margin-bottom:12px;letter-spacing:4px;animation:flicker 2s ease-in-out infinite alternate}
.ftc-title{font-size:38px;color:var(--torch);margin-bottom:10px;text-shadow:0 0 30px rgba(212,97,30,.5)}
.ftc-subtitle{font-size:15px;color:#c4b8a8;line-height:1.7;max-width:580px;margin:0 auto}
.ftc-ribbon{display:flex;align-items:center;gap:6px;margin-bottom:28px;padding:14px 20px;background:#1a1612;border-radius:10px;border:1px solid #3a3228;overflow-x:auto}
.ftc-ribbon-item{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:7px;transition:background .2s;white-space:nowrap}
.ftc-ribbon-item.active{background:#2e6b47}
.ftc-ribbon-item.done{background:#1e4a2a}
.ftc-step-num{width:22px;height:22px;border-radius:50%;background:#3a3228;color:#6a6258;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;flex-shrink:0}
.ftc-ribbon-item.active .ftc-step-num{background:var(--torch);color:#fff}
.ftc-ribbon-item.done .ftc-step-num{background:var(--jungle);color:#fff}
.ftc-step-label{font-size:12px;font-weight:600;color:#6a6258;letter-spacing:.3px}
.ftc-ribbon-item.active .ftc-step-label,.ftc-ribbon-item.done .ftc-step-label{color:#e8dfd4}
.ftc-ribbon-arrow{color:#3a3228;font-size:18px;font-weight:700;flex-shrink:0}
.ftc-loading-msg{padding:30px;text-align:center}
.ftc-phase{margin-bottom:28px}
.ftc-phase-header{margin-bottom:18px;background:#1a1612;border:1px solid #3a3228;border-radius:12px;padding:18px 22px}
.ftc-phase-badge{font-size:10px;font-weight:700;color:var(--torch);letter-spacing:2px;display:block;margin-bottom:6px}
.ftc-phase-title{font-size:22px;color:#e8dfd4;margin-bottom:6px}
.ftc-phase-desc{font-size:14px;color:#a09080;line-height:1.7;max-width:680px}
.ftc-challenge-card{background:var(--white);border:1px solid var(--border);border-radius:14px;padding:22px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
.ftc-challenge-label{font-size:10px;font-weight:700;color:var(--torch);letter-spacing:1.5px;margin-bottom:8px}
.ftc-challenge-text{font-size:14px;color:#3a3228;line-height:1.7;margin-bottom:14px}
.ftc-prompt-chips{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px}
.ftc-prompt-chip{padding:6px 13px;border-radius:20px;border:1px solid var(--border);background:var(--light-bg);color:#5a5248;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.ftc-prompt-chip:hover{border-color:var(--torch);background:#fef4ec;color:var(--torch)}
.ftc-editor-wrap{margin-bottom:12px}
.ftc-editor-hdr{background:#1a1612;padding:9px 14px;border-radius:7px 7px 0 0;display:flex;justify-content:space-between;align-items:center}
.ftc-editor-label{font-size:10px;font-weight:700;color:var(--torch);letter-spacing:1.5px}
.ftc-editor{width:100%;min-height:100px;padding:12px 14px;font-size:12px;line-height:1.7;background:#1a1612;border:none;border-top:1px solid #3a3228;color:#e8dfd4;resize:vertical;outline:none;font-family:'JetBrains Mono','Fira Code',monospace;border-radius:0 0 7px 7px}
.ftc-editor:focus{border-top-color:var(--torch)}
.ftc-run-btn{padding:6px 16px;border-radius:6px;border:none;background:var(--torch);color:#fff;font-size:12px;font-weight:700;cursor:pointer;transition:background .2s}
.ftc-run-btn:hover{background:#c0551a}
.ftc-run-btn:disabled{background:#5a4a3a;color:#6a6258;cursor:not-allowed}
.ftc-clear-btn{padding:6px 12px;border-radius:6px;border:1px solid #4a4038;background:transparent;color:#8a7e70;font-size:12px;cursor:pointer}
.ftc-results-area{margin-top:10px;background:#1a1612;border:1px solid #3a3228;border-radius:8px;overflow:hidden;max-height:260px;overflow-y:auto}
.ftc-table{width:100%;border-collapse:collapse;font-size:12px}
.ftc-table th{background:#0e0c0a;color:var(--torch);font-weight:700;font-size:10px;letter-spacing:.8px;padding:7px 12px;text-align:left;position:sticky;top:0;white-space:nowrap;border-bottom:1px solid #3a3228}
.ftc-table td{padding:6px 12px;border-bottom:1px solid #2a2218;color:#c4b8a8;white-space:nowrap;max-width:260px;overflow:hidden;text-overflow:ellipsis}
.ftc-table tr:nth-child(even) td{background:#141210}
.ftc-error-box{padding:12px 16px;background:#1a0c0c;border-left:4px solid #c0392b;font-family:'JetBrains Mono',monospace;font-size:12px;color:#e87878;white-space:pre-wrap;word-break:break-word}
.ftc-chart-area{margin-top:16px;background:var(--light-bg);border:1px solid var(--border);border-radius:10px;padding:16px}
.ftc-chart-controls{margin-bottom:14px}
.ftc-chart-type-btn{padding:6px 13px;border-radius:20px;border:1px solid var(--border);background:var(--white);color:#5a5248;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.ftc-chart-type-btn.active{border-color:var(--torch);background:#fef4ec;color:var(--torch)}
.ftc-col-select{padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--white);font-size:12px;color:var(--dark);font-family:'JetBrains Mono',monospace;outline:none;cursor:pointer}
.ftc-title-input{padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--white);font-size:12px;color:var(--dark);font-family:inherit;outline:none;min-width:180px}
.ftc-canvas-wrap{background:#fff;border-radius:10px;padding:16px;position:relative;min-height:320px;border:2px solid var(--border)}
.ftc-canvas-wrap canvas{max-height:400px}
.ftc-save-btn{padding:9px 20px;border-radius:8px;border:1px solid var(--jungle);background:transparent;color:var(--jungle);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.ftc-save-btn:hover{background:var(--jungle);color:#fff}
.ftc-next-btn{padding:9px 20px;border-radius:8px;border:none;background:var(--torch);color:#fff;font-size:13px;font-weight:600;cursor:pointer;transition:background .2s;font-family:inherit}
.ftc-next-btn:hover{background:#c0551a}
/* Jury question cards */
.ftc-jury-card{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:14px;transition:border-color .2s}
.ftc-jury-card.solved{border:2px solid var(--jungle);background:#f0faf2}
.ftc-jury-juror{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.ftc-juror-avatar{font-size:28px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:#1a1612;border-radius:50%;border:2px solid #4a4038}
.ftc-juror-name{font-size:13px;font-weight:700;color:var(--dark)}
.ftc-juror-role{font-size:10px;color:var(--gray);letter-spacing:.5px}
.ftc-jury-q{font-size:14px;color:#3a3228;line-height:1.7;margin-bottom:12px;font-style:italic}
.ftc-jury-hint{font-size:12px;color:#8a7060;background:#fdf5e0;padding:7px 11px;border-radius:6px;border-left:3px solid #e0c97a;margin-bottom:10px}
.ftc-jury-feedback{margin-top:8px;padding:9px 13px;border-radius:7px;font-size:13px}
.ftc-jury-feedback.correct{background:#eaf5ec;border-left:3px solid var(--jungle);color:#1a5a2a}
.ftc-jury-feedback.incorrect{background:#fef0ee;border-left:3px solid #c0392b;color:#7a1a1a}
/* Winner card */
.ftc-winner-card{background:linear-gradient(135deg,#1a1612,#2a1808);border:2px solid var(--torch);border-radius:16px;padding:36px;text-align:center;margin-top:20px;box-shadow:0 0 40px rgba(212,97,30,.2)}
.ftc-winner-flames{font-size:36px;margin-bottom:16px;animation:flicker 1.5s ease-in-out infinite alternate}
.ftc-winner-label{font-size:10px;font-weight:700;color:var(--torch);letter-spacing:3px;margin-bottom:8px}
.ftc-winner-name{font-size:28px;font-weight:700;color:#e8dfd4;margin-bottom:14px;font-family:'Survivant',Georgia,serif}
.ftc-winner-msg{font-size:14px;color:#8a7e70;line-height:1.7;max-width:480px;margin:0 auto}

/* Query history */
.pg-history-section{margin-top:20px;border:1px solid #3a3228;border-radius:12px;overflow:hidden}
.pg-history-toggle{width:100%;background:#1a1612;border:none;padding:11px 16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;text-align:left}
.pg-history-toggle:hover{background:#2a2218}
.pg-history-label{font-size:10px;font-weight:700;color:var(--torch);letter-spacing:1.5px}
.pg-history-caret{font-size:12px;color:#6a6258;transition:transform .2s}
.pg-history-caret.open{transform:rotate(180deg)}
.pg-history-body{display:none;max-height:340px;overflow-y:auto;background:#1a1612}
.pg-history-body.open{display:block}
.pg-history-empty{padding:24px;text-align:center;color:#5a5248;font-size:13px}
.pg-history-item{padding:11px 16px;border-top:1px solid #2a2218;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:start;cursor:pointer;transition:background .15s;background:#1a1612}
.pg-history-item:hover{background:#2a2218}
.pg-history-item:first-child{border-top:none}
.pg-history-time{font-size:10px;color:#6a6258;font-family:'JetBrains Mono',monospace;white-space:nowrap;padding-top:2px}
.pg-history-summary{font-size:13px;color:#c4b8a8;line-height:1.4}
.pg-history-sql{font-size:10px;color:#6a6258;font-family:'JetBrains Mono',monospace;margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:500px}
.pg-history-meta{font-size:10px;color:#6a6258;white-space:nowrap;text-align:right;padding-top:2px}
.pg-history-rerun{font-size:10px;color:var(--torch);font-weight:700;display:block;margin-top:3px}
.pg-history-clear{font-size:11px;color:#6a6258;background:#2a2218;border:1px solid #4a4038;border-radius:5px;padding:6px 16px;cursor:pointer;margin:0 12px}
.pg-history-clear:hover{color:#e87878;border-color:#c0392b;background:#2a1a1a}
</style>
</head>
<body>
<!-- Flickering background torches -->
<div id="bg-torches" aria-hidden="true">
  <div class="bt-wrap" style="left:1.5%;--dur:1.9s"><div class="bt-flames"><div class="bt-glow"></div><div class="bt-f bt-f1"></div><div class="bt-f bt-f2"></div><div class="bt-f bt-f3"></div></div><div class="bt-head"></div><div class="bt-pole" style="height:200px"></div></div>
  <div class="bt-wrap" style="left:9%;--dur:2.3s"><div class="bt-flames"><div class="bt-glow"></div><div class="bt-f bt-f1"></div><div class="bt-f bt-f2"></div><div class="bt-f bt-f3"></div></div><div class="bt-head"></div><div class="bt-pole" style="height:130px"></div></div>
  <div class="bt-wrap" style="left:18%;--dur:1.7s"><div class="bt-flames"><div class="bt-glow"></div><div class="bt-f bt-f1"></div><div class="bt-f bt-f2"></div><div class="bt-f bt-f3"></div></div><div class="bt-head"></div><div class="bt-pole" style="height:80px"></div></div>
  <div class="bt-wrap" style="left:50%;transform:translateX(-50%);--dur:2.0s"><div class="bt-flames"><div class="bt-glow"></div><div class="bt-f bt-f1"></div><div class="bt-f bt-f2"></div><div class="bt-f bt-f3"></div></div><div class="bt-head"></div><div class="bt-pole" style="height:60px"></div></div>
  <div class="bt-wrap" style="right:18%;--dur:1.6s"><div class="bt-flames"><div class="bt-glow"></div><div class="bt-f bt-f1"></div><div class="bt-f bt-f2"></div><div class="bt-f bt-f3"></div></div><div class="bt-head"></div><div class="bt-pole" style="height:90px"></div></div>
  <div class="bt-wrap" style="right:9%;--dur:2.5s"><div class="bt-flames"><div class="bt-glow"></div><div class="bt-f bt-f1"></div><div class="bt-f bt-f2"></div><div class="bt-f bt-f3"></div></div><div class="bt-head"></div><div class="bt-pole" style="height:150px"></div></div>
  <div class="bt-wrap" style="right:1.5%;--dur:1.8s"><div class="bt-flames"><div class="bt-glow"></div><div class="bt-f bt-f1"></div><div class="bt-f bt-f2"></div><div class="bt-f bt-f3"></div></div><div class="bt-head"></div><div class="bt-pole" style="height:210px"></div></div>
</div>
<header>
  <div class="header-inner">
    <div><div class="header-label mono">Learn SQL with</div><div class="header-title" style="font-family:'Survivant',Georgia,serif">SURVIVOR</div></div>
    <div style="text-align:right"><div class="mono" style="font-size:10px;color:#6a6258;margin-bottom:4px">OVERALL PROGRESS</div>
      <div class="progress-bar" style="width:180px"><div class="progress-track"><div class="progress-fill" id="globalFill" style="width:0%"></div></div><span class="progress-count mono" id="globalCount">0/0</span></div>
    </div>
  </div>
  <div class="torch-tracker" id="torchTracker"></div>
</header>
<nav>
  <div class="nav-inner">
    <button class="nav-btn mono active" data-tab="lessons" onclick="switchTab('lessons')">Lessons</button>
    <button class="nav-btn mono" data-tab="tables" onclick="switchTab('tables')">Database Tables</button>
    <button class="nav-btn mono" data-tab="cheatsheet" onclick="switchTab('cheatsheet')">Cheat Sheet</button>
    <button class="nav-btn mono" data-tab="playground" onclick="switchTab('playground')">Query Playground</button>
    <button class="nav-btn mono" data-tab="finale" onclick="switchTab('finale')" style="color:#d4611e;border-bottom-color:transparent">üî• Final Tribal Council</button>
    <div style="flex:1"></div>
    <button class="api-gear" onclick="toggleApiBar()" title="AI Tutor Settings">‚öôÔ∏è</button>
  </div>
</nav>
<div class="api-bar hidden" id="apiBar">
  <div class="api-bar-inner">
    <label class="mono">ANTHROPIC API KEY</label>
    <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
    <button class="api-save mono" onclick="saveApiKey()">Save</button>
    <span class="api-status mono" id="apiStatus"></span>
    <span style="font-size:10px;color:#6a6258;margin-left:6px">Stored locally. Only sent to Anthropic API.</span>
  </div>
</div>
<main>
  <div id="tab-lessons"><div id="module-grid-view"><h2>Your Learning Path</h2><p class="subtitle" id="subtitleText"></p><div class="module-grid" id="moduleGrid"></div></div><div id="module-detail-view" class="hidden"></div></div>
  <div id="tab-tables" class="hidden"><h2>Your Database Tables</h2><p class="subtitle">Each table is like a spreadsheet tab. Hover üìã tags on scenarios to see columns.</p><div id="tablesContainer"></div></div>
  <div id="tab-cheatsheet" class="hidden"><h2>SQL Quick Reference</h2><p class="subtitle">Keep this handy as you work through the lessons.</p><div id="cheatContainer"></div></div>
  <div id="tab-playground" class="hidden">
    <h2>Query Playground</h2>
    <p class="subtitle">Run any SQL query against real Survivor data. The database loads once in your browser ‚Äî no server needed.</p>
    <div id="pg-loading-overlay" class="pg-loading-overlay">
      <div><span class="pg-spinner">üî•</span></div>
      <div style="font-size:14px;color:#8a7e70;margin-bottom:4px">Loading Survivor database...</div>
      <div style="font-size:12px;color:#6a6258" id="pg-loading-msg">Fetching survivor.db</div>
      <div class="pg-loading-bar-track"><div class="pg-loading-bar-fill" id="pg-loading-bar"></div></div>
    </div>
    <div id="pg-main" class="hidden">
      <div class="pg-layout">
        <div class="pg-editor-panel">
          <div class="pg-editor-header">
            <span class="pg-editor-label mono">SQL EDITOR</span>
            <div style="display:flex;gap:8px">
              <button class="pg-clear-btn mono" onclick="pgClear()">Clear</button>
              <button class="pg-run-btn mono" id="pg-run-btn" onclick="pgRun()">Run Query ‚ñ∂</button>
            </div>
          </div>
          <textarea class="pg-textarea mono" id="pg-editor" placeholder="-- Write any SQL here&#10;-- Example:&#10;SELECT season_name, winner FROM season_summary LIMIT 10;" spellcheck="false" onkeydown="pgHandleKey(event)"></textarea>
          <div class="pg-meta-row">
            <div style="display:flex;align-items:center">
              <span class="pg-status-dot ready" id="pg-status-dot"></span>
              <span class="pg-meta-item" id="pg-status-text">Database ready</span>
            </div>
            <span class="pg-meta-item" id="pg-rows-meta" style="display:none">Rows: <span id="pg-row-count">0</span></span>
            <span class="pg-meta-item" id="pg-time-meta" style="display:none">Time: <span id="pg-exec-time">0ms</span></span>
          </div>
        </div>
        <div class="pg-table-list">
          <div class="pg-table-list-label mono">TABLES ‚Äî click for details</div>
          <div id="pg-table-chips"></div>
        </div>
        <div class="pg-results-panel">
          <div class="pg-results-header">
            <span class="pg-results-label mono">RESULTS</span>
            <span class="pg-results-count mono" id="pg-results-count" style="display:none"></span>
            <span class="pg-results-time mono" id="pg-results-time" style="display:none"></span>
          </div>
          <div id="pg-results-body">
            <div class="pg-placeholder">Run a query to see results here. Try: <code>SELECT season_name, winner FROM season_summary LIMIT 10;</code></div>
          </div>
        </div>
        <div class="pg-history-section">
          <button class="pg-history-toggle" onclick="pgToggleHistory()">
            <span class="pg-history-label mono">‚ñ∏ QUERY HISTORY</span>
            <span class="pg-history-caret" id="pg-history-caret">‚ñæ</span>
          </button>
          <div class="pg-history-body" id="pg-history-body">
            <div class="pg-history-empty" id="pg-history-empty">No queries run yet. Run your first query above!</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Final Tribal Council Tab -->
  <div id="tab-finale" class="hidden">
    <div class="ftc-hero">
      <div class="ftc-torches" aria-hidden="true">üî•&nbsp;&nbsp;&nbsp;üî•&nbsp;&nbsp;&nbsp;üî•</div>
      <h2 class="ftc-title" style="font-family:'Survivant',Georgia,serif">Final Tribal Council</h2>
      <p class="ftc-subtitle">You've made it to the end. Now prove you deserve the million.<br>Write real SQL. Build real charts. Make your case to the jury.</p>
    </div>

    <!-- Progress ribbon -->
    <div class="ftc-ribbon" id="ftc-ribbon">
      <div class="ftc-ribbon-item" id="ftc-step-1"><span class="ftc-step-num">1</span><span class="ftc-step-label">Opening Statement</span></div>
      <div class="ftc-ribbon-arrow">‚Ä∫</div>
      <div class="ftc-ribbon-item" id="ftc-step-2"><span class="ftc-step-num">2</span><span class="ftc-step-label">Jury Questions</span></div>
      <div class="ftc-ribbon-arrow">‚Ä∫</div>
      <div class="ftc-ribbon-item" id="ftc-step-3"><span class="ftc-step-num">3</span><span class="ftc-step-label">The Vote</span></div>
      <div class="ftc-ribbon-arrow">‚Ä∫</div>
      <div class="ftc-ribbon-item" id="ftc-step-4"><span class="ftc-step-num">4</span><span class="ftc-step-label">Reading the Votes</span></div>
    </div>

    <div id="ftc-loading" class="ftc-loading-msg hidden">
      <span style="font-size:28px;animation:spin 2s linear infinite;display:inline-block">üî•</span>
      <span style="margin-left:10px;color:#8a7e70;font-size:14px">Loading Survivor database...</span>
    </div>

    <!-- PHASE 1: Opening Statement -->
    <div class="ftc-phase" id="ftc-phase-1">
      <div class="ftc-phase-header">
        <span class="ftc-phase-badge mono">PHASE 1</span>
        <h3 class="ftc-phase-title">Opening Statement</h3>
        <p class="ftc-phase-desc">Before the jury asks their questions, you give your opening argument. Choose a Survivor story to investigate, write your first SQL query, and visualize the result.</p>
      </div>
      <div class="ftc-challenge-card">
        <div class="ftc-challenge-label mono">YOUR OPENING ARGUMENT</div>
        <p class="ftc-challenge-text">Choose a story from Survivor history to tell with data. Write a SQL query that sets up your argument ‚Äî who dominated? What era peaked? Which tribe crushed it?</p>
        <div class="ftc-prompt-chips">
          <button class="ftc-prompt-chip" onclick="ftcLoadPrompt(1,'SELECT season, season_name, winner, n_cast\nFROM season_summary\nORDER BY season;')">üèÜ Season Overview</button>
          <button class="ftc-prompt-chip" onclick="ftcLoadPrompt(1,'SELECT castaway, COUNT(*) AS seasons_played\nFROM castaways\nGROUP BY castaway\nHAVING COUNT(*) > 1\nORDER BY seasons_played DESC\nLIMIT 15;')">üîÅ Return Players</button>
          <button class="ftc-prompt-chip" onclick="ftcLoadPrompt(1,'SELECT season, AVG(imdb_rating) AS avg_rating\nFROM episodes\nGROUP BY season\nORDER BY avg_rating DESC\nLIMIT 10;')">‚≠ê Best Seasons</button>
          <button class="ftc-prompt-chip" onclick="ftcLoadPrompt(1,'SELECT season, episode_title, viewers\nFROM episodes\nORDER BY viewers DESC\nLIMIT 10;')">üì∫ Most Watched</button>
        </div>
        <div class="ftc-editor-wrap">
          <div class="ftc-editor-hdr">
            <span class="ftc-editor-label mono">YOUR SQL</span>
            <div style="display:flex;gap:6px">
              <button class="ftc-clear-btn mono" onclick="ftcClear(1)">Clear</button>
              <button class="ftc-run-btn mono" id="ftc-run-1" onclick="ftcRun(1)">‚ñ∂ Run Query</button>
            </div>
          </div>
          <textarea class="ftc-editor mono" id="ftc-editor-1" spellcheck="false" placeholder="-- Write your opening SQL statement here..."></textarea>
        </div>
        <div class="ftc-results-area hidden" id="ftc-results-1"></div>
        <div class="ftc-chart-area hidden" id="ftc-chart-area-1">
          <div class="ftc-chart-controls">
            <span class="ftc-editor-label mono">CHART TYPE</span>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
              <button class="ftc-chart-type-btn active" data-phase="1" data-type="bar" onclick="ftcSetChartType(1,'bar',this)">üìä Bar</button>
              <button class="ftc-chart-type-btn" data-phase="1" data-type="line" onclick="ftcSetChartType(1,'line',this)">üìà Line</button>
              <button class="ftc-chart-type-btn" data-phase="1" data-type="horizontalBar" onclick="ftcSetChartType(1,'horizontalBar',this)">‚Üî Horizontal Bar</button>
              <button class="ftc-chart-type-btn" data-phase="1" data-type="doughnut" onclick="ftcSetChartType(1,'doughnut',this)">üç© Doughnut</button>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <span class="ftc-editor-label mono">X AXIS</span>
              <select class="ftc-col-select" id="ftc-xcol-1" onchange="ftcRenderChart(1)"></select>
              <span class="ftc-editor-label mono">Y AXIS</span>
              <select class="ftc-col-select" id="ftc-ycol-1" onchange="ftcRenderChart(1)"></select>
              <span class="ftc-editor-label mono">CHART TITLE</span>
              <input class="ftc-title-input" id="ftc-chart-title-1" type="text" placeholder="My Survivor Chart" oninput="ftcRenderChart(1)">
            </div>
          </div>
          <div class="ftc-canvas-wrap"><canvas id="ftc-canvas-1"></canvas></div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="ftc-save-btn" onclick="ftcSaveChart(1)">üíæ Save Chart as PNG</button>
            <button class="ftc-next-btn" onclick="ftcAdvance(2)">Continue to Jury Questions ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PHASE 2: Jury Questions -->
    <div class="ftc-phase hidden" id="ftc-phase-2">
      <div class="ftc-phase-header">
        <span class="ftc-phase-badge mono">PHASE 2</span>
        <h3 class="ftc-phase-title">Jury Questions</h3>
        <p class="ftc-phase-desc">The jury grills you. Each question demands a specific SQL technique. Answer all three to move on.</p>
      </div>
      <div id="ftc-jury-questions"></div>
      <div style="margin-top:16px" id="ftc-jury-advance" class="hidden">
        <button class="ftc-next-btn" onclick="ftcAdvance(3)">All questions answered ‚Äî Cast Your Vote ‚Üí</button>
      </div>
    </div>

    <!-- PHASE 3: The Vote ‚Äî Free-form final chart -->
    <div class="ftc-phase hidden" id="ftc-phase-3">
      <div class="ftc-phase-header">
        <span class="ftc-phase-badge mono">PHASE 3</span>
        <h3 class="ftc-phase-title">The Vote</h3>
        <p class="ftc-phase-desc">This is your closing argument. Write any SQL query you want, build a chart that tells a compelling story about Survivor data, and save it. This is your vote for who deserves the million.</p>
      </div>
      <div class="ftc-challenge-card">
        <div class="ftc-challenge-label mono">YOUR FINAL ARGUMENT ‚Äî FREE CHOICE</div>
        <p class="ftc-challenge-text">What's the most interesting thing you can find in this data? Go complex ‚Äî use CTEs, JOINs, window functions, whatever you've learned. Then turn it into a chart worthy of a finale.</p>
        <div class="ftc-editor-wrap">
          <div class="ftc-editor-hdr">
            <span class="ftc-editor-label mono">YOUR SQL</span>
            <div style="display:flex;gap:6px">
              <button class="ftc-clear-btn mono" onclick="ftcClear(3)">Clear</button>
              <button class="ftc-run-btn mono" id="ftc-run-3" onclick="ftcRun(3)">‚ñ∂ Run Query</button>
            </div>
          </div>
          <textarea class="ftc-editor mono" id="ftc-editor-3" spellcheck="false" placeholder="-- Your final, most impressive query...&#10;-- Use CTEs, JOINs, window functions ‚Äî show everything you've learned."></textarea>
        </div>
        <div class="ftc-results-area hidden" id="ftc-results-3"></div>
        <div class="ftc-chart-area hidden" id="ftc-chart-area-3">
          <div class="ftc-chart-controls">
            <span class="ftc-editor-label mono">CHART TYPE</span>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
              <button class="ftc-chart-type-btn active" data-phase="3" data-type="bar" onclick="ftcSetChartType(3,'bar',this)">üìä Bar</button>
              <button class="ftc-chart-type-btn" data-phase="3" data-type="line" onclick="ftcSetChartType(3,'line',this)">üìà Line</button>
              <button class="ftc-chart-type-btn" data-phase="3" data-type="horizontalBar" onclick="ftcSetChartType(3,'horizontalBar',this)">‚Üî Horizontal Bar</button>
              <button class="ftc-chart-type-btn" data-phase="3" data-type="doughnut" onclick="ftcSetChartType(3,'doughnut',this)">üç© Doughnut</button>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <span class="ftc-editor-label mono">X AXIS</span>
              <select class="ftc-col-select" id="ftc-xcol-3" onchange="ftcRenderChart(3)"></select>
              <span class="ftc-editor-label mono">Y AXIS</span>
              <select class="ftc-col-select" id="ftc-ycol-3" onchange="ftcRenderChart(3)"></select>
              <span class="ftc-editor-label mono">CHART TITLE</span>
              <input class="ftc-title-input" id="ftc-chart-title-3" type="text" placeholder="My Final Argument" oninput="ftcRenderChart(3)">
            </div>
          </div>
          <div class="ftc-canvas-wrap"><canvas id="ftc-canvas-3"></canvas></div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="ftc-save-btn" onclick="ftcSaveChart(3)">üíæ Save Chart as PNG</button>
            <button class="ftc-next-btn" onclick="ftcAdvance(4)">Read the Votes ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PHASE 4: Reading the Votes -->
    <div class="ftc-phase hidden" id="ftc-phase-4">
      <div class="ftc-phase-header" style="text-align:center">
        <div style="font-size:52px;margin-bottom:12px">üî•</div>
        <span class="ftc-phase-badge mono">PHASE 4</span>
        <h3 class="ftc-phase-title" style="font-family:'Survivant',Georgia,serif;font-size:32px">The Tribe Has Spoken.</h3>
        <p class="ftc-phase-desc" style="max-width:560px;margin:0 auto">You've made it through Final Tribal Council. You wrote real SQL. You built real charts. You told a story with data.<br><br>That's the whole game.</p>
      </div>
      <div class="ftc-winner-card">
        <div class="ftc-winner-flames">üî•üî•üî•</div>
        <div class="ftc-winner-label mono">SOLE SURVIVOR</div>
        <div class="ftc-winner-name" id="ftc-winner-name"></div>
        <p class="ftc-winner-msg">You completed all capstone challenges and proved your SQL skills in front of the jury. The million dollar check is in the mail.</p>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:20px">
          <button class="ftc-save-btn" onclick="ftcSaveChart(1)">üíæ Save Opening Chart</button>
          <button class="ftc-save-btn" onclick="ftcSaveChart(3)">üíæ Save Final Chart</button>
          <button class="ftc-next-btn" onclick="switchTab('lessons')">‚Üê Back to Lessons</button>
        </div>
      </div>
    </div>

  </div>
  <!-- Table detail modal -->
  <div id="pg-modal-overlay" class="pg-modal-overlay" onclick="if(event.target===this)pgCloseModal()">
    <div class="pg-modal-box">
      <div class="pg-modal-header">
        <div>
          <div class="pg-modal-title" id="pg-modal-title"></div>
          <div class="pg-modal-subtitle" id="pg-modal-subtitle"></div>
        </div>
        <button class="pg-modal-close" onclick="pgCloseModal()">‚úï</button>
      </div>
      <div class="pg-modal-body" id="pg-modal-body"></div>
    </div>
  </div>
</main>
<footer>
  <div style="margin-bottom:10px">
    <a href="/" style="display:inline-flex;align-items:center;gap:7px;padding:7px 16px;border-radius:7px;background:#1a1612;border:1px solid #3a3228;color:#c4b8a8;font-size:12px;font-weight:700;text-decoration:none;letter-spacing:.5px;transition:border-color .2s,color .2s" onmouseover="this.style.borderColor='#d4611e';this.style.color='#d4611e'" onmouseout="this.style.borderColor='#3a3228';this.style.color='#c4b8a8'">‚Üê cornettlabs.com</a>
  </div>
  <div><span style="color:var(--torch)">üî•</span> The tribe has spoken. Now go write some queries!</div>
  <div style="margin-top:8px;font-size:11px;color:#a09080">Built by <a href="https://www.linkedin.com/in/katiecornett/" target="_blank" rel="noopener" style="color:#c4b8a8;text-decoration:none;border-bottom:1px solid #5a5248;transition:color .2s" onmouseover="this.style.color='#d4611e'" onmouseout="this.style.color='#c4b8a8'">Katie Cornett</a>, the SQL Sole Survivor.</div>
</footer>
<div id="modalContainer"></div>

<script>
// ===== DATA =====
const ICONS = ['üî•','üèùÔ∏è','üß≠','üó≥Ô∏è','üì¶','üîó','ü™Ü','üåä','üéØ','üèÜ','ü™£','üïØÔ∏è','üó∫Ô∏è','üé¨','üî¨','üì¢','‚õµ','üß©'];
const MOD_ICONS_DESC = ['The Torch','Island Life','Navigation','Tribal Council','Supply Crate','The Alliance','Hidden Idol','Ocean Challenge','Target Practice','The Crown','The Funnel','Snuffed Torch','The War Map','Director\'s Cut','The Lab','The Megaphone','The Vessel','The Puzzle'];
const TABLES_INFO=[
  {name:"season_summary",desc:"One row per season",rows:"76",cols:"season, season_name, winner, location, n_cast, country, winner_id, n_tribes, n_finalists, n_jury, runner_ups, final_vote"},
  {name:"castaways",desc:"One row per castaway per season",rows:"1,418",cols:"castaway, castaway_id, season, age, city, state, result, place, original_tribe, jury, finalist, winner"},
  {name:"castaway_details",desc:"Biographical info per unique player",rows:"1,181",cols:"castaway_id, full_name, gender, personality_type, date_of_birth"},
  {name:"episodes",desc:"Every episode ever aired",rows:"1,197",cols:"season, episode, episode_title, episode_date, episode_length, viewers, imdb_rating, n_ratings"},
  {name:"vote_history",desc:"Every tribal council vote",rows:"9,376",cols:"season, episode, castaway, vote, voted_out, nullified, tie, tribe, tribe_status, castaway_id, vote_id"},
  {name:"jury_votes",desc:"Final tribal council votes",rows:"1,602",cols:"season, castaway, finalist, vote, castaway_id, finalist_id"},
  {name:"confessionals",desc:"Confessional counts per episode",rows:"13,560",cols:"season, episode, castaway, castaway_id, confessional_count, confessional_time"},
  {name:"challenge_results",desc:"Every challenge result",rows:"21,349",cols:"season, episode, castaway, challenge_type, result, tribe, outcome_type"},
  {name:"tribe_mapping",desc:"Tribe assignments per episode",rows:"14,976",cols:"season, episode, castaway, tribe, tribe_status, castaway_id"},
];

const MODULES=[
{id:1,title:"SELECT ‚Äî Your First Query",
 intro:"You're about to learn the most fundamental SQL command. SELECT is the foundation of every query ‚Äî it's how you tell the database exactly what you want to see.",
 concept:{text:"SELECT lets you choose which columns to see. FROM tells SQL which table to look in.",code:"SELECT column1, column2\nFROM table_name;",tip:"Use SELECT * to grab all columns ‚Äî handy for exploring, but avoid in production."},
 scenarios:[
  {id:"1.1",title:"Explore the Data",question:"Write a query to see everything in the season_summary table.",hint:'SELECT * means "give me all columns."',answer:"SELECT *\nFROM season_summary;",tables:["season_summary"],keywords:["SELECT","*","FROM","season_summary"]},
  {id:"1.2",title:"Pick Your Columns",question:"Show every season's name, location, and winner from season_summary.",hint:"List column names after SELECT, separated by commas.",answer:"SELECT season_name, location, winner\nFROM season_summary;",tables:["season_summary"],keywords:["SELECT","season_name","location","winner","FROM","season_summary"]},
  {id:"1.3",title:"Castaway Roster",question:"Show each castaway's name, city, and placement from the castaways table.",hint:"The columns are castaway, city, and place.",answer:"SELECT castaway, city, place\nFROM castaways;",tables:["castaways"],keywords:["SELECT","castaway","city","place","FROM","castaways"]},
 ],
 bonus:[
  {id:"1.B1",title:"Full Player Details",question:"Show the full_name, gender, and personality_type from castaway_details.",hint:"Same pattern: SELECT columns FROM table.",answer:"SELECT full_name, gender, personality_type\nFROM castaway_details;",tables:["castaway_details"],keywords:["SELECT","full_name","gender","personality_type","FROM","castaway_details"]},
  {id:"1.B2",title:"Episode Titles",question:"Show every episode's season, title, and IMDB rating from the episodes table.",hint:"The columns are season, episode_title, and imdb_rating.",answer:"SELECT season, episode_title, imdb_rating\nFROM episodes;",tables:["episodes"],keywords:["SELECT","season","episode_title","imdb_rating","FROM","episodes"]},
 ]},
{id:2,title:"WHERE ‚Äî Filtering Results",
 intro:"Now you'll learn to filter. WHERE is your scalpel ‚Äî it lets you slice through thousands of rows to find exactly what you're looking for.",
 concept:{text:"WHERE filters rows based on conditions. Use =, !=, <, >, and combine with AND / OR.",code:"SELECT columns\nFROM table\nWHERE condition;",tip:"Text values need single quotes: WHERE country = 'Fiji'"},
 scenarios:[
  {id:"2.1",title:"Fiji Seasons",question:"Find the season name and location for all seasons filmed in Fiji.",hint:"WHERE country = 'Fiji'. Text needs quotes.",answer:"SELECT season_name, location\nFROM season_summary\nWHERE country = 'Fiji';",tables:["season_summary"],keywords:["SELECT","FROM","season_summary","WHERE","country","=","Fiji"]},
  {id:"2.2",title:"Sole Survivors",question:"Find all castaways who won (result = 'Sole Survivor'). Show name, season, city.",hint:"WHERE result = 'Sole Survivor'",answer:"SELECT castaway, season, city\nFROM castaways\nWHERE result = 'Sole Survivor';",tables:["castaways"],keywords:["SELECT","FROM","castaways","WHERE","result","=","Sole Survivor"]},
  {id:"2.3",title:"Top-Rated Episodes",question:"Find season 47 episodes with IMDB rating above 7.5. Show title and rating.",hint:"Two conditions ‚Äî connect with AND.",answer:"SELECT episode_title, imdb_rating\nFROM episodes\nWHERE season = 47\n  AND imdb_rating > 7.5;",tables:["episodes"],keywords:["SELECT","FROM","episodes","WHERE","season","47","AND","imdb_rating",">","7.5"]},
  {id:"2.4",title:"Chaos at Tribal",question:"Find season 49 votes that were nullified OR were ties.",hint:"Use OR. Wrap OR conditions in parentheses.",answer:"SELECT castaway, vote, nullified, tie\nFROM vote_history\nWHERE season = 49\n  AND (nullified = 1 OR tie = 1);",tables:["vote_history"],keywords:["SELECT","FROM","vote_history","WHERE","season","49","AND","OR","nullified","tie"]},
 ],
 bonus:[
  {id:"2.B1",title:"Big Casts Only",question:"Find seasons with more than 18 cast members. Show name and cast size.",hint:"WHERE n_cast > 18",answer:"SELECT season_name, n_cast\nFROM season_summary\nWHERE n_cast > 18;",tables:["season_summary"],keywords:["SELECT","FROM","season_summary","WHERE","n_cast",">","18"]},
  {id:"2.B2",title:"INTJ Players",question:"Find all INTJ personality type players. Show their full name.",hint:"WHERE personality_type = 'INTJ'",answer:"SELECT full_name, personality_type\nFROM castaway_details\nWHERE personality_type = 'INTJ';",tables:["castaway_details"],keywords:["SELECT","FROM","castaway_details","WHERE","personality_type","=","INTJ"]},
 ]},
{id:3,title:"ORDER BY & LIMIT",
 intro:"Time to sort and rank! These are the commands that answer every 'top 10' and 'best of' question.",
 concept:{text:"ORDER BY sorts results. DESC = highest first. LIMIT caps rows returned.",code:"SELECT columns\nFROM table\nORDER BY column DESC\nLIMIT 10;",tip:"ORDER BY after WHERE, LIMIT last."},
 scenarios:[
  {id:"3.1",title:"Best Episodes",question:"10 highest-rated episodes. Show season, title, IMDB rating.",hint:"ORDER BY imdb_rating DESC LIMIT 10.",answer:"SELECT season, episode_title, imdb_rating\nFROM episodes\nORDER BY imdb_rating DESC\nLIMIT 10;",tables:["episodes"],keywords:["SELECT","FROM","episodes","ORDER BY","imdb_rating","DESC","LIMIT","10"]},
  {id:"3.2",title:"Biggest Casts",question:"Which 5 seasons had the largest cast? Show name and count.",hint:"ORDER BY n_cast DESC LIMIT 5.",answer:"SELECT season_name, n_cast\nFROM season_summary\nORDER BY n_cast DESC\nLIMIT 5;",tables:["season_summary"],keywords:["SELECT","FROM","season_summary","ORDER BY","n_cast","DESC","LIMIT","5"]},
  {id:"3.3",title:"Most-Watched",question:"10 most-watched episodes. Show season, title, viewers.",hint:"ORDER BY viewers DESC.",answer:"SELECT season, episode_title, viewers\nFROM episodes\nORDER BY viewers DESC\nLIMIT 10;",tables:["episodes"],keywords:["SELECT","FROM","episodes","ORDER BY","viewers","DESC","LIMIT","10"]},
 ],
 bonus:[
  {id:"3.B1",title:"Lowest Rated",question:"Find the 5 lowest-rated episodes (ASC). Show season and title.",hint:"ORDER BY imdb_rating ASC (or just omit DESC).",answer:"SELECT season, episode_title, imdb_rating\nFROM episodes\nORDER BY imdb_rating ASC\nLIMIT 5;",tables:["episodes"],keywords:["SELECT","FROM","episodes","ORDER BY","imdb_rating","ASC","LIMIT","5"]},
 ]},
{id:4,title:"Aggregate Functions",
 intro:"Get ready to crunch numbers! Aggregates let you count, sum, and average across entire tables.",
 concept:{text:"COUNT() counts, SUM() adds, AVG() averages, MIN()/MAX() find extremes.",code:"SELECT COUNT(*) AS total\nFROM table_name;",tip:"AS creates a readable alias for calculated columns."},
 scenarios:[
  {id:"4.1",title:"Total Votes",question:"How many total votes across all tribal councils?",hint:"COUNT(*) on vote_history.",answer:"SELECT COUNT(*) AS total_votes\nFROM vote_history;",tables:["vote_history"],keywords:["SELECT","COUNT","AS","FROM","vote_history"]},
  {id:"4.2",title:"Average Rating",question:"Average IMDB rating across all episodes?",hint:"AVG(imdb_rating).",answer:"SELECT AVG(imdb_rating) AS avg_rating\nFROM episodes;",tables:["episodes"],keywords:["SELECT","AVG","imdb_rating","AS","FROM","episodes"]},
  {id:"4.3",title:"Peak & Valley",question:"Highest and lowest viewership for any single episode?",hint:"MAX() and MIN() in same SELECT.",answer:"SELECT MAX(viewers) AS peak_viewers,\n  MIN(viewers) AS lowest_viewers\nFROM episodes;",tables:["episodes"],keywords:["SELECT","MAX","MIN","viewers","AS","FROM","episodes"]},
 ],
 bonus:[
  {id:"4.B1",title:"Total Confessionals",question:"What's the total number of confessionals across all seasons? (SUM confessional_count)",hint:"SUM(confessional_count) from confessionals.",answer:"SELECT SUM(confessional_count) AS total_confessionals\nFROM confessionals;",tables:["confessionals"],keywords:["SELECT","SUM","confessional_count","AS","FROM","confessionals"]},
 ]},
{id:5,title:"GROUP BY ‚Äî Summarize",
 intro:"This is where SQL gets really powerful. GROUP BY lets you summarize data by category ‚Äî like building a pivot table with one line.",
 concept:{text:"GROUP BY splits data into groups. HAVING filters groups after aggregation.",code:"SELECT category, COUNT(*)\nFROM table\nGROUP BY category\nHAVING COUNT(*) > 5;",tip:"If it's in SELECT but not aggregated, it must be in GROUP BY."},
 scenarios:[
  {id:"5.1",title:"Episodes Per Season",question:"Episode count per season, sorted by season.",hint:"GROUP BY season, COUNT(*).",answer:"SELECT season, COUNT(*) AS episode_count\nFROM episodes\nGROUP BY season\nORDER BY season;",tables:["episodes"],keywords:["SELECT","COUNT","AS","FROM","episodes","GROUP BY","season","ORDER BY"]},
  {id:"5.2",title:"Confessional Kings",question:"Top 5 castaways by total confessionals in season 49.",hint:"SUM, GROUP BY castaway, ORDER, LIMIT.",answer:"SELECT castaway,\n  SUM(confessional_count) AS total_confessionals\nFROM confessionals\nWHERE season = 49\nGROUP BY castaway\nORDER BY total_confessionals DESC\nLIMIT 5;",tables:["confessionals"],keywords:["SELECT","SUM","confessional_count","AS","FROM","confessionals","WHERE","season","49","GROUP BY","castaway","ORDER BY","DESC","LIMIT","5"]},
  {id:"5.3",title:"Elite Seasons",question:"Seasons with average IMDB above 7.0. Show season and avg rating.",hint:"Use HAVING, not WHERE, for aggregates.",answer:"SELECT season, AVG(imdb_rating) AS avg_rating\nFROM episodes\nGROUP BY season\nHAVING AVG(imdb_rating) > 7.0\nORDER BY avg_rating DESC;",tables:["episodes"],keywords:["SELECT","AVG","imdb_rating","AS","FROM","episodes","GROUP BY","season","HAVING","ORDER BY","DESC"]},
  {id:"5.4",title:"Returning Players",question:"Find players who appeared more than once. Show name and count.",hint:"HAVING COUNT(*) > 1.",answer:"SELECT castaway, COUNT(*) AS times_played\nFROM castaways\nGROUP BY castaway\nHAVING COUNT(*) > 1\nORDER BY times_played DESC;",tables:["castaways"],keywords:["SELECT","COUNT","AS","FROM","castaways","GROUP BY","castaway","HAVING","ORDER BY","DESC"]},
 ],
 bonus:[
  {id:"5.B1",title:"Votes Per Tribal",question:"Average number of votes cast per episode across all seasons.",hint:"COUNT votes GROUP BY season and episode, then AVG that.",answer:"SELECT AVG(vote_count) AS avg_votes_per_tribal\nFROM (\n  SELECT season, episode, COUNT(*) AS vote_count\n  FROM vote_history\n  GROUP BY season, episode\n);",tables:["vote_history"],keywords:["SELECT","AVG","COUNT","AS","FROM","vote_history","GROUP BY","season","episode"]},
 ]},
{id:6,title:"JOIN ‚Äî Combining Tables",
 intro:"Up to now you've worked with one table at a time. JOIN is how you connect tables together ‚Äî like linking spreadsheet tabs.",
 concept:{text:"INNER JOIN returns matching rows. LEFT JOIN keeps all left rows, NULLs for no match.",code:"SELECT a.col, b.col\nFROM table_a AS a\nINNER JOIN table_b AS b\n  ON a.id = b.id;",tip:"AS creates short aliases for table names."},
 scenarios:[
  {id:"6.1",title:"Player Profiles",question:"Show castaway name, season, gender, and personality type. Join castaways + castaway_details.",hint:"JOIN on castaway_id.",answer:"SELECT c.castaway, c.season, d.gender, d.personality_type\nFROM castaways AS c\nINNER JOIN castaway_details AS d\n  ON c.castaway_id = d.castaway_id;",tables:["castaways","castaway_details"],keywords:["SELECT","FROM","castaways","AS","INNER JOIN","castaway_details","ON","castaway_id"]},
  {id:"6.2",title:"Winner Demographics",question:"Show season name, winner, and winner's gender.",hint:"JOIN season_summary to castaway_details on winner_id.",answer:"SELECT s.season_name, s.winner, d.gender\nFROM season_summary AS s\nINNER JOIN castaway_details AS d\n  ON s.winner_id = d.castaway_id;",tables:["season_summary","castaway_details"],keywords:["SELECT","FROM","season_summary","AS","INNER JOIN","castaway_details","ON","winner_id","castaway_id"]},
  {id:"6.3",title:"Airtime vs Placement",question:"Season 48: each castaway's total confessionals and final placement.",hint:"Join confessionals + castaways on castaway_id AND season.",answer:"SELECT c.castaway, ca.place,\n  SUM(c.confessional_count) AS total_conf\nFROM confessionals AS c\nINNER JOIN castaways AS ca\n  ON c.castaway_id = ca.castaway_id\n  AND c.season = ca.season\nWHERE c.season = 48\nGROUP BY c.castaway, ca.place\nORDER BY ca.place;",tables:["confessionals","castaways"],keywords:["SELECT","SUM","FROM","confessionals","AS","INNER JOIN","castaways","ON","castaway_id","season","WHERE","48","GROUP BY","ORDER BY"]},
 ],
 bonus:[
  {id:"6.B1",title:"Tribe Colors",question:"Show each castaway's name and their original tribe for season 47. Join castaways with tribe_mapping.",hint:"Join on castaway_id and season. Filter tribe_status = 'Original'.",answer:"SELECT c.castaway, t.tribe\nFROM castaways AS c\nINNER JOIN tribe_mapping AS t\n  ON c.castaway_id = t.castaway_id\n  AND c.season = t.season\nWHERE c.season = 47\n  AND t.tribe_status = 'Original';",tables:["castaways","tribe_mapping"],keywords:["SELECT","FROM","castaways","AS","INNER JOIN","tribe_mapping","ON","castaway_id","season","WHERE","47","tribe_status","Original"]},
 ]},
{id:7,title:"Subqueries",
 intro:"Queries inside queries ‚Äî this is where things get creative. Subqueries let you answer complex questions in a single statement.",
 concept:{text:"A subquery runs first, feeding results to the outer query.",code:"SELECT *\nFROM table\nWHERE col = (\n  SELECT MAX(col) FROM table\n);",tip:"Use IN when a subquery returns multiple rows."},
 scenarios:[
  {id:"7.1",title:"Best Episode",question:"Which episode has the highest IMDB rating? Show season, title, rating.",hint:"Subquery for MAX(imdb_rating).",answer:"SELECT season, episode_title, imdb_rating\nFROM episodes\nWHERE imdb_rating = (\n  SELECT MAX(imdb_rating) FROM episodes\n);",tables:["episodes"],keywords:["SELECT","FROM","episodes","WHERE","imdb_rating","=","MAX"]},
  {id:"7.2",title:"Beyond Fiji",question:"Find castaways who played in non-Fiji seasons.",hint:"Subquery finds non-Fiji seasons, outer uses IN.",answer:"SELECT castaway, season\nFROM castaways\nWHERE season IN (\n  SELECT season FROM season_summary\n  WHERE country != 'Fiji'\n);",tables:["castaways","season_summary"],keywords:["SELECT","FROM","castaways","WHERE","season","IN","season_summary","country","Fiji"]},
  {id:"7.3",title:"Confessional Champs",question:"Per season, who got the most confessionals?",hint:"RANK() OVER (PARTITION BY season).",answer:"SELECT season, castaway, total_conf\nFROM (\n  SELECT season, castaway,\n    SUM(confessional_count) AS total_conf,\n    RANK() OVER (PARTITION BY season\n      ORDER BY SUM(confessional_count) DESC) AS rnk\n  FROM confessionals\n  GROUP BY season, castaway\n) ranked\nWHERE rnk = 1\nORDER BY season;",tables:["confessionals"],keywords:["SELECT","FROM","confessionals","SUM","confessional_count","AS","RANK","OVER","PARTITION BY","season","ORDER BY","GROUP BY","WHERE","rnk","1"]},
 ],bonus:[]},
{id:8,title:"Window Functions",
 intro:"The most powerful tool in your SQL belt. Window functions calculate across rows without collapsing them ‚Äî think of it as GROUP BY that keeps all your rows.",
 concept:{text:"RANK(), ROW_NUMBER(), running totals ‚Äî calculated across related rows.",code:"RANK() OVER (\n  PARTITION BY season\n  ORDER BY score DESC\n)",tip:"PARTITION BY creates groups within the window."},
 scenarios:[
  {id:"8.1",title:"Rank Within Season",question:"Rank episodes within each season by IMDB rating (best=1).",hint:"RANK() PARTITION BY season ORDER BY imdb_rating DESC.",answer:"SELECT season, episode_title, imdb_rating,\n  RANK() OVER (PARTITION BY season\n    ORDER BY imdb_rating DESC) AS season_rank\nFROM episodes\nORDER BY season, season_rank;",tables:["episodes"],keywords:["SELECT","RANK","OVER","PARTITION BY","season","ORDER BY","imdb_rating","DESC","AS","FROM","episodes"]},
  {id:"8.2",title:"Running Confessionals",question:"Season 49: running confessional total per castaway, episode by episode.",hint:"SUM() OVER (PARTITION BY castaway ORDER BY episode).",answer:"SELECT castaway, episode, confessional_count,\n  SUM(confessional_count) OVER (\n    PARTITION BY castaway ORDER BY episode\n  ) AS running_total\nFROM confessionals\nWHERE season = 49\nORDER BY castaway, episode;",tables:["confessionals"],keywords:["SELECT","SUM","confessional_count","OVER","PARTITION BY","castaway","ORDER BY","episode","AS","FROM","confessionals","WHERE","season","49"]},
  {id:"8.3",title:"Season vs Series",question:"Compare each season's avg viewership to the overall series average.",hint:"AVG() as both aggregate and window function.",answer:"SELECT season,\n  AVG(viewers) AS season_avg,\n  AVG(AVG(viewers)) OVER () AS series_avg,\n  AVG(viewers) - AVG(AVG(viewers)) OVER () AS vs_series_avg\nFROM episodes\nGROUP BY season\nORDER BY vs_series_avg DESC;",tables:["episodes"],keywords:["SELECT","AVG","viewers","AS","OVER","FROM","episodes","GROUP BY","season","ORDER BY","DESC"]},
 ],bonus:[]},
{id:9,title:"CASE & Strings",
 intro:"Time to add logic and text manipulation to your queries. CASE WHEN is SQL's IF statement, and string functions help you search and transform text.",
 concept:{text:"CASE WHEN = conditional logic. LIKE + % = pattern matching.",code:"CASE\n  WHEN score >= 90 THEN 'Excellent'\n  ELSE 'Needs Work'\nEND AS grade",tip:"LIKE uses % as wildcard: '%Rob%' matches anything containing Rob."},
 scenarios:[
  {id:"9.1",title:"Rating Tiers",question:"Categorize episodes: 'Hit' (‚â•8), 'Solid' (‚â•7), 'Meh' (<7). Count each.",hint:"CASE WHEN in SELECT, GROUP BY the category.",answer:"SELECT\n  CASE\n    WHEN imdb_rating >= 8 THEN 'Hit'\n    WHEN imdb_rating >= 7 THEN 'Solid'\n    ELSE 'Meh'\n  END AS rating_tier,\n  COUNT(*) AS episode_count\nFROM episodes\nGROUP BY rating_tier\nORDER BY episode_count DESC;",tables:["episodes"],keywords:["SELECT","CASE","WHEN","THEN","ELSE","END","AS","COUNT","FROM","episodes","GROUP BY","ORDER BY","DESC"]},
  {id:"9.2",title:"Idol Episodes",question:"Episodes with 'Idol' in the title (case-insensitive).",hint:"UPPER() + LIKE '%IDOL%'.",answer:"SELECT season, episode_title, imdb_rating\nFROM episodes\nWHERE UPPER(episode_title) LIKE '%IDOL%';",tables:["episodes"],keywords:["SELECT","FROM","episodes","WHERE","UPPER","episode_title","LIKE","IDOL"]},
  {id:"9.3",title:"Loyalty Score",question:"Season 47: what % of each castaway's votes matched who was voted out? Top 10.",hint:"CASE WHEN vote = voted_out THEN 1 ELSE 0 inside SUM.",answer:"SELECT castaway,\n  COUNT(*) AS total_votes,\n  SUM(CASE WHEN vote = voted_out THEN 1 ELSE 0 END) AS correct,\n  ROUND(100.0 * SUM(CASE WHEN vote = voted_out\n    THEN 1 ELSE 0 END) / COUNT(*), 1) AS loyalty_pct\nFROM vote_history\nWHERE season = 47\nGROUP BY castaway\nORDER BY loyalty_pct DESC\nLIMIT 10;",tables:["vote_history"],keywords:["SELECT","COUNT","SUM","CASE","WHEN","THEN","ELSE","END","AS","ROUND","FROM","vote_history","WHERE","season","47","GROUP BY","ORDER BY","DESC","LIMIT","10"]},
 ],bonus:[]},
{id:10,title:"Capstone Challenges",
 intro:"This is it ‚Äî Final Tribal Council. These challenges combine every concept. They're designed to feel like real analytical questions you'd tackle on the job.",
 concept:{text:"CTEs (WITH...AS) break complex queries into readable, named steps.",code:"WITH cte AS (\n  SELECT ... FROM ...\n)\nSELECT * FROM cte;",tip:"Think of each CTE as a temporary table that only exists for your query."},
 scenarios:[
  {id:"10.1",title:"The Edit Bay",question:'Season 48 "confessional equity": each player\'s total confessionals, placement, and share vs equal share.',hint:"CTEs for totals. Compare player % to equal %.",answer:"WITH season_totals AS (\n  SELECT castaway, castaway_id,\n    SUM(confessional_count) AS player_total\n  FROM confessionals WHERE season = 48\n  GROUP BY castaway, castaway_id\n),\nseason_agg AS (\n  SELECT SUM(player_total) AS grand_total,\n    COUNT(*) AS n_players\n  FROM season_totals\n)\nSELECT st.castaway, ca.place, st.player_total,\n  ROUND(100.0*st.player_total/sa.grand_total,1) AS actual_share,\n  ROUND(100.0/sa.n_players,1) AS equal_share\nFROM season_totals st\nCROSS JOIN season_agg sa\nINNER JOIN castaways ca\n  ON st.castaway_id = ca.castaway_id AND ca.season = 48\nORDER BY actual_share DESC;",tables:["confessionals","castaways"],keywords:["WITH","AS","SELECT","SUM","confessional_count","FROM","confessionals","WHERE","season","48","GROUP BY","COUNT","ROUND","CROSS JOIN","INNER JOIN","castaways","ON","castaway_id","ORDER BY","DESC"]},
  {id:"10.2",title:"Tribal Chaos",question:"Most chaotic tribals ‚Äî most spread-out votes. Show season, episode, tribe, distinct targets, who was voted out.",hint:"COUNT(DISTINCT vote).",answer:"SELECT season, episode, tribe,\n  COUNT(DISTINCT vote) AS vote_targets, voted_out\nFROM vote_history\nWHERE vote != ''\nGROUP BY season, episode, tribe, voted_out\nORDER BY vote_targets DESC\nLIMIT 15;",tables:["vote_history"],keywords:["SELECT","COUNT","DISTINCT","vote","AS","FROM","vote_history","WHERE","GROUP BY","season","episode","tribe","voted_out","ORDER BY","DESC","LIMIT","15"]},
  {id:"10.3",title:"The Winner's Edit",question:"Do winners get more confessionals than average? Compare each winner's total to season average.",hint:"Join season_summary with confessionals subquery.",answer:"WITH player_totals AS (\n  SELECT season, castaway_id, castaway,\n    SUM(confessional_count) AS total\n  FROM confessionals\n  GROUP BY season, castaway_id, castaway\n),\nseason_avgs AS (\n  SELECT season, AVG(total) AS avg_total\n  FROM player_totals GROUP BY season\n)\nSELECT s.season, s.winner,\n  pt.total AS winner_total,\n  ROUND(sa.avg_total,1) AS season_avg,\n  CASE WHEN pt.total > sa.avg_total THEN 'Above' ELSE 'Below' END AS status\nFROM season_summary s\nINNER JOIN player_totals pt\n  ON s.winner_id = pt.castaway_id AND s.season = pt.season\nINNER JOIN season_avgs sa ON s.season = sa.season\nORDER BY s.season;",tables:["season_summary","confessionals"],keywords:["WITH","AS","SELECT","SUM","confessional_count","FROM","confessionals","GROUP BY","AVG","ROUND","CASE","WHEN","THEN","ELSE","END","season_summary","INNER JOIN","ON","winner_id","castaway_id","ORDER BY"]},
 ],bonus:[]},
{id:11,title:"Usage Funnels",
 intro:"Funnels reveal how users (or castaways!) move through a journey ‚Äî and where they drop off. By tracking stage progression in SQL, you can pinpoint exactly where you're losing people.",
 concept:{text:"A funnel counts how many users reach each stage. The drop-off between stages is your churn. Use CASE WHEN and CTEs to define stages, then COUNT to measure each step.",code:"WITH stages AS (\n  SELECT castaway,\n    CASE\n      WHEN place = 1  THEN 'Winner'\n      WHEN finalist = 1 THEN 'Finalist'\n      WHEN jury = 1   THEN 'Jury'\n      ELSE 'Pre-Jury'\n    END AS stage\n  FROM castaways WHERE season = 47\n)\nSELECT stage, COUNT(*) AS players\nFROM stages GROUP BY stage;",tip:"Funnel stages must be mutually exclusive. Order them from broadest (top) to narrowest (bottom) for a true funnel shape."},
 scenarios:[
  {id:"11.1",title:"Season 47 Game Funnel",question:"For season 47, count how many castaways reached each stage: 'Winner', 'Finalist', 'Jury', and 'Pre-Jury'. Show stage and player count, ordered by count ascending.",hint:"Use CASE WHEN with place, finalist, and jury columns. Winner = place 1, Finalist = finalist=1, Jury = jury=1, else Pre-Jury.",answer:"SELECT\n  CASE\n    WHEN place = 1 THEN 'Winner'\n    WHEN finalist = 1 THEN 'Finalist'\n    WHEN jury = 1 THEN 'Jury'\n    ELSE 'Pre-Jury'\n  END AS stage,\n  COUNT(*) AS players\nFROM castaways\nWHERE season = 47\nGROUP BY stage\nORDER BY players ASC;",tables:["castaways"],keywords:["SELECT","CASE","WHEN","place","1","THEN","Winner","finalist","Finalist","jury","Jury","ELSE","Pre-Jury","END","AS","COUNT","FROM","castaways","WHERE","season","47","GROUP BY","stage","ORDER BY","players","ASC"]},
  {id:"11.2",title:"Funnel Conversion Rates",question:"Across all seasons, calculate: total cast, how many made jury, and the jury conversion rate (rounded to 1 decimal). Label columns clearly.",hint:"COUNT(*) for total, SUM(jury) for jury members, then ROUND(100.0*SUM(jury)/COUNT(*),1) for rate.",answer:"SELECT\n  COUNT(*) AS total_cast,\n  SUM(jury) AS made_jury,\n  ROUND(100.0 * SUM(jury) / COUNT(*), 1) AS jury_rate_pct\nFROM castaways;",tables:["castaways"],keywords:["SELECT","COUNT","SUM","jury","ROUND","100","FROM","castaways","total_cast","made_jury","jury_rate_pct"]},
  {id:"11.3",title:"Multi-Season Funnel",question:"For each season, show total cast, number who made jury, number of finalists, and winners. Order by season.",hint:"SUM(jury), SUM(finalist), SUM(winner), COUNT(*) from castaways, GROUP BY season.",answer:"SELECT season,\n  COUNT(*) AS total_cast,\n  SUM(jury) AS jury_count,\n  SUM(finalist) AS finalist_count,\n  SUM(winner) AS winner_count\nFROM castaways\nGROUP BY season\nORDER BY season;",tables:["castaways"],keywords:["SELECT","season","COUNT","SUM","jury","finalist","winner","FROM","castaways","GROUP BY","ORDER BY"]},
 ],
 bonus:[
  {id:"11.B1",title:"Funnel Drop-Off Rates",question:"Using a CTE, calculate per-season: cast size, jury rate (%), and finalist rate (%). Show seasons with the highest finalist rate first.",hint:"CTE for counts, then ROUND(100.0*jury_ct/cast_size,1) in outer query.",answer:"WITH funnel AS (\n  SELECT season,\n    COUNT(*) AS cast_size,\n    SUM(jury) AS jury_ct,\n    SUM(finalist) AS finalist_ct\n  FROM castaways\n  GROUP BY season\n)\nSELECT season, cast_size,\n  ROUND(100.0*jury_ct/cast_size,1) AS jury_rate,\n  ROUND(100.0*finalist_ct/cast_size,1) AS finalist_rate\nFROM funnel\nORDER BY finalist_rate DESC;",tables:["castaways"],keywords:["WITH","AS","SELECT","season","COUNT","SUM","jury","finalist","FROM","castaways","GROUP BY","ROUND","ORDER BY","DESC"]},
 ]},
{id:12,title:"User Churn Analysis",
 intro:"Churn measures who drops off ‚Äî and when. In product analytics, you track when users stop engaging. In Survivor, every vote-off is churn. SQL lets you calculate survival rates, identify high-churn episodes, and spot patterns.",
 concept:{text:"Churn rate = users lost / users at start. Use COUNT, SUM with CASE WHEN, and window functions to track who 'churns' at each step.",code:"SELECT episode,\n  COUNT(DISTINCT voted_out) AS churned\nFROM vote_history\nWHERE season = 47\n  AND voted_out != ''\nGROUP BY episode\nORDER BY episode;",tip:"Survival rate = 1 - churn rate. If 18 start and 1 is eliminated ep 1, survival rate = 17/18 = 94.4%."},
 scenarios:[
  {id:"12.1",title:"Votes Per Episode",question:"How many players were voted out each episode of season 47? Show episode number and count, ordered by episode.",hint:"COUNT(DISTINCT voted_out) from vote_history, season=47, voted_out != '', GROUP BY episode.",answer:"SELECT episode,\n  COUNT(DISTINCT voted_out) AS players_voted_out\nFROM vote_history\nWHERE season = 47\n  AND voted_out != ''\nGROUP BY episode\nORDER BY episode;",tables:["vote_history"],keywords:["SELECT","episode","COUNT","DISTINCT","voted_out","FROM","vote_history","WHERE","season","47","AND","GROUP BY","ORDER BY"]},
  {id:"12.2",title:"High-Churn Episodes",question:"Across all seasons, which 10 episodes had the most players voted out? Show season, episode, and churn count.",hint:"COUNT(DISTINCT voted_out) where voted_out != '', GROUP BY season AND episode, ORDER DESC LIMIT 10.",answer:"SELECT season, episode,\n  COUNT(DISTINCT voted_out) AS churned\nFROM vote_history\nWHERE voted_out != ''\nGROUP BY season, episode\nORDER BY churned DESC\nLIMIT 10;",tables:["vote_history"],keywords:["SELECT","season","episode","COUNT","DISTINCT","voted_out","churned","FROM","vote_history","WHERE","GROUP BY","ORDER BY","DESC","LIMIT","10"]},
  {id:"12.3",title:"Churn Rate by Tribal",question:"For each season, what is the average number of players voted out per tribal council? Show season and avg_churn_per_tribal, rounded to 2 decimals. Order by highest churn first.",hint:"Use a subquery: inner counts churned per episode per season, outer averages those counts.",answer:"SELECT season,\n  ROUND(AVG(churned),2) AS avg_churn_per_tribal\nFROM (\n  SELECT season, episode,\n    COUNT(DISTINCT voted_out) AS churned\n  FROM vote_history\n  WHERE voted_out != ''\n  GROUP BY season, episode\n)\nGROUP BY season\nORDER BY avg_churn_per_tribal DESC;",tables:["vote_history"],keywords:["SELECT","season","ROUND","AVG","churned","COUNT","DISTINCT","voted_out","FROM","vote_history","WHERE","GROUP BY","episode","ORDER BY","DESC"]},
 ],
 bonus:[
  {id:"12.B1",title:"Elimination Timing Stats",question:"What is the average and earliest episode number at which players are eliminated? Use distinct voted_out and episode pairs.",hint:"AVG(episode) and MIN(episode) from a subquery of DISTINCT voted_out, episode pairs where voted_out != ''.",answer:"SELECT\n  ROUND(AVG(episode),1) AS avg_elimination_episode,\n  MIN(episode) AS earliest_elimination,\n  MAX(episode) AS latest_elimination\nFROM (\n  SELECT DISTINCT voted_out, episode\n  FROM vote_history\n  WHERE voted_out != ''\n);",tables:["vote_history"],keywords:["SELECT","ROUND","AVG","episode","MIN","MAX","FROM","DISTINCT","voted_out","WHERE"]},
 ]},
{id:13,title:"Visualization, Communication & Experimental Design",
 intro:"Great analysis means nothing if you can't communicate it. This module covers preparing SQL output for charts, writing queries that answer 'why' questions, and structuring data like a real A/B experiment.",
 concept:{text:"Format data for charts with buckets and labels. Use CASE WHEN to bin values. Design experiments by clearly defining 'treatment' vs 'control' groups and comparing key metrics.",code:"-- Bucket ratings for a histogram\nSELECT\n  CASE\n    WHEN imdb_rating >= 9 THEN '9+'\n    WHEN imdb_rating >= 8 THEN '8-9'\n    WHEN imdb_rating >= 7 THEN '7-8'\n    ELSE 'Under 7'\n  END AS bucket,\n  COUNT(*) AS count\nFROM episodes\nGROUP BY bucket;",tip:"When preparing chart data, think: X axis = GROUP BY column, Y axis = aggregate value. Your query IS your chart query."},
 scenarios:[
  {id:"13.1",title:"Ratings Histogram (Bar Chart Data)",question:"Bucket episodes by IMDB rating: '9+', '8-8.9', '7-7.9', '6-6.9', 'Under 6'. Show bucket and count, ordered best-to-worst.",hint:"CASE WHEN on imdb_rating, GROUP BY the label, ORDER BY MIN(imdb_rating) DESC.",answer:"SELECT\n  CASE\n    WHEN imdb_rating >= 9 THEN '9+'\n    WHEN imdb_rating >= 8 THEN '8-8.9'\n    WHEN imdb_rating >= 7 THEN '7-7.9'\n    WHEN imdb_rating >= 6 THEN '6-6.9'\n    ELSE 'Under 6'\n  END AS rating_bucket,\n  COUNT(*) AS episode_count\nFROM episodes\nWHERE imdb_rating IS NOT NULL\nGROUP BY rating_bucket\nORDER BY MIN(imdb_rating) DESC;",tables:["episodes"],keywords:["SELECT","CASE","WHEN","imdb_rating","THEN","ELSE","END","AS","COUNT","FROM","episodes","WHERE","IS NOT NULL","GROUP BY","ORDER BY","MIN","DESC"]},
  {id:"13.2",title:"Viewership Time Series (Line Chart Data)",question:"For seasons 40‚Äì49, show season, average viewers, and average IMDB rating per season. This is your line chart dataset. Order by season.",hint:"AVG(viewers), AVG(imdb_rating) WHERE season BETWEEN 40 AND 49, GROUP BY season.",answer:"SELECT season,\n  ROUND(AVG(viewers),2) AS avg_viewers,\n  ROUND(AVG(imdb_rating),2) AS avg_rating\nFROM episodes\nWHERE season BETWEEN 40 AND 49\nGROUP BY season\nORDER BY season;",tables:["episodes"],keywords:["SELECT","season","ROUND","AVG","viewers","imdb_rating","FROM","episodes","WHERE","BETWEEN","40","49","GROUP BY","ORDER BY"]},
  {id:"13.3",title:"A/B Experiment ‚Äî Location Effect",question:"Treat Fiji seasons as 'Fiji (Treatment)' and all others as 'Other (Control)'. Compare episode count, avg viewers, and avg IMDB rating for each group.",hint:"CASE WHEN country='Fiji' THEN... JOIN episodes to season_summary, GROUP BY experiment group.",answer:"SELECT\n  CASE WHEN s.country = 'Fiji' THEN 'Fiji (Treatment)'\n    ELSE 'Other (Control)' END AS experiment_group,\n  COUNT(e.episode) AS episode_count,\n  ROUND(AVG(e.viewers),2) AS avg_viewers,\n  ROUND(AVG(e.imdb_rating),2) AS avg_rating\nFROM episodes e\nINNER JOIN season_summary s ON e.season = s.season\nGROUP BY experiment_group;",tables:["episodes","season_summary"],keywords:["SELECT","CASE","WHEN","country","Fiji","THEN","ELSE","END","AS","COUNT","ROUND","AVG","viewers","imdb_rating","FROM","episodes","INNER JOIN","season_summary","ON","season","GROUP BY","experiment_group"]},
 ],
 bonus:[
  {id:"13.B1",title:"Executive Summary Dashboard",question:"Write a single query producing a clean exec summary: total seasons, total episodes, peak viewership, best IMDB rating, avg rating, avg viewers. All labeled with clear aliases.",hint:"All aggregates in one SELECT from episodes ‚Äî no GROUP BY needed. Use COUNT(DISTINCT season) for seasons.",answer:"SELECT\n  COUNT(DISTINCT season) AS total_seasons,\n  COUNT(*) AS total_episodes,\n  MAX(viewers) AS peak_viewers,\n  MAX(imdb_rating) AS best_rating,\n  ROUND(AVG(imdb_rating),2) AS avg_rating,\n  ROUND(AVG(viewers),2) AS avg_viewers\nFROM episodes;",tables:["episodes"],keywords:["SELECT","COUNT","DISTINCT","season","MAX","viewers","imdb_rating","ROUND","AVG","FROM","episodes"]},
 ]},
{id:14,title:"Marketing Attribution",
 intro:"Marketing attribution answers: 'what drove this result?' When the Survivor franchise launches in a new location, introduces a twist, or brings back all-stars ‚Äî does it move the needle? SQL can measure it.",
 concept:{text:"Attribution compares a metric before vs after a change, or across treatment/control groups. LAG() lets you compare each season to the prior one to isolate the effect of changes.",code:"WITH avgs AS (\n  SELECT season, AVG(viewers) AS avg_v\n  FROM episodes GROUP BY season\n)\nSELECT season, avg_v,\n  LAG(avg_v) OVER (ORDER BY season) AS prior,\n  avg_v - LAG(avg_v) OVER\n    (ORDER BY season) AS lift\nFROM avgs;",tip:"Attribution requires a clear comparison group. Always ask: 'compared to what?' before drawing conclusions."},
 scenarios:[
  {id:"14.1",title:"Season-over-Season Viewership Change",question:"Using a CTE for average viewers per season, calculate each season's avg_viewers, prior season's avg (LAG), and viewership change. Show season, season_name, avg_viewers, prev_avg, and change. Order by season.",hint:"CTE from episodes for avg viewers, then LAG() in outer query, JOIN to season_summary for the name.",answer:"WITH season_avg AS (\n  SELECT season, ROUND(AVG(viewers),2) AS avg_viewers\n  FROM episodes\n  GROUP BY season\n)\nSELECT sa.season, s.season_name,\n  sa.avg_viewers,\n  LAG(sa.avg_viewers) OVER (ORDER BY sa.season) AS prev_avg,\n  ROUND(sa.avg_viewers - LAG(sa.avg_viewers) OVER (ORDER BY sa.season),2) AS viewership_change\nFROM season_avg sa\nINNER JOIN season_summary s ON sa.season = s.season\nORDER BY sa.season;",tables:["episodes","season_summary"],keywords:["WITH","AS","SELECT","season","ROUND","AVG","viewers","FROM","episodes","GROUP BY","LAG","OVER","ORDER BY","INNER JOIN","season_summary","ON","viewership_change"]},
  {id:"14.2",title:"New Location Debut Impact",question:"Does a brand-new filming location get better viewership than repeat locations? Use ROW_NUMBER() to identify first vs. repeat visits per location. Show location, first-season avg viewers, repeat avg viewers.",hint:"ROW_NUMBER() OVER (PARTITION BY location ORDER BY season) = 1 means first visit. Join with episodes for viewers.",answer:"WITH loc_rank AS (\n  SELECT s.season, s.location, e.viewers,\n    ROW_NUMBER() OVER (PARTITION BY s.location ORDER BY s.season) AS visit_num\n  FROM season_summary s\n  INNER JOIN episodes e ON s.season = e.season\n)\nSELECT location,\n  ROUND(AVG(CASE WHEN visit_num = 1 THEN viewers END),2) AS first_season_avg,\n  ROUND(AVG(CASE WHEN visit_num > 1 THEN viewers END),2) AS repeat_avg\nFROM loc_rank\nGROUP BY location\nHAVING repeat_avg IS NOT NULL\nORDER BY first_season_avg DESC;",tables:["season_summary","episodes"],keywords:["WITH","AS","SELECT","season","location","viewers","ROW_NUMBER","OVER","PARTITION BY","ORDER BY","INNER JOIN","episodes","ON","ROUND","AVG","CASE","WHEN","visit_num","GROUP BY","HAVING","IS NOT NULL","DESC"]},
  {id:"14.3",title:"Cast Size as Marketing Signal",question:"Larger casts often signal bigger marketing budgets. Do they drive more viewership? Bucket seasons by cast size: 'Small (‚â§15)', 'Medium (16-18)', 'Large (19+)'. Show group, episode count, and avg viewers.",hint:"CASE WHEN on n_cast from season_summary, JOIN episodes, GROUP BY cast_size_group.",answer:"SELECT\n  CASE\n    WHEN s.n_cast <= 15 THEN 'Small (‚â§15)'\n    WHEN s.n_cast <= 18 THEN 'Medium (16-18)'\n    ELSE 'Large (19+)'\n  END AS cast_size_group,\n  COUNT(e.episode) AS episodes,\n  ROUND(AVG(e.viewers),2) AS avg_viewers\nFROM season_summary s\nINNER JOIN episodes e ON s.season = e.season\nGROUP BY cast_size_group\nORDER BY avg_viewers DESC;",tables:["season_summary","episodes"],keywords:["SELECT","CASE","WHEN","n_cast","15","18","THEN","ELSE","END","AS","COUNT","ROUND","AVG","viewers","FROM","season_summary","INNER JOIN","episodes","ON","season","GROUP BY","ORDER BY","DESC"]},
 ],
 bonus:[
  {id:"14.B1",title:"Premiere vs Finale Lift",question:"For each season, compare premiere (episode 1) viewership to the season's peak viewership. Show season, premiere_viewers, peak_viewers, and the lift (peak - premiere), ordered by biggest lift.",hint:"MAX(CASE WHEN episode=1 THEN viewers END) for premiere, MAX(viewers) for peak.",answer:"SELECT season,\n  MAX(CASE WHEN episode = 1 THEN viewers END) AS premiere_viewers,\n  MAX(viewers) AS peak_viewers,\n  MAX(viewers) - MAX(CASE WHEN episode = 1 THEN viewers END) AS lift\nFROM episodes\nGROUP BY season\nORDER BY lift DESC;",tables:["episodes"],keywords:["SELECT","season","MAX","CASE","WHEN","episode","1","THEN","viewers","END","AS","premiere_viewers","peak_viewers","lift","FROM","episodes","GROUP BY","ORDER BY","DESC"]},
 ]},
{id:15,title:"Coding Challenge ‚Äî Data Scientist",
 intro:"These are real-world style questions a data scientist might face in an interview or on the job. They test statistical reasoning, multi-step query writing, and the ability to communicate insights clearly.",
 concept:{text:"Data scientists calculate distributions, build cohort analyses, and validate hypotheses. Master CTEs, window functions, and statistical aggregates (and know how to fake STDDEV when it's missing).",code:"-- Manual variance in SQLite\nSELECT\n  AVG(viewers) AS mean,\n  MAX(viewers) - MIN(viewers) AS range,\n  AVG(viewers*viewers)\n    - AVG(viewers)*AVG(viewers) AS variance\nFROM episodes;",tip:"When STDDEV() isn't available in SQLite, compute variance as AVG(x¬≤) ‚àí AVG(x)¬≤. Square root is your standard deviation."},
 scenarios:[
  {id:"15.1",title:"Confessional-to-Placement Correlation",question:"For season 49, show each castaway's total confessionals and final placement. Order by placement. (The pattern you see is a real data science finding!)",hint:"SUM(confessional_count) from confessionals JOIN castaways on castaway_id AND season, WHERE season=49.",answer:"SELECT c.castaway,\n  SUM(cf.confessional_count) AS total_confessionals,\n  c.place\nFROM confessionals cf\nINNER JOIN castaways c\n  ON cf.castaway_id = c.castaway_id\n  AND cf.season = c.season\nWHERE cf.season = 49\nGROUP BY c.castaway, c.place\nORDER BY c.place;",tables:["confessionals","castaways"],keywords:["SELECT","castaway","SUM","confessional_count","AS","place","FROM","confessionals","INNER JOIN","castaways","ON","castaway_id","season","WHERE","49","GROUP BY","ORDER BY"]},
  {id:"15.2",title:"Statistical Distribution of Ratings",question:"For all non-null IMDB ratings: compute total episode count, mean, min, max, and variance (AVG(x¬≤) - AVG(x)¬≤, rounded to 3 decimals).",hint:"All aggregates in one SELECT. Variance = AVG(imdb_rating*imdb_rating) - AVG(imdb_rating)*AVG(imdb_rating).",answer:"SELECT\n  COUNT(*) AS total_episodes,\n  ROUND(AVG(imdb_rating),3) AS mean_rating,\n  MIN(imdb_rating) AS min_rating,\n  MAX(imdb_rating) AS max_rating,\n  ROUND(AVG(imdb_rating*imdb_rating) - AVG(imdb_rating)*AVG(imdb_rating),3) AS variance\nFROM episodes\nWHERE imdb_rating IS NOT NULL;",tables:["episodes"],keywords:["SELECT","COUNT","ROUND","AVG","imdb_rating","MIN","MAX","AS","FROM","episodes","WHERE","IS NOT NULL","variance"]},
  {id:"15.3",title:"Era Cohort Analysis",question:"Segment seasons into eras: 'Classic (1-10)', 'Middle (11-20)', 'Evolved (21-30)', 'Modern (31-40)', 'New Era (41+)'. For each era show: season count, avg cast size, avg jury size, avg finalists.",hint:"CASE WHEN on season BETWEEN ranges in season_summary, GROUP BY era, ORDER BY MIN(season).",answer:"SELECT\n  CASE\n    WHEN season BETWEEN 1 AND 10 THEN 'Classic (1-10)'\n    WHEN season BETWEEN 11 AND 20 THEN 'Middle (11-20)'\n    WHEN season BETWEEN 21 AND 30 THEN 'Evolved (21-30)'\n    WHEN season BETWEEN 31 AND 40 THEN 'Modern (31-40)'\n    ELSE 'New Era (41+)'\n  END AS era,\n  COUNT(*) AS seasons,\n  ROUND(AVG(n_cast),1) AS avg_cast,\n  ROUND(AVG(n_jury),1) AS avg_jury,\n  ROUND(AVG(n_finalists),1) AS avg_finalists\nFROM season_summary\nGROUP BY era\nORDER BY MIN(season);",tables:["season_summary"],keywords:["SELECT","CASE","WHEN","season","BETWEEN","THEN","ELSE","END","AS","COUNT","ROUND","AVG","n_cast","n_jury","n_finalists","FROM","season_summary","GROUP BY","ORDER BY","MIN"]},
 ],bonus:[]},
{id:16,title:"Coding Challenge ‚Äî Marketing",
 intro:"Marketing analysts use SQL to measure campaign performance, track audience behavior, and optimize reach. These challenges mirror the types of questions you'd tackle in a marketing analytics role.",
 concept:{text:"Key marketing metrics: reach (unique viewers), growth rate, retention (do audiences come back?), and lift (uplift vs baseline). SQL handles all of these with GROUP BY, LAG(), and conditional aggregation.",code:"-- Season-over-season growth %\nWITH avgs AS (\n  SELECT season, AVG(viewers) AS v\n  FROM episodes GROUP BY season\n)\nSELECT season, ROUND((v /\n  LAG(v) OVER (ORDER BY season)\n  - 1) * 100, 1) AS growth_pct\nFROM avgs;",tip:"Always express growth as a percentage for stakeholders. 'Up 2.3M viewers' is less intuitive than 'up 18% year-over-year'."},
 scenarios:[
  {id:"16.1",title:"Season Growth Rate",question:"Calculate avg viewership per season and the year-over-year growth % vs the prior season (rounded to 1 decimal). Show season, avg_viewers, and growth_pct. Order by season.",hint:"CTE for avg viewers per season, then LAG() and (current/prior - 1)*100 in the outer query.",answer:"WITH avgs AS (\n  SELECT season, ROUND(AVG(viewers),2) AS avg_viewers\n  FROM episodes GROUP BY season\n)\nSELECT season, avg_viewers,\n  ROUND((avg_viewers / LAG(avg_viewers) OVER (ORDER BY season) - 1)*100,1) AS growth_pct\nFROM avgs\nORDER BY season;",tables:["episodes"],keywords:["WITH","AS","SELECT","season","ROUND","AVG","viewers","FROM","episodes","GROUP BY","LAG","OVER","ORDER BY","growth_pct"]},
  {id:"16.2",title:"Audience Retention Index",question:"For each season, calculate the retention index: finale proxy viewership (minimum non-premiere episode viewers) / premiere viewership, rounded to 2 decimals. A score >1 means finale beat the premiere.",hint:"MAX(CASE WHEN episode=1 THEN viewers END) for premiere. MIN(CASE WHEN episode>1 THEN viewers END) for finale proxy.",answer:"WITH ep_data AS (\n  SELECT season,\n    MAX(CASE WHEN episode = 1 THEN viewers END) AS premiere,\n    MIN(CASE WHEN episode > 1 THEN viewers END) AS finale_proxy\n  FROM episodes GROUP BY season\n)\nSELECT season, premiere, finale_proxy,\n  ROUND(CAST(finale_proxy AS FLOAT)/premiere,2) AS retention_index\nFROM ep_data\nWHERE premiere IS NOT NULL AND finale_proxy IS NOT NULL\nORDER BY retention_index DESC;",tables:["episodes"],keywords:["WITH","AS","SELECT","season","MAX","CASE","WHEN","episode","1","THEN","viewers","END","AS","MIN","FROM","episodes","GROUP BY","ROUND","CAST","FLOAT","WHERE","IS NOT NULL","ORDER BY","DESC"]},
  {id:"16.3",title:"Top Performing Markets",question:"Identify the top 5 filming countries by average episode viewership. Show country, total episodes filmed there, and avg viewers.",hint:"JOIN season_summary with episodes on season, GROUP BY country, ORDER by avg viewers DESC, LIMIT 5.",answer:"SELECT s.country,\n  COUNT(e.episode) AS total_episodes,\n  ROUND(AVG(e.viewers),2) AS avg_viewers\nFROM season_summary s\nINNER JOIN episodes e ON s.season = e.season\nGROUP BY s.country\nORDER BY avg_viewers DESC\nLIMIT 5;",tables:["season_summary","episodes"],keywords:["SELECT","country","COUNT","episode","ROUND","AVG","viewers","FROM","season_summary","INNER JOIN","episodes","ON","season","GROUP BY","ORDER BY","DESC","LIMIT","5"]},
 ],bonus:[]},
{id:17,title:"Coding Challenge ‚Äî Product Operations",
 intro:"Product operations teams focus on efficiency, process health, and throughput metrics. These challenges test your ability to spot bottlenecks, measure operational performance, and build monitoring dashboards.",
 concept:{text:"Ops metrics: throughput (output per unit time), efficiency (output/input ratio), and anomaly detection (outliers from normal). Use COUNT, SUM, and CASE WHEN flags to build health checks.",code:"-- Operational health check\nSELECT season, episode,\n  COUNT(*) AS votes,\n  SUM(tie) AS ties,\n  CASE WHEN SUM(tie)>0\n    THEN 'Flagged' ELSE 'OK'\n  END AS status\nFROM vote_history\nGROUP BY season, episode;",tip:"Operational dashboards need to be refreshable and scannable. Use consistent rounding, clear aliases, and sort by the most actionable metric."},
 scenarios:[
  {id:"17.1",title:"Tribal Throughput Metrics",question:"For each season, calculate: total tribal councils (distinct episodes with votes), total votes cast, and average votes per tribal (rounded to 1 decimal). Order by season.",hint:"COUNT(DISTINCT episode) for tribals, COUNT(*) for votes, divide for avg. All from vote_history.",answer:"SELECT season,\n  COUNT(DISTINCT episode) AS tribals,\n  COUNT(*) AS total_votes,\n  ROUND(CAST(COUNT(*) AS FLOAT)/COUNT(DISTINCT episode),1) AS avg_votes_per_tribal\nFROM vote_history\nGROUP BY season\nORDER BY season;",tables:["vote_history"],keywords:["SELECT","season","COUNT","DISTINCT","episode","tribals","total_votes","ROUND","CAST","FLOAT","FROM","vote_history","GROUP BY","ORDER BY"]},
  {id:"17.2",title:"Content Production Rate",question:"For seasons 40‚Äì49, show season, episode count, total runtime (sum of episode_length), and avg episode length rounded to 1 decimal. Order by season.",hint:"COUNT, SUM, AVG on episode_length WHERE season BETWEEN 40 AND 49, GROUP BY season.",answer:"SELECT season,\n  COUNT(*) AS episode_count,\n  SUM(episode_length) AS total_runtime_mins,\n  ROUND(AVG(episode_length),1) AS avg_length\nFROM episodes\nWHERE season BETWEEN 40 AND 49\nGROUP BY season\nORDER BY season;",tables:["episodes"],keywords:["SELECT","season","COUNT","SUM","episode_length","ROUND","AVG","FROM","episodes","WHERE","BETWEEN","40","49","GROUP BY","ORDER BY"]},
  {id:"17.3",title:"Chaos Detection ‚Äî Tie Vote Flags",question:"Find all tribals where tie votes occurred. Show season, episode, total votes, tied vote count, tie %, and flag as 'High Chaos' if >30% were ties, else 'Normal'. Order by tie % descending.",hint:"SUM(tie) for tied votes, ROUND(100.0*SUM(tie)/COUNT(*),1) for pct, CASE WHEN pct>30 for flag.",answer:"SELECT season, episode,\n  COUNT(*) AS total_votes,\n  SUM(tie) AS tied_votes,\n  ROUND(100.0*SUM(tie)/COUNT(*),1) AS tie_pct,\n  CASE WHEN 100.0*SUM(tie)/COUNT(*) > 30\n    THEN 'High Chaos' ELSE 'Normal' END AS flag\nFROM vote_history\nGROUP BY season, episode\nHAVING SUM(tie) > 0\nORDER BY tie_pct DESC;",tables:["vote_history"],keywords:["SELECT","season","episode","COUNT","SUM","tie","ROUND","CASE","WHEN","THEN","High Chaos","ELSE","Normal","END","flag","FROM","vote_history","GROUP BY","HAVING","ORDER BY","DESC"]},
 ],bonus:[]},
{id:18,title:"Coding Challenge ‚Äî Product Manager",
 intro:"Product managers use data to understand users, prioritize features, and communicate impact to stakeholders. These challenges reflect the analytical questions PMs face daily ‚Äî segmentation, journey mapping, and KPI dashboards.",
 concept:{text:"PMs care about: who are your users (segmentation), what do they do (behavior), and are things improving (trends)? SQL helps you answer all three through GROUP BY, CASE WHEN, and time-series queries.",code:"-- User segmentation template\nSELECT\n  CASE\n    WHEN winner = 1 THEN 'Winner'\n    WHEN finalist = 1 THEN 'Runner-up'\n    WHEN jury = 1 THEN 'Jury'\n    ELSE 'Eliminated'\n  END AS segment,\n  COUNT(*), AVG(place)\nFROM castaways\nGROUP BY segment;",tip:"Frame every query around a user story: 'As a [user type], I [do X] in [context].' This clarifies what to SELECT, FROM, and WHERE."},
 scenarios:[
  {id:"18.1",title:"User Segmentation",question:"Segment all castaways into: 'Winner', 'Runner-up' (finalist but not winner), 'Jury Member', 'Eliminated'. Show each segment's player count and average placement, ordered by avg place.",hint:"CASE WHEN winner=1, finalist=1, jury=1, else Eliminated. GROUP BY segment, AVG(place).",answer:"SELECT\n  CASE\n    WHEN winner = 1 THEN 'Winner'\n    WHEN finalist = 1 THEN 'Runner-up'\n    WHEN jury = 1 THEN 'Jury Member'\n    ELSE 'Eliminated'\n  END AS segment,\n  COUNT(*) AS players,\n  ROUND(AVG(place),1) AS avg_place\nFROM castaways\nGROUP BY segment\nORDER BY avg_place;",tables:["castaways"],keywords:["SELECT","CASE","WHEN","winner","1","THEN","Winner","finalist","Runner-up","jury","Jury Member","ELSE","Eliminated","END","AS","COUNT","ROUND","AVG","place","FROM","castaways","GROUP BY","ORDER BY"]},
  {id:"18.2",title:"Feature Adoption ‚Äî Idol Episodes",question:"Do episodes with 'Idol' in the title get better IMDB ratings? Flag each episode (1=idol episode, 0=not), then show count and avg rating for each group.",hint:"CASE WHEN UPPER(episode_title) LIKE '%IDOL%' THEN 1 ELSE 0 END as flag, then GROUP BY it.",answer:"SELECT\n  CASE WHEN UPPER(episode_title) LIKE '%IDOL%'\n    THEN 1 ELSE 0 END AS idol_episode,\n  COUNT(*) AS episode_count,\n  ROUND(AVG(imdb_rating),2) AS avg_rating\nFROM episodes\nGROUP BY idol_episode;",tables:["episodes"],keywords:["SELECT","CASE","WHEN","UPPER","episode_title","LIKE","IDOL","THEN","1","ELSE","0","END","AS","idol_episode","COUNT","ROUND","AVG","imdb_rating","FROM","episodes","GROUP BY"]},
  {id:"18.3",title:"PM KPI Dashboard",question:"Build a one-row executive KPI dashboard for the entire franchise: total seasons, total castaway appearances, unique players, total episodes, peak viewership, and best IMDB rating. Use subqueries and clear aliases.",hint:"Each metric is a subquery in the SELECT: (SELECT COUNT(DISTINCT season) FROM season_summary), etc.",answer:"SELECT\n  (SELECT COUNT(DISTINCT season) FROM season_summary) AS total_seasons,\n  (SELECT COUNT(*) FROM castaways) AS total_appearances,\n  (SELECT COUNT(*) FROM castaway_details) AS unique_players,\n  (SELECT COUNT(*) FROM episodes) AS total_episodes,\n  (SELECT MAX(viewers) FROM episodes) AS peak_viewers,\n  (SELECT MAX(imdb_rating) FROM episodes) AS best_rating;",tables:["season_summary","castaways","castaway_details","episodes"],keywords:["SELECT","COUNT","DISTINCT","season","season_summary","castaways","castaway_details","episodes","MAX","viewers","imdb_rating","AS"]},
 ],bonus:[]},
];

const CHEAT=[["SELECT","Choose columns","SELECT castaway, season"],["FROM","Specify table","FROM castaways"],["WHERE","Filter rows","WHERE season = 47"],["AND / OR","Combine conditions","WHERE s=47 AND place=1"],["ORDER BY","Sort results","ORDER BY rating DESC"],["LIMIT","Cap rows","LIMIT 10"],["COUNT(*)","Count rows","SELECT COUNT(*)"],["SUM(col)","Add values","SUM(confessional_count)"],["AVG(col)","Mean","AVG(imdb_rating)"],["GROUP BY","Summarize","GROUP BY season"],["HAVING","Filter groups","HAVING COUNT(*)>5"],["JOIN...ON","Combine tables","JOIN d ON a.id=b.id"],["CASE WHEN","Conditional","CASE WHEN x>5 THEN 'High'"],["LIKE","Pattern match","WHERE name LIKE '%Rob%'"],["RANK() OVER","Window rank","RANK() OVER (ORDER BY x)"],["AS","Rename column","COUNT(*) AS total"]];

// ===== LIVE PRACTICE QUESTIONS =====
const LIVE_QUESTIONS = {
1:[
 {id:'1.L1',title:'Explore All Seasons',compound:false,challenge:'Pull every season\'s name, location, country, and winner from <code>season_summary</code>. What patterns do you notice?',hint:'SELECT season_name, location, country, winner FROM season_summary.',answer:'SELECT season_name, location, country, winner\nFROM season_summary;'},
 {id:'1.L2',title:'Castaway Profiles',compound:true,challenge:'Show the full_name, gender, and personality_type from <code>castaway_details</code>. Try selecting different columns to explore the table.',hint:'SELECT full_name, gender, personality_type FROM castaway_details.',answer:'SELECT full_name, gender, personality_type\nFROM castaway_details;'},
],
2:[
 {id:'2.L1',title:'Older Castaways',compound:false,challenge:'Find all castaways who were 60 years old or older when they played. Show their name, age, season, and city.',hint:'WHERE age >= 60 from the castaways table.',answer:'SELECT castaway, age, season, city\nFROM castaways\nWHERE age >= 60;'},
 {id:'2.L2',title:'High-Rated Recent Episodes',compound:true,challenge:'Find all episodes from seasons 40 and later with an IMDB rating above 8.5. Show season, title, rating, and viewers. (Compound: WHERE with AND on two conditions.)',hint:'WHERE season >= 40 AND imdb_rating > 8.5 from the episodes table.',answer:'SELECT season, episode_title, imdb_rating, viewers\nFROM episodes\nWHERE season >= 40\n  AND imdb_rating > 8.5;'},
],
3:[
 {id:'3.L1',title:'Most Watched Episodes Ever',compound:false,challenge:'What are the 10 most-watched episodes in Survivor history? Show season, title, and viewership.',hint:'ORDER BY viewers DESC LIMIT 10 from the episodes table.',answer:'SELECT season, episode_title, viewers\nFROM episodes\nORDER BY viewers DESC\nLIMIT 10;'},
 {id:'3.L2',title:'Youngest Winners',compound:true,challenge:'Which winners were youngest when they played? Show their name, age, and season. Show the 5 youngest. (Compound: WHERE to filter winners, then ORDER + LIMIT.)',hint:'WHERE winner = 1, ORDER BY age ASC, LIMIT 5 from castaways.',answer:'SELECT castaway, age, season\nFROM castaways\nWHERE winner = 1\nORDER BY age ASC\nLIMIT 5;'},
],
4:[
 {id:'4.L1',title:'Franchise Snapshot',compound:false,challenge:'Compute overall franchise stats in one query: total distinct seasons, total episodes, average IMDB rating, and average viewership ‚Äî all from the <code>episodes</code> table.',hint:'COUNT(DISTINCT season), COUNT(*), AVG(imdb_rating), AVG(viewers) ‚Äî all in one SELECT.',answer:'SELECT\n  COUNT(DISTINCT season) AS total_seasons,\n  COUNT(*) AS total_episodes,\n  ROUND(AVG(imdb_rating),2) AS avg_rating,\n  ROUND(AVG(viewers),2) AS avg_viewers\nFROM episodes;'},
 {id:'4.L2',title:'Winner Age Stats',compound:true,challenge:'What are the age statistics for all Survivor winners? Find their average age, youngest, and oldest winner. (Compound: WHERE to isolate winners + aggregate functions.)',hint:'AVG(age), MIN(age), MAX(age) FROM castaways WHERE winner = 1.',answer:'SELECT\n  COUNT(*) AS total_winners,\n  ROUND(AVG(age),1) AS avg_age,\n  MIN(age) AS youngest,\n  MAX(age) AS oldest\nFROM castaways\nWHERE winner = 1;'},
],
5:[
 {id:'5.L1',title:'Home States',compound:false,challenge:'Count how many castaways came from each US state. Show the top 15 states by player count.',hint:'GROUP BY state, COUNT(*), ORDER BY count DESC, LIMIT 15. Filter out nulls with WHERE state IS NOT NULL.',answer:'SELECT state, COUNT(*) AS players\nFROM castaways\nWHERE state IS NOT NULL AND state != \'\'\nGROUP BY state\nORDER BY players DESC\nLIMIT 15;'},
 {id:'5.L2',title:'Multi-Season Players',compound:true,challenge:'Find every castaway who has played more than once. Show their name and how many seasons they\'ve played, from most to least. (Compound: GROUP BY + HAVING + ORDER BY.)',hint:'GROUP BY castaway, COUNT(*) AS times_played HAVING COUNT(*) > 1 ORDER BY times_played DESC.',answer:'SELECT castaway, COUNT(*) AS seasons_played\nFROM castaways\nGROUP BY castaway\nHAVING COUNT(*) > 1\nORDER BY seasons_played DESC;'},
],
6:[
 {id:'6.L1',title:'Winner Demographics',compound:false,challenge:'Show every winner\'s full name, gender, and home state. Join <code>castaways</code> with <code>castaway_details</code> on castaway_id, filter to winner = 1.',hint:'JOIN castaways c with castaway_details cd ON c.castaway_id = cd.castaway_id WHERE c.winner = 1.',answer:'SELECT c.season, c.castaway, cd.full_name, cd.gender, c.state\nFROM castaways c\nINNER JOIN castaway_details cd ON c.castaway_id = cd.castaway_id\nWHERE c.winner = 1\nORDER BY c.season;'},
 {id:'6.L2',title:'Well-Rated Seasons',compound:true,challenge:'For seasons with an average IMDB rating above 7, show the season name, winner, and average rating. (Compound: JOIN episodes + season_summary, GROUP BY, HAVING.)',hint:'JOIN season_summary with episodes on season. GROUP BY season. HAVING AVG(imdb_rating) > 7.',answer:'SELECT s.season, s.season_name, s.winner,\n  ROUND(AVG(e.imdb_rating),2) AS avg_rating\nFROM season_summary s\nINNER JOIN episodes e ON s.season = e.season\nGROUP BY s.season\nHAVING AVG(e.imdb_rating) > 7\nORDER BY avg_rating DESC;'},
],
7:[
 {id:'7.L1',title:'Above-Average Episodes',compound:false,challenge:'Find all episodes that scored above the all-time average IMDB rating. Show season, title, and rating. How many are there?',hint:'WHERE imdb_rating > (SELECT AVG(imdb_rating) FROM episodes WHERE imdb_rating IS NOT NULL)',answer:'SELECT season, episode_title, imdb_rating\nFROM episodes\nWHERE imdb_rating > (\n  SELECT AVG(imdb_rating)\n  FROM episodes\n  WHERE imdb_rating IS NOT NULL\n)\nORDER BY imdb_rating DESC;'},
 {id:'7.L2',title:'Over-Average Jury Recipients',compound:true,challenge:'Find finalists who received more jury votes than the average finalist. Show finalist name and vote count. (Compound: subquery for average + HAVING.)',hint:'GROUP BY finalist, COUNT(*) HAVING COUNT(*) > (subquery for average vote count per finalist).',answer:'SELECT finalist, COUNT(*) AS votes_received\nFROM jury_votes\nGROUP BY finalist\nHAVING COUNT(*) > (\n  SELECT AVG(vote_count)\n  FROM (\n    SELECT finalist, COUNT(*) AS vote_count\n    FROM jury_votes\n    GROUP BY finalist\n  )\n)\nORDER BY votes_received DESC;'},
],
8:[
 {id:'8.L1',title:'Season Viewership Rankings',compound:false,challenge:'Rank all seasons by average viewership using RANK() OVER ‚Äî highest viewership = rank 1. Show season name and rank.',hint:'RANK() OVER (ORDER BY viewers_mean DESC) from season_summary.',answer:'SELECT season, season_name,\n  ROUND(viewers_mean,2) AS avg_viewers,\n  RANK() OVER (ORDER BY viewers_mean DESC) AS viewership_rank\nFROM season_summary\nORDER BY viewership_rank;'},
 {id:'8.L2',title:'Running Episode Viewership',compound:true,challenge:'For Season 46, show each episode\'s title, viewership, and the running cumulative total viewers for that season. (Compound: SUM() OVER with ORDER BY.)',hint:'SUM(viewers) OVER (ORDER BY episode) AS running_total WHERE season = 46.',answer:'SELECT episode, episode_title, viewers,\n  SUM(viewers) OVER (ORDER BY episode) AS cumulative_viewers\nFROM episodes\nWHERE season = 46\nORDER BY episode;'},
],
9:[
 {id:'9.L1',title:'Age Bracket Breakdown',compound:false,challenge:'Categorize all castaways into age brackets: Under 25, 25-34, 35-44, 45-54, 55+. Count how many players fall into each group.',hint:'CASE WHEN age < 25 THEN... GROUP BY age_bracket ORDER BY MIN(age).',answer:'SELECT\n  CASE\n    WHEN age < 25 THEN \'Under 25\'\n    WHEN age < 35 THEN \'25-34\'\n    WHEN age < 45 THEN \'35-44\'\n    WHEN age < 55 THEN \'45-54\'\n    ELSE \'55+\'\n  END AS age_bracket,\n  COUNT(*) AS players\nFROM castaways\nWHERE age IS NOT NULL\nGROUP BY age_bracket\nORDER BY MIN(age);'},
 {id:'9.L2',title:'Keyword Episode Hunt',compound:true,challenge:'Find every episode whose title contains \'Idol\', \'Merge\', or \'Finale\'. Label each with its type, and show the IMDB rating. (Compound: LIKE pattern matching + CASE + WHERE with OR.)',hint:'WHERE UPPER(episode_title) LIKE \'%IDOL%\' OR ... then CASE WHEN to assign type.',answer:'SELECT season, episode_title, imdb_rating,\n  CASE\n    WHEN UPPER(episode_title) LIKE \'%IDOL%\' THEN \'Idol\'\n    WHEN UPPER(episode_title) LIKE \'%MERGE%\' THEN \'Merge\'\n    ELSE \'Finale\'\n  END AS episode_type\nFROM episodes\nWHERE UPPER(episode_title) LIKE \'%IDOL%\'\n   OR UPPER(episode_title) LIKE \'%MERGE%\'\n   OR UPPER(episode_title) LIKE \'%FINALE%\'\nORDER BY episode_type, season;'},
],
10:[
 {id:'10.L1',title:'Modern Era Scoreboard',compound:false,challenge:'Build a scoreboard for seasons 40 and later: season name, winner, cast size, average IMDB rating, and total viewers. Use a CTE for the episode stats.',hint:'WITH ep_stats AS (SELECT season, AVG(imdb_rating), SUM(viewers) FROM episodes GROUP BY season) then JOIN to season_summary WHERE season >= 40.',answer:'WITH ep_stats AS (\n  SELECT season,\n    ROUND(AVG(imdb_rating),2) AS avg_rating,\n    ROUND(SUM(viewers),1) AS total_viewers\n  FROM episodes\n  GROUP BY season\n)\nSELECT s.season, s.season_name, s.winner, s.n_cast,\n  e.avg_rating, e.total_viewers\nFROM season_summary s\nINNER JOIN ep_stats e ON s.season = e.season\nWHERE s.season >= 40\nORDER BY s.season;'},
 {id:'10.L2',title:'The Winner\'s Edit ‚Äî Real Data',compound:true,challenge:'For every season, did the winner receive above-average confessionals? Use CTEs to compute each player\'s total and the season average, then compare. (Full capstone: CTEs + JOIN + CASE.)',hint:'CTE 1: totals per castaway per season. CTE 2: avg per season. JOIN season_summary on winner_id.',answer:'WITH totals AS (\n  SELECT season, castaway_id, SUM(confessional_count) AS total\n  FROM confessionals\n  GROUP BY season, castaway_id\n),\navgs AS (\n  SELECT season, AVG(total) AS avg_conf\n  FROM totals GROUP BY season\n)\nSELECT s.season, s.winner,\n  t.total AS winner_conf,\n  ROUND(a.avg_conf,1) AS season_avg,\n  CASE WHEN t.total > a.avg_conf\n    THEN \'Above Average\' ELSE \'Below Average\'\n  END AS edit_status\nFROM season_summary s\nINNER JOIN totals t\n  ON s.winner_id = t.castaway_id AND s.season = t.season\nINNER JOIN avgs a ON s.season = a.season\nORDER BY s.season;'},
],
11:[
 {id:'11.L1',title:'Season 45 Funnel',compound:false,challenge:'Build the real game funnel for Season 45: count players at each stage (Pre-Jury, Jury, Finalist, Winner) using actual castaway data.',hint:'CASE WHEN winner=1, finalist=1, jury=1, else Pre-Jury. GROUP BY stage, WHERE season=45.',answer:'SELECT\n  CASE\n    WHEN winner = 1 THEN \'4. Winner\'\n    WHEN finalist = 1 THEN \'3. Finalist\'\n    WHEN jury = 1 THEN \'2. Jury\'\n    ELSE \'1. Pre-Jury\'\n  END AS stage,\n  COUNT(*) AS players\nFROM castaways\nWHERE season = 45\nGROUP BY stage\nORDER BY stage;'},
 {id:'11.L2',title:'Jury Conversion Rate Rankings',compound:true,challenge:'For every season, calculate the jury conversion rate (% who made jury) and rank them highest to lowest. (Compound: CTE + ROUND + RANK().)',hint:'WITH funnel AS (COUNT, SUM(jury) GROUP BY season) then RANK() OVER (ORDER BY rate DESC).',answer:'WITH funnel AS (\n  SELECT season,\n    COUNT(*) AS cast_size,\n    SUM(jury) AS jury_ct\n  FROM castaways\n  GROUP BY season\n)\nSELECT season, cast_size, jury_ct,\n  ROUND(100.0*jury_ct/cast_size,1) AS jury_rate_pct,\n  RANK() OVER (ORDER BY 100.0*jury_ct/cast_size DESC) AS rank\nFROM funnel\nORDER BY jury_rate_pct DESC;'},
],
12:[
 {id:'12.L1',title:'Season 44 Episode Churn',compound:false,challenge:'For Season 44, how many players were voted out in each episode? Show episode and count, ordered by episode number.',hint:'COUNT(DISTINCT voted_out) WHERE season=44 AND voted_out != \'\' GROUP BY episode.',answer:'SELECT episode,\n  COUNT(DISTINCT voted_out) AS players_voted_out\nFROM vote_history\nWHERE season = 44\n  AND voted_out != \'\'\nGROUP BY episode\nORDER BY episode;'},
 {id:'12.L2',title:'Average Tribal Council Churn',compound:true,challenge:'Across all seasons, what is the average number of players voted out per tribal council per season? (Compound: nested aggregation ‚Äî first count per episode, then average those.)',hint:'Outer query: AVG of inner query\'s count per season. Inner: COUNT DISTINCT voted_out per season/episode.',answer:'SELECT ROUND(AVG(churned),2) AS avg_churn_per_tribal\nFROM (\n  SELECT season, episode,\n    COUNT(DISTINCT voted_out) AS churned\n  FROM vote_history\n  WHERE voted_out != \'\'\n  GROUP BY season, episode\n);'},
],
13:[
 {id:'13.L1',title:'Viewership Histogram',compound:false,challenge:'Bucket all episodes by viewership: Under 10M, 10‚Äì15M, 15‚Äì20M, 20M+. Show bucket label, episode count, and average IMDB rating per bucket.',hint:'CASE WHEN viewers < 10 THEN... GROUP BY bucket ORDER BY MIN(viewers).',answer:'SELECT\n  CASE\n    WHEN viewers < 10 THEN \'Under 10M\'\n    WHEN viewers < 15 THEN \'10-15M\'\n    WHEN viewers < 20 THEN \'15-20M\'\n    ELSE \'20M+\'\n  END AS viewer_bucket,\n  COUNT(*) AS episodes,\n  ROUND(AVG(imdb_rating),2) AS avg_rating\nFROM episodes\nWHERE viewers IS NOT NULL\nGROUP BY viewer_bucket\nORDER BY MIN(viewers);'},
 {id:'13.L2',title:'Fiji vs. Rest A/B Test',compound:true,challenge:'Treat Fiji seasons as the "treatment group" and all others as "control". Compare episode count, avg viewership, and avg IMDB rating for each group. What does the data say? (Compound: JOIN + GROUP BY + CASE.)',hint:'CASE WHEN s.country=\'Fiji\' THEN... JOIN season_summary with episodes, GROUP BY experiment_group.',answer:'SELECT\n  CASE WHEN s.country = \'Fiji\'\n    THEN \'Fiji (Treatment)\'\n    ELSE \'Other (Control)\'\n  END AS experiment_group,\n  COUNT(DISTINCT s.season) AS seasons,\n  COUNT(e.episode) AS episodes,\n  ROUND(AVG(e.viewers),2) AS avg_viewers,\n  ROUND(AVG(e.imdb_rating),2) AS avg_rating\nFROM season_summary s\nINNER JOIN episodes e ON s.season = e.season\nGROUP BY experiment_group;'},
],
14:[
 {id:'14.L1',title:'Season-over-Season Viewership Lift',compound:false,challenge:'Calculate each season\'s average viewership and the change vs. the prior season using LAG(). Which season saw the biggest single-season drop or gain?',hint:'WITH avgs AS (AVG viewers per season) then LAG(avg_v) OVER (ORDER BY season) in outer query.',answer:'WITH avgs AS (\n  SELECT season, ROUND(AVG(viewers),2) AS avg_v\n  FROM episodes GROUP BY season\n)\nSELECT season, avg_v,\n  LAG(avg_v) OVER (ORDER BY season) AS prior_season,\n  ROUND(avg_v - LAG(avg_v) OVER (ORDER BY season),2) AS change\nFROM avgs\nORDER BY season;'},
 {id:'14.L2',title:'New Location Debut Effect',compound:true,challenge:'When Survivor visits a location for the first time, does it get better viewership than return visits? Use ROW_NUMBER() to tag first vs. repeat visits, then compare avg viewers. (Compound: window function + conditional aggregation + JOIN.)',hint:'ROW_NUMBER() OVER (PARTITION BY location ORDER BY season) = 1 for debut. JOIN with episodes for viewers.',answer:'WITH ranked AS (\n  SELECT s.season, s.location, e.viewers,\n    ROW_NUMBER() OVER\n      (PARTITION BY s.location ORDER BY s.season) AS visit_num\n  FROM season_summary s\n  INNER JOIN episodes e ON s.season = e.season\n)\nSELECT location,\n  ROUND(AVG(CASE WHEN visit_num=1 THEN viewers END),2) AS debut_avg,\n  ROUND(AVG(CASE WHEN visit_num>1 THEN viewers END),2) AS return_avg\nFROM ranked\nGROUP BY location\nHAVING return_avg IS NOT NULL\nORDER BY debut_avg DESC;'},
],
15:[
 {id:'15.L1',title:'Full Ratings Distribution',compound:false,challenge:'Compute the full statistical distribution for IMDB ratings: count, mean, min, max, and variance (AVG(x¬≤) ‚àí AVG(x)¬≤). Round to 3 decimal places.',hint:'SELECT COUNT, AVG, MIN, MAX, and AVG(imdb_rating*imdb_rating) - AVG(imdb_rating)*AVG(imdb_rating) AS variance.',answer:'SELECT\n  COUNT(*) AS n,\n  ROUND(AVG(imdb_rating),3) AS mean,\n  MIN(imdb_rating) AS min,\n  MAX(imdb_rating) AS max,\n  ROUND(\n    AVG(imdb_rating*imdb_rating)\n    - AVG(imdb_rating)*AVG(imdb_rating)\n  ,4) AS variance\nFROM episodes\nWHERE imdb_rating IS NOT NULL;'},
 {id:'15.L2',title:'Era Cohort Demographics',compound:true,challenge:'Divide Survivor into 5 eras (Classic S1-10, Middle S11-20, Evolved S21-30, Modern S31-40, New Era S41+). For each era show: seasons, player count, avg age, and % female players. (Compound: CASE + JOIN + GROUP BY + ROUND + CASE inside AVG.)',hint:'CASE WHEN season BETWEEN ... JOIN castaways with castaway_details for gender. GROUP BY era.',answer:'SELECT\n  CASE\n    WHEN c.season <= 10 THEN \'Classic (S1-10)\'\n    WHEN c.season <= 20 THEN \'Middle (S11-20)\'\n    WHEN c.season <= 30 THEN \'Evolved (S21-30)\'\n    WHEN c.season <= 40 THEN \'Modern (S31-40)\'\n    ELSE \'New Era (S41+)\'\n  END AS era,\n  COUNT(DISTINCT c.season) AS seasons,\n  COUNT(*) AS players,\n  ROUND(AVG(c.age),1) AS avg_age,\n  ROUND(100.0*SUM(CASE WHEN cd.gender=\'Female\' THEN 1 ELSE 0 END)/COUNT(*),1) AS pct_female\nFROM castaways c\nINNER JOIN castaway_details cd ON c.castaway_id = cd.castaway_id\nWHERE c.age IS NOT NULL\nGROUP BY era\nORDER BY MIN(c.season);'},
],
16:[
 {id:'16.L1',title:'Year-over-Year Audience Growth',compound:false,challenge:'Calculate each season\'s avg viewership and the year-over-year growth % vs. the prior season. Which season grew the most? Which dropped the most?',hint:'WITH avgs AS (AVG viewers per season) then (avg_v / LAG(avg_v) OVER (...) - 1)*100 AS growth_pct.',answer:'WITH avgs AS (\n  SELECT season, ROUND(AVG(viewers),2) AS avg_viewers\n  FROM episodes GROUP BY season\n)\nSELECT season, avg_viewers,\n  ROUND(\n    (avg_viewers / LAG(avg_viewers) OVER (ORDER BY season) - 1)*100\n  ,1) AS growth_pct\nFROM avgs\nORDER BY season;'},
 {id:'16.L2',title:'Premiere-to-Peak Retention',compound:true,challenge:'For each season, calculate the retention index: peak viewership divided by premiere viewership. A score above 1 means the season built momentum. (Compound: conditional aggregation + CAST + JOIN.)',hint:'MAX(CASE WHEN episode=1 THEN viewers END) for premiere, MAX(viewers) for peak. CAST for float division.',answer:'WITH ep AS (\n  SELECT season,\n    MAX(CASE WHEN episode=1 THEN viewers END) AS premiere,\n    MAX(viewers) AS peak\n  FROM episodes GROUP BY season\n)\nSELECT e.season, s.season_name,\n  e.premiere AS premiere_viewers,\n  e.peak AS peak_viewers,\n  ROUND(CAST(e.peak AS FLOAT)/e.premiere,2) AS retention_index\nFROM ep e\nINNER JOIN season_summary s ON e.season = s.season\nWHERE e.premiere IS NOT NULL\nORDER BY retention_index DESC;'},
],
17:[
 {id:'17.L1',title:'Tribal Council Throughput',compound:false,challenge:'For each season, calculate: total tribals held, total votes cast, and average votes per tribal. This is your operational throughput dashboard.',hint:'COUNT(DISTINCT episode) AS tribals, COUNT(*) AS total_votes, ROUND(CAST(COUNT(*) AS FLOAT)/COUNT(DISTINCT episode),1) AS avg ‚Äî GROUP BY season.',answer:'SELECT season,\n  COUNT(DISTINCT episode) AS tribals,\n  COUNT(*) AS total_votes,\n  ROUND(CAST(COUNT(*) AS FLOAT)/COUNT(DISTINCT episode),1)\n    AS avg_votes_per_tribal\nFROM vote_history\nGROUP BY season\nORDER BY season;'},
 {id:'17.L2',title:'Chaos Detection ‚Äî Tie Votes',compound:true,challenge:'Find every tribal council where tie votes occurred. Show season, episode, total votes, tied votes, tie %, and flag high-tie tribals (>40% ties) as anomalies. (Compound: SUM + CASE + HAVING.)',hint:'SUM(tie) for tied votes. ROUND(100.0*SUM(tie)/COUNT(*),1) for pct. CASE WHEN pct>40 THEN flag.',answer:'SELECT season, episode,\n  COUNT(*) AS total_votes,\n  SUM(tie) AS tied_votes,\n  ROUND(100.0*SUM(tie)/COUNT(*),1) AS tie_pct,\n  CASE WHEN 100.0*SUM(tie)/COUNT(*) > 40\n    THEN \'üö® Anomaly\' ELSE \'‚úÖ Normal\'\n  END AS flag\nFROM vote_history\nGROUP BY season, episode\nHAVING SUM(tie) > 0\nORDER BY tie_pct DESC\nLIMIT 20;'},
],
18:[
 {id:'18.L1',title:'Player Segmentation',compound:false,challenge:'Segment all castaways by outcome: Winner, Runner-up, Jury Member, Eliminated. Show count and average placement for each segment ‚Äî your user segmentation dashboard.',hint:'CASE WHEN winner=1, finalist=1, jury=1, else Eliminated. GROUP BY segment, AVG(place).',answer:'SELECT\n  CASE\n    WHEN winner=1 THEN \'Winner\'\n    WHEN finalist=1 THEN \'Runner-up\'\n    WHEN jury=1 THEN \'Jury Member\'\n    ELSE \'Eliminated\'\n  END AS segment,\n  COUNT(*) AS count,\n  ROUND(AVG(place),1) AS avg_place,\n  ROUND(AVG(age),1) AS avg_age\nFROM castaways\nWHERE age IS NOT NULL\nGROUP BY segment\nORDER BY avg_place;'},
 {id:'18.L2',title:'Full Franchise KPI Dashboard',compound:true,challenge:'Build a single-row executive KPI dashboard for the entire Survivor franchise: total seasons, unique players, total episodes, avg viewers, peak viewers, best IMDB rating, and total tie votes. One query, one row. (Compound: multi-table subqueries.)',hint:'Each metric is a subquery: (SELECT COUNT(DISTINCT season) FROM season_summary), (SELECT MAX(viewers) FROM episodes), etc.',answer:'SELECT\n  (SELECT COUNT(DISTINCT season) FROM season_summary) AS total_seasons,\n  (SELECT COUNT(DISTINCT castaway_id) FROM castaways) AS unique_players,\n  (SELECT COUNT(*) FROM episodes) AS total_episodes,\n  (SELECT ROUND(AVG(viewers),1) FROM episodes) AS avg_viewers,\n  (SELECT MAX(viewers) FROM episodes) AS peak_viewers,\n  (SELECT MAX(imdb_rating) FROM episodes) AS best_imdb,\n  (SELECT SUM(tie) FROM vote_history) AS total_tie_votes;'},
],
};

// ===== STATE =====
let completed = JSON.parse(localStorage.getItem('ssq_done')||'{}');
let userQueries = JSON.parse(localStorage.getItem('ssq_queries')||'{}');
let wrongAttempts = JSON.parse(localStorage.getItem('ssq_wrong')||'{}');
let currentModule = null;
let apiKey = localStorage.getItem('ssq_apikey')||'';
const aiChats = {};

function save(){localStorage.setItem('ssq_done',JSON.stringify(completed));localStorage.setItem('ssq_queries',JSON.stringify(userQueries));localStorage.setItem('ssq_wrong',JSON.stringify(wrongAttempts));updateGlobal();}
function saveQ(k,v){userQueries[k]=v;localStorage.setItem('ssq_queries',JSON.stringify(userQueries));}

// ===== GLOBALS =====
function totalScenarios(){let t=0;MODULES.forEach(m=>{t+=m.scenarios.length;t+=(m.bonus||[]).length;});return t;}
function totalDone(){return Object.values(completed).filter(Boolean).length;}
function updateGlobal(){
  const t=totalScenarios(),d=totalDone();
  document.getElementById('globalFill').style.width=(t?Math.round(d/t*100):0)+'%';
  document.getElementById('globalCount').textContent=d+'/'+t;
  document.getElementById('subtitleText').textContent=`${MODULES.length} modules, ${t} scenarios. Click ü§ñ Ask AI Tutor on any scenario for help.`;
  renderTorches();
}
function modDone(mod){return mod.scenarios.every(s=>completed[mod.id+'-'+s.id]);}
function modProg(mod){let d=0;mod.scenarios.forEach(s=>{if(completed[mod.id+'-'+s.id])d++;});(mod.bonus||[]).forEach(s=>{if(completed[mod.id+'-'+s.id])d++;});return d;}
function modTotal(mod){return mod.scenarios.length+(mod.bonus||[]).length;}

// ===== TORCH TRACKER =====
function renderTorches(){
  const c=document.getElementById('torchTracker');
  c.innerHTML=MODULES.map(m=>{
    const done=modDone(m);
    const active=currentModule===m.id;
    return `<div class="torch-item" onclick="openModule(${m.id})" title="Module ${m.id}: ${m.title}">
      <span class="torch-flame ${done?'lit':''} ${active?'active':''}">${ICONS[m.id-1]}</span>
      <span class="torch-num mono ${done?'lit':''} ${active?'active':''}">${m.id}</span>
    </div>`;
  }).join('');
}

// ===== SYNTAX =====
function highlightSQL(code){
  return code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\b(SELECT|FROM|WHERE|AND|OR|ORDER BY|LIMIT|GROUP BY|HAVING|INNER JOIN|LEFT JOIN|CROSS JOIN|JOIN|ON|AS|CASE|WHEN|THEN|ELSE|END|IN|NOT|LIKE|DESC|ASC|WITH|PARTITION BY|OVER|RANK|SUM|COUNT|AVG|MAX|MIN|ROUND|DISTINCT|UNION)\b/gi,'<span class="kw">$1</span>')
    .replace(/'[^']*'/g,'<span class="str">$&</span>')
    .replace(/--.*$/gm,'<span class="cmt">$&</span>');
}
function codeBlockHTML(code,id){return `<div class="code-block"><button class="copy-btn" onclick="copyCode('${id}')">Copy</button><pre id="${id}">${highlightSQL(code)}</pre></div>`;}
function copyCode(id){const el=document.getElementById(id);navigator.clipboard.writeText(el.textContent).then(()=>{const b=el.parentElement.querySelector('.copy-btn');b.textContent='‚úì';b.classList.add('copied');setTimeout(()=>{b.textContent='Copy';b.classList.remove('copied');},1500);});}
function escapeHTML(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}

// ===== QUERY CHECKING =====
function normalizeSQL(s){return s.replace(/--.*$/gm,'').replace(/\s+/g,' ').replace(/[;\s]+$/,'').trim().toUpperCase();}

// Check if two WHERE clauses are equivalent ignoring AND/OR condition order
function queriesEquivalent(normUser, normAnswer) {
  // Extract WHERE clause conditions and compare sets
  function extractAndSortConditions(sql) {
    // Split on WHERE, take everything after
    const whereMatch = sql.match(/\bWHERE\b(.+?)(?:\bGROUP BY\b|\bORDER BY\b|\bHAVING\b|\bLIMIT\b|$)/);
    if (!whereMatch) return null;
    const clause = whereMatch[1].trim();
    // Split on AND (not inside parentheses)
    const conditions = splitOnTopLevelAnd(clause).map(c => {
      // Within each AND condition, also sort OR sub-conditions
      return splitOnTopLevelOr(c.trim()).map(s=>s.trim()).sort().join(' OR ');
    }).sort();
    return conditions;
  }

  function splitOnTopLevelAnd(s) {
    const parts = []; let depth = 0, cur = '';
    const tokens = s.split(/(\bAND\b)/i);
    for (let i = 0; i < tokens.length; i++) {
      if (/^AND$/i.test(tokens[i])) {
        if (depth === 0) { parts.push(cur.trim()); cur = ''; }
        else cur += tokens[i];
      } else {
        for (const ch of tokens[i]) {
          if (ch === '(') depth++;
          else if (ch === ')') depth--;
          cur += ch;
        }
      }
    }
    if (cur.trim()) parts.push(cur.trim());
    return parts;
  }

  function splitOnTopLevelOr(s) {
    const parts = []; let depth = 0, cur = '';
    const tokens = s.split(/(\bOR\b)/i);
    for (let i = 0; i < tokens.length; i++) {
      if (/^OR$/i.test(tokens[i])) {
        if (depth === 0) { parts.push(cur.trim()); cur = ''; }
        else cur += tokens[i];
      } else {
        for (const ch of tokens[i]) {
          if (ch === '(') depth++;
          else if (ch === ')') depth--;
          cur += ch;
        }
      }
    }
    if (cur.trim()) parts.push(cur.trim());
    return parts;
  }

  // Build a version of each query with sorted conditions and compare
  function replaceWhereWithSorted(sql, sortedConds) {
    if (!sortedConds) return sql;
    return sql.replace(/\bWHERE\b(.+?)(?=\bGROUP BY\b|\bORDER BY\b|\bHAVING\b|\bLIMIT\b|$)/, 'WHERE ' + sortedConds.join(' AND '));
  }

  const userConds = extractAndSortConditions(normUser);
  const answerConds = extractAndSortConditions(normAnswer);
  if (!userConds || !answerConds) return false;

  const normalizedUser = replaceWhereWithSorted(normUser, userConds);
  const normalizedAnswer = replaceWhereWithSorted(normAnswer, answerConds);
  return normalizedUser === normalizedAnswer;
}

function checkQuery(key, modId, scenarioId) {
  const mod = MODULES.find(m=>m.id===modId);
  const allS = [...mod.scenarios,...(mod.bonus||[])];
  const scenario = allS.find(s=>s.id===scenarioId);
  const userSQL = (document.getElementById('editor-'+key)?.value||'').trim();
  const fb = document.getElementById('feedback-'+key);
  if (!userSQL) { fb.innerHTML='<div class="feedback-box incorrect">Write a query first!</div>'; fb.classList.remove('hidden'); return; }

  const normUser = normalizeSQL(userSQL);
  const normAnswer = normalizeSQL(scenario.answer);
  const keywords = scenario.keywords || [];

  if (normUser === normAnswer || queriesEquivalent(normUser, normAnswer)) {
    fb.innerHTML='<div class="feedback-box correct">üéâ <strong>Correct!</strong> Your query matches perfectly. The tribe approves!</div>';
    fb.classList.remove('hidden');
    completed[key]=true; save();
    if(currentModule){
      // Surgically update only what changed ‚Äî no DOM rebuild, no scroll jump
      const scenarioEl = document.getElementById('scenario-'+key);
      if(scenarioEl){
        scenarioEl.classList.remove('wrong');
        scenarioEl.classList.add('done');
        const btn = scenarioEl.querySelector('.check-btn');
        if(btn){btn.classList.add('done');btn.textContent='‚úì';}
      }
      // Update module progress bar
      const mod2 = MODULES.find(m=>m.id===currentModule);
      if(mod2){
        const p=modProg(mod2),t=modTotal(mod2),pct=Math.round(p/t*100);
        const fill=document.querySelector('#module-detail-view .progress-fill');
        const count=document.querySelector('#module-detail-view .progress-count');
        if(fill) fill.style.width=pct+'%';
        if(count) count.textContent=p+'/'+t;
      }
      updateGlobal();
      // Check if module just became fully complete
      if(modDone(mod2||MODULES.find(m=>m.id===currentModule)) && !completed['celebration-'+currentModule]){
        completed['celebration-'+currentModule]=true; save();
        setTimeout(()=>showTribeSpoken(MODULES.find(m=>m.id===currentModule)),300);
      }
    }
    return;
  }

  // Check keywords
  let found=[], missing=[];
  keywords.forEach(kw => {
    if (normUser.includes(kw.toUpperCase())) found.push(kw);
    else missing.push(kw);
  });
  const pct = keywords.length ? Math.round(found.length/keywords.length*100) : 0;

  // Token-level diff: highlight wrong/missing tokens in user query
  function tokenize(sql) { return sql.trim().split(/\s+/); }
  function buildDiffHTML(userSQL, answerSQL) {
    const userTokens = tokenize(userSQL);
    const answerTokens = tokenize(answerSQL);
    // Build a set of answer tokens for lookup
    const answerSet = new Set(answerTokens);
    // For each user token, check if it exists anywhere in the answer
    return userTokens.map(tok => {
      const stripped = tok.replace(/[(),;]/g,'');
      if (!stripped) return `<span style="color:#c4b8a8">${tok}</span>`;
      if (answerSet.has(tok) || answerSet.has(stripped)) {
        return `<span style="color:#8fbc6f">${tok}</span>`;
      } else {
        return `<span style="background:rgba(192,57,43,.25);color:#e87878;border-radius:3px;padding:0 2px;text-decoration:underline">${tok}</span>`;
      }
    }).join(' ');
  }

  let html = '<div class="feedback-box incorrect">';
  if (pct >= 80) html += `<strong>So close!</strong> You've got ${pct}% of the key elements right.`;
  else if (pct >= 50) html += `<strong>Getting there!</strong> ${pct}% of key elements found.`;
  else html += `<strong>Keep going!</strong> Only ${pct}% of key elements found so far.`;

  // Show diff of user query with wrong parts highlighted
  html += `<div style="margin-top:10px;background:#1a1612;border-radius:6px;padding:10px 12px;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;border:1px solid #3a3228"><div style="font-size:9px;font-weight:700;color:#6a6258;letter-spacing:1px;margin-bottom:6px">YOUR QUERY ‚Äî <span style="color:#8fbc6f">‚úì correct</span> ¬∑ <span style="color:#e87878;text-decoration:underline">‚úó check these</span></div>${buildDiffHTML(normUser, normAnswer)}</div>`;

  if (found.length) html += `<div style="margin-top:8px"><strong style="color:#2e6b47">‚úì You got right:</strong> ${found.map(k=>`<span class="fb-line fb-right">${k}</span>`).join(' ')}</div>`;
  if (missing.length) html += `<div style="margin-top:6px"><strong style="color:#c0392b">‚úó Still needed:</strong> ${missing.map(k=>`<span class="fb-line fb-missing">${k}</span>`).join(' ')}</div>`;
  html += '</div>';
  fb.innerHTML = html;
  fb.classList.remove('hidden');

  // Track wrong attempts
  wrongAttempts[key] = (wrongAttempts[key]||0)+1;
  save();

  // If 3+ wrong attempts, offer extra practice
  if (wrongAttempts[key] >= 3 && !document.getElementById('extra-practice-'+key)) {
    const ep = document.createElement('div');
    ep.id = 'extra-practice-'+key;
    ep.style.cssText = 'margin-top:10px;padding:10px 14px;background:#fef0ee;border-radius:7px;border-left:3px solid #c0392b;font-size:13px;color:#7a1a1a';
    ep.innerHTML = `<strong>Struggling?</strong> Try breaking it down: what table do you need? (FROM), what columns? (SELECT), what filter? (WHERE). The AI Tutor can walk you through it step by step ‚Äî click ü§ñ above!`;
    fb.appendChild(ep);
  }
}

// ===== MODALS =====
function showModal(html){document.getElementById('modalContainer').innerHTML=html;}
function hideModal(){document.getElementById('modalContainer').innerHTML='';}

function showIntroModal(mod){
  showModal(`<div class="modal-overlay" onclick="if(event.target===this)hideModal()"><div class="modal-box">
    <div style="font-size:40px;margin-bottom:12px">${ICONS[mod.id-1]}</div>
    <h3>"Wanna know what you're<br>playing for?"</h3>
    <p style="font-size:13px;color:#8a7e70;margin-bottom:8px">MODULE ${mod.id} ‚Äî ${MOD_ICONS_DESC[mod.id-1]}</p>
    <p>${mod.intro}</p>
    <button class="modal-btn" onclick="hideModal()">Let's play! üî•</button>
  </div></div>`);
}

function showTribeSpoken(mod){
  const el=document.createElement('div');
  el.className='tribe-spoken-overlay';
  el.onclick=()=>el.remove();
  el.innerHTML=`<div class="tribe-flame-row">üî•üî•üî•</div><div class="tribe-spoken-text">"The tribe has spoken."</div><div class="tribe-spoken-sub">Module ${mod.id} complete: ${mod.title}</div><div style="margin-top:24px;font-size:14px;color:#6a6258;cursor:pointer">Click anywhere to continue</div>`;
  document.body.appendChild(el);
  setTimeout(()=>{if(el.parentNode)el.remove();},5000);
}

function checkModuleStruggle(mod){
  const wrongOnes=[];
  mod.scenarios.forEach(s=>{
    const k=mod.id+'-'+s.id;
    if(!completed[k] && (wrongAttempts[k]||0)>=2) wrongOnes.push(s);
  });
  if(wrongOnes.length >= Math.ceil(mod.scenarios.length/2)){
    showModal(`<div class="modal-overlay" onclick="if(event.target===this)hideModal()"><div class="modal-box">
      <div style="font-size:36px;margin-bottom:10px">üòî</div>
      <h3>"Got nothing for ya."</h3>
      <p>"Grab your stuff, head back to camp."<br><br>Let's revisit these scenarios:</p>
      <ul class="wrong-list">${wrongOnes.map(s=>`<li>Scenario ${s.id}: ${s.title}</li>`).join('')}</ul>
      <p style="font-size:13px">Try the hints and AI Tutor ‚Äî you've got this!</p>
      <button class="modal-btn" onclick="hideModal()">Back to camp üèïÔ∏è</button>
    </div></div>`);
  }
}

// ===== TABS =====
function switchTab(t){
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));
  ['lessons','tables','cheatsheet','playground','finale'].forEach(x=>document.getElementById('tab-'+x).classList.toggle('hidden',x!==t));
  if(t!=='lessons')currentModule=null;
  if(t==='lessons')renderModuleGrid();
  if(t==='playground')pgInit();
  if(t==='finale')ftcInit();
  renderTorches();window.scrollTo(0,0);
}

// ===== MODULE GRID =====
function renderModuleGrid(){
  document.getElementById('module-grid-view').classList.remove('hidden');
  document.getElementById('module-detail-view').classList.add('hidden');
  currentModule=null; renderTorches();
  document.getElementById('moduleGrid').innerHTML=MODULES.map(mod=>{
    const p=modProg(mod),t=modTotal(mod),d=modDone(mod),pct=Math.round(p/t*100);
    return `<div class="module-card ${d?'done':''}" onclick="openModule(${mod.id})">
      ${d?'<div class="badge mono">COMPLETE</div>':''}
      <div class="icon">${ICONS[mod.id-1]}</div>
      <div class="mod-label mono">MODULE ${mod.id} ‚Äî ${MOD_ICONS_DESC[mod.id-1].toUpperCase()}</div>
      <h3>${mod.title}</h3>
      <div class="count">${t} scenarios</div>
      <div class="progress-bar"><div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div><span class="progress-count mono">${p}/${t}</span></div>
    </div>`;
  }).join('');
}

// ===== MODULE DETAIL =====
function openModule(id){
  // If we're not on the lessons tab, switch to it first
  const lessonsTab=document.getElementById('tab-lessons');
  if(lessonsTab&&lessonsTab.classList.contains('hidden')){
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab==='lessons'));
    ['lessons','tables','cheatsheet','playground','finale'].forEach(x=>document.getElementById('tab-'+x).classList.toggle('hidden',x!=='lessons'));
  }
  const wasDone = modDone(MODULES.find(m=>m.id===id));
  currentModule=id;
  const mod=MODULES.find(m=>m.id===id);
  if(!wasDone && !completed['intro-'+id]){
    completed['intro-'+id]=true;
    showIntroModal(mod);
  }
  refreshModuleView();
}

function refreshModuleView(){
  const id=currentModule;
  const mod=MODULES.find(m=>m.id===id);
  document.getElementById('module-grid-view').classList.add('hidden');
  const detail=document.getElementById('module-detail-view');
  detail.classList.remove('hidden');
  renderTorches();

  const p=modProg(mod),t=modTotal(mod),pct=Math.round(p/t*100);
  let html=`<button class="back-btn" onclick="renderModuleGrid()">‚Üê All Modules</button>`;
  html+=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:6px"><span style="font-size:34px">${ICONS[mod.id-1]}</span><div><span class="mod-label mono" style="font-size:11px;color:#d4611e;font-weight:700;letter-spacing:1px">MODULE ${mod.id} ‚Äî ${MOD_ICONS_DESC[mod.id-1].toUpperCase()}</span><h2 style="margin:2px 0 0;font-size:22px">${mod.title}</h2></div></div>`;
  html+=`<div style="margin-bottom:14px"><div class="progress-bar"><div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div><span class="progress-count mono">${p}/${t}</span></div></div>`;
  html+=`<div class="concept-box"><div class="label mono">CORE CONCEPT</div><p>${mod.concept.text}</p>${codeBlockHTML(mod.concept.code,'concept-'+mod.id)}<p class="tip">üí° ${mod.concept.tip}</p></div>`;

  // Scenarios
  const renderScenario = (s, isBonus) => {
    const key=mod.id+'-'+s.id;
    const isDone=!!completed[key];
    const isWrong=!isDone&&(wrongAttempts[key]||0)>0;
    const tags=(s.tables||[]).map(tn=>{const ti=TABLES_INFO.find(x=>x.name===tn);const colPills=ti?ti.cols.split(',').map(c=>`<span class="ttc-col">${c.trim()}</span>`).join(''):'';return `<span class="table-tag mono">üìã ${tn}${ti?' ('+ti.rows+')':''}<div class="table-tag-cols"><div class="ttc-name">${tn} ‚Äî COLUMNS</div><div class="ttc-cols">${colPills}</div></div></span>`;}).join('');
    return `<div class="scenario ${isDone?'done':''} ${isWrong?'wrong':''}" id="scenario-${key}">
      <div class="scenario-top"><div><span class="s-label mono">${isBonus?'üó≥Ô∏è EXTRA VOTE':'SCENARIO'} ${s.id}</span><h4>${s.title}</h4></div>
        <button class="check-btn ${isDone?'done':''}" onclick="toggleDone('${key}')">${isDone?'‚úì':''}</button></div>
      <p class="question">${s.question}</p>
      <div class="table-tags">${tags}</div>
      <div style="margin-bottom:10px"><div class="editor-label mono">Your Query</div>
        <textarea class="sql-editor mono" id="editor-${key}" placeholder="Write your SQL here..." spellcheck="false" oninput="saveQ('${key}',this.value)">${userQueries[key]||''}</textarea></div>
      <div class="toggle-row">
        <button class="check-query-btn mono" onclick="checkQuery('${key}',${mod.id},'${s.id}')">‚ö° Check Query</button>
        <button class="hint-btn" onclick="togglePanel(this,'hint-${key}')">üí° Hint</button>
        <button class="answer-btn" onclick="togglePanel(this,'answer-${key}')">‚úÖ Answer</button>
        <button class="ai-toggle" onclick="toggleAI('${key}')">ü§ñ AI Tutor</button>
      </div>
      <div id="feedback-${key}" class="hidden"></div>
      <div id="hint-${key}" class="hidden"><div class="hint-box">üí° ${s.hint}</div></div>
      <div id="answer-${key}" class="hidden"><div class="answer-header">ANSWER</div>${codeBlockHTML(s.answer,'code-'+key)}</div>
      <div id="ai-${key}" class="hidden ai-section"><div class="ai-panel"><div class="ai-messages" id="ai-msgs-${key}"><div class="ai-msg system">Ask anything ‚Äî I'll guide without spoiling.</div></div>
        <div class="ai-input-row"><input class="ai-input" id="ai-input-${key}" placeholder="e.g. What does GROUP BY do here?" onkeydown="if(event.key==='Enter'){sendAI('${key}',${mod.id},'${s.id}');event.preventDefault()}">
        <button class="ai-send mono" id="ai-send-${key}" onclick="sendAI('${key}',${mod.id},'${s.id}')">Send</button></div></div></div>
    </div>`;
  };

  mod.scenarios.forEach(s=>{html+=renderScenario(s,false);});

  if(mod.bonus&&mod.bonus.length){
    html+=`<div class="bonus-section"><div class="bonus-title">üó≥Ô∏è Cast an Extra Vote ‚Äî Bonus Scenarios</div>`;
    mod.bonus.forEach(s=>{html+=renderScenario(s,true);});
    html+=`</div>`;
  }

  // Live Practice section
  const lqs=LIVE_QUESTIONS[mod.id]||[];
  if(lqs.length>0){
    html+=`<div class="live-section"><div class="live-title">üü¢ Live Practice &mdash; Real Queries on Real Survivor Data</div>`;
    lqs.forEach(q=>{
      const key=mod.id+'-'+q.id;
      html+=`<div class="live-q">
        <div class="live-q-label mono">${q.compound?'üîó COMPOUND CHALLENGE':'‚ö° FOCUSED PRACTICE'} &mdash; ${q.id}</div>
        <div class="live-q-title">${q.title}</div>
        <p class="live-challenge">${q.challenge}</p>
        <div style="margin-bottom:10px"><div class="editor-label mono">Your SQL</div>
          <textarea class="live-editor mono" id="live-editor-${key}" placeholder="Write your SQL here and click Run..." spellcheck="false"></textarea></div>
        <div class="toggle-row">
          <button class="live-run-btn mono" id="live-run-btn-${key}" onclick="liveRun('${key}')">‚ñ∂ Run Query</button>
          <button class="live-hint-btn" onclick="toggleLivePanel(this,'live-hint-${key}')">üí° Hint</button>
          <button class="live-answer-btn" onclick="toggleLivePanel(this,'live-answer-${key}')">‚úÖ Reference Answer</button>
        </div>
        <div id="live-hint-${key}" class="hidden"><div class="hint-box">üí° ${q.hint}</div></div>
        <div id="live-answer-${key}" class="hidden"><div class="answer-header">REFERENCE ANSWER</div>`+codeBlockHTML(q.answer,'live-code-'+key)+`</div>
        <div class="live-results-box" id="live-results-box-${key}">
          <div class="live-results-hdr">
            <span class="live-results-lbl mono">RESULTS</span>
            <span class="live-results-ct" id="live-results-ct-${key}" style="display:none"></span>
            <span class="live-results-ms" id="live-results-ms-${key}" style="display:none"></span>
          </div>
          <div class="live-results-body" id="live-results-body-${key}"></div>
        </div>
      </div>`;
    });
    html+=`</div>`;
  }

  html+=`<div class="mod-nav">`;
  if(id>1)html+=`<button class="prev" onclick="openModule(${id-1})">‚Üê Module ${id-1}</button>`;else html+=`<div></div>`;
  if(id<MODULES.length)html+=`<button class="next" onclick="openModule(${id+1})">Module ${id+1} ‚Üí</button>`;else html+=`<div></div>`;
  html+=`</div>`;
  detail.innerHTML=html;
  window.scrollTo(0,0);

  // Check if just completed
  if(modDone(mod) && !completed['celebration-'+mod.id]){
    completed['celebration-'+mod.id]=true;save();
    setTimeout(()=>showTribeSpoken(mod),300);
  }
  // Check struggle
  checkModuleStruggle(mod);
}

function toggleDone(key){
  completed[key]=!completed[key]; save();
  if(currentModule){
    const isDone=!!completed[key];
    // Surgically update scenario card
    const scenarioEl=document.getElementById('scenario-'+key);
    if(scenarioEl){
      scenarioEl.classList.toggle('done',isDone);
      scenarioEl.classList.remove('wrong');
      const btn=scenarioEl.querySelector('.check-btn');
      if(btn){btn.classList.toggle('done',isDone);btn.textContent=isDone?'‚úì':'';}
      // Remove existing badge if unchecking
      const badge=scenarioEl.querySelector('.badge');
      if(badge)badge.remove();
    }
    // Update progress bar
    const mod2=MODULES.find(m=>m.id===currentModule);
    if(mod2){
      const p=modProg(mod2),t=modTotal(mod2),pct=Math.round(p/t*100);
      const fill=document.querySelector('#module-detail-view .progress-fill');
      const count=document.querySelector('#module-detail-view .progress-count');
      if(fill)fill.style.width=pct+'%';
      if(count)count.textContent=p+'/'+t;
      updateGlobal();
      if(modDone(mod2)&&!completed['celebration-'+mod2.id]){
        completed['celebration-'+mod2.id]=true;save();
        setTimeout(()=>showTribeSpoken(mod2),300);
      }
    }
  } else { renderModuleGrid(); }
}
function togglePanel(btn,id){const p=document.getElementById(id);const h=p.classList.contains('hidden');p.classList.toggle('hidden');btn.classList.toggle('open',h);}
function toggleAI(key){
  const p=document.getElementById('ai-'+key);p.classList.toggle('hidden');
  const sc=p.closest('.scenario');if(sc){const b=sc.querySelector('.ai-toggle');if(b)b.classList.toggle('open',!p.classList.contains('hidden'));}
  if(!p.classList.contains('hidden')&&!apiKey){const m=document.getElementById('ai-msgs-'+key);if(!m.querySelector('.ai-msg.error'))m.innerHTML+='<div class="ai-msg error">‚öôÔ∏è Add your API key via the gear icon (‚öôÔ∏è) in the nav bar.</div>';}
}

// ===== API KEY =====
document.getElementById('apiKeyInput').value=apiKey?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢'+apiKey.slice(-4):'';
function toggleApiBar(){document.getElementById('apiBar').classList.toggle('hidden');if(!document.getElementById('apiBar').classList.contains('hidden'))document.getElementById('apiKeyInput').value=apiKey||'';}
function saveApiKey(){const v=document.getElementById('apiKeyInput').value.trim();if(v&&!v.startsWith('‚Ä¢‚Ä¢')){apiKey=v;localStorage.setItem('ssq_apikey',apiKey);document.getElementById('apiKeyInput').value='‚Ä¢‚Ä¢‚Ä¢‚Ä¢'+apiKey.slice(-4);const st=document.getElementById('apiStatus');st.textContent='‚úì Saved';setTimeout(()=>st.textContent='',2000);}}

// ===== AI TUTOR =====
function getSchema(tables){return tables.map(n=>{const t=TABLES_INFO.find(ti=>ti.name===n);return t?`${t.name} (${t.rows} rows): ${t.cols}`:n;}).join('\n');}

async function sendAI(key,modId,scenarioId){
  if(!apiKey){toggleApiBar();return;}
  const mod=MODULES.find(m=>m.id===modId);
  const allS=[...mod.scenarios,...(mod.bonus||[])];
  const scenario=allS.find(s=>s.id===scenarioId);
  const input=document.getElementById('ai-input-'+key);
  const msgs=document.getElementById('ai-msgs-'+key);
  const btn=document.getElementById('ai-send-'+key);
  const userText=input.value.trim();if(!userText)return;
  const userSQL=document.getElementById('editor-'+key)?.value||'';

  if(!aiChats[key])aiChats[key]=[];
  aiChats[key].push({role:'user',content:userText});
  msgs.innerHTML+=`<div class="ai-msg user">${escapeHTML(userText)}</div>`;
  input.value='';btn.disabled=true;btn.textContent='...';msgs.scrollTop=msgs.scrollHeight;

  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:600,
        system:`You're a friendly SQL tutor using Survivor data. SCENARIO ${scenario.id}: ${scenario.question}\n\nTABLES:\n${getSchema(scenario.tables||[])}\n\nCORRECT ANSWER (never reveal directly):\n${scenario.answer}\n\n${userSQL?"STUDENT'S ATTEMPT:\n"+userSQL:"No attempt yet."}\n\nRULES: Guide without giving the full answer. If they share a query, say what's right and pinpoint what to fix. Be concise (2-5 sentences), encouraging, and use Survivor references. Show small SQL fragments but not complete solutions.`,
        messages:aiChats[key]})});
    if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.error?.message||'API error '+res.status);}
    const data=await res.json();
    const reply=data.content.map(b=>b.text||'').join('');
    aiChats[key].push({role:'assistant',content:reply});
    msgs.innerHTML+=`<div class="ai-msg assistant">${escapeHTML(reply)}</div>`;
  }catch(e){msgs.innerHTML+=`<div class="ai-msg error">‚ö†Ô∏è ${escapeHTML(e.message)}</div>`;aiChats[key].pop();}
  btn.disabled=false;btn.textContent='Send';msgs.scrollTop=msgs.scrollHeight;
}

// ===== TABLES TAB =====
document.getElementById('tablesContainer').innerHTML=TABLES_INFO.map(t=>`<div class="table-card"><div style="display:flex;justify-content:space-between;align-items:baseline;flex-wrap:wrap;gap:6px;margin-bottom:5px"><span class="table-name mono">${t.name}</span><span class="table-rows mono">${t.rows} rows</span></div><p class="table-desc">${t.desc}</p><div class="table-cols mono">${t.cols}</div></div>`).join('');

// ===== CHEAT SHEET =====
let ch=`<div class="cheat-table"><div class="cheat-header"><span class="mono">KEYWORD</span><span class="mono">WHAT IT DOES</span><span class="mono">EXAMPLE</span></div>`;
CHEAT.forEach(r=>{ch+=`<div class="cheat-row"><span class="cheat-kw mono">${r[0]}</span><span class="cheat-does">${r[1]}</span><span class="cheat-ex mono">${r[2]}</span></div>`;});
ch+=`</div><div class="ops-box"><div class="ops-label mono">QUERY ORDER OF OPERATIONS</div><p>SQL clauses must appear in this order:</p><div class="ops-flow">`;
["SELECT","FROM","JOIN","WHERE","GROUP BY","HAVING","ORDER BY","LIMIT"].forEach((k,i,a)=>{ch+=`<span class="ops-kw mono">${k}</span>`;if(i<a.length-1)ch+=`<span class="ops-arrow">‚Üí</span>`;});
ch+=`</div></div>`;
document.getElementById('cheatContainer').innerHTML=ch;

// ===== PLAYGROUND =====
let pgDB = null;
let pgReady = false;
let pgInitStarted = false;

const PG_TABLES = [
  {name:'advantage_details',     cols:'version, version_season, season, advantage_id, advantage_type, clue_details, location_found, conditions'},
  {name:'advantage_movement',    cols:'version, version_season, season, castaway, castaway_id, advantage_id, sequence_id, day, episode, event, played_for, played_for_id, success, votes_nullified, sog_id'},
  {name:'auction_details',       cols:'version, version_season, season, item, item_description, category, castaway, castaway_id, cost, covered, money_remaining, auction_num, participated, notes'},
  {name:'boot_mapping',          cols:'version, version_season, season, episode, order, n_boots, final_n, sog_id, castaway_id, castaway, tribe, tribe_status, game_status'},
  {name:'boot_order',            cols:'version, version_season, season, castaway_id, castaway, episode, day, order, result'},
  {name:'castaway_details',      cols:'castaway_id, full_name, full_name_detailed, castaway, last_name, date_of_birth, date_of_death, gender, african, asian, latin_american, native_american, bipoc, lgbt, personality_type, occupation, collar'},
  {name:'castaway_scores',       cols:'version, version_season, season, castaway, castaway_id, score_overall, score_outwit, score_outplay, score_outlast, score_result, score_jury, score_vote, score_adv, score_inf'},
  {name:'castaways',             cols:'version, version_season, season, full_name, castaway_id, castaway, age, city, state, episode, day, order, result, jury_status, place, original_tribe, jury, finalist, winner'},
  {name:'challenge_description', cols:'version, version_season, season, episode, challenge_id, challenge_number, challenge_type, name, recurring_name, description, reward, balance, endurance, fire, puzzle, race, strength, water'},
  {name:'challenge_results',     cols:'version, version_season, season, episode, castaway_id, castaway, tribe, tribe_status, challenge_type, outcome_type, result, result_notes, chosen_for_reward, sit_out, order_of_finish, won'},
  {name:'challenge_summary',     cols:'category, version, version_season, season, episode, castaway_id, castaway, tribe, challenge_type, outcome_type, challenge_id, sog_id, won, n_entities, n_winners'},
  {name:'confessionals',         cols:'version, version_season, season, episode, castaway, castaway_id, confessional_count, confessional_time, exp_count, exp_time'},
  {name:'episodes',              cols:'version, version_season, season, episode_number_overall, episode, episode_title, episode_label, episode_date, episode_length, viewers, imdb_rating, n_ratings, episode_summary'},
  {name:'journeys',              cols:'version, season, version_season, episode, sog_id, castaway_id, castaway, reward, lost_vote, game_played, chose_to_play, event'},
  {name:'jury_votes',            cols:'version, version_season, season, castaway, finalist, vote, castaway_id, finalist_id'},
  {name:'season_palettes',       cols:'version, version_season, season, palette'},
  {name:'season_summary',        cols:'version, version_season, season_name, season, location, country, tribe_setup, n_cast, n_tribes, n_finalists, n_jury, full_name, winner_id, winner, runner_ups, final_vote, timeslot, premiered, ended, viewers_mean'},
  {name:'survivor_auction',      cols:'version, version_season, season, episode, n_boots, castaway_id, castaway, tribe, tribe_status, total, currency'},
  {name:'tribe_colours',         cols:'version, version_season, season, tribe, tribe_colour, tribe_status'},
  {name:'tribe_mapping',         cols:'version, version_season, season, episode, day, castaway_id, castaway, tribe, tribe_status'},
  {name:'viewers',               cols:'version, version_season, season, episode_number_overall, episode, episode_title, episode_date, episode_length, viewers, imdb_rating, n_ratings'},
  {name:'vote_history',          cols:'version, version_season, season, episode, day, tribe_status, tribe, castaway, immunity, vote, vote_event, vote_event_outcome, split_vote, nullified, tie, voted_out, order, vote_order, castaway_id, vote_id, voted_out_id'},
];

function pgInit(){
  if(pgInitStarted) return;
  pgInitStarted = true;
  pgRenderTableChips();
  pgLoadDB();
}

async function pgLoadDB(){
  const dot = document.getElementById('pg-status-dot');
  const statusText = document.getElementById('pg-status-text');
  const loadingMsg = document.getElementById('pg-loading-msg');
  const loadingBar = document.getElementById('pg-loading-bar');
  try {
    loadingMsg.textContent = 'Initializing sql.js...';
    loadingBar.style.width = '10%';
    const SQL = await initSqlJs({
      locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
    });
    loadingMsg.textContent = 'Downloading survivor.db...';
    loadingBar.style.width = '20%';
    const response = await fetch('/survivor.db');
    if(!response.ok) throw new Error(`HTTP ${response.status}: Could not load survivor.db`);
    const contentLength = response.headers.get('Content-Length');
    let buffer;
    if(contentLength){
      const total = parseInt(contentLength, 10);
      const reader = response.body.getReader();
      let received = 0;
      const chunks = [];
      while(true){
        const {done, value} = await reader.read();
        if(done) break;
        chunks.push(value);
        received += value.length;
        const pct = Math.round(20 + (received/total)*70);
        loadingBar.style.width = pct + '%';
        loadingMsg.textContent = `Downloading... ${(received/1024/1024).toFixed(1)} MB / ${(total/1024/1024).toFixed(1)} MB`;
      }
      const full = new Uint8Array(received);
      let offset = 0;
      for(const chunk of chunks){ full.set(chunk, offset); offset += chunk.length; }
      buffer = full;
    } else {
      loadingMsg.textContent = 'Downloading survivor.db...';
      buffer = new Uint8Array(await response.arrayBuffer());
      loadingBar.style.width = '90%';
    }
    loadingMsg.textContent = 'Opening database...';
    loadingBar.style.width = '95%';
    pgDB = new SQL.Database(buffer);
    loadingBar.style.width = '100%';
    pgReady = true;
    document.getElementById('pg-loading-overlay').classList.add('hidden');
    document.getElementById('pg-main').classList.remove('hidden');
    dot.className = 'pg-status-dot ready';
    statusText.textContent = 'Database ready ‚Äî ' + PG_TABLES.length + ' tables loaded';
  } catch(err){
    loadingMsg.textContent = 'Error: ' + err.message;
    loadingBar.style.background = '#c0392b';
    dot.className = 'pg-status-dot error';
    statusText.textContent = 'Failed to load database';
    console.error('[Playground] DB load error:', err);
  }
}

function pgRenderTableChips(){
  const container = document.getElementById('pg-table-chips');
  if(!container) return;
  container.innerHTML = PG_TABLES.map(t =>
    `<span class="pg-table-chip mono" onclick="pgShowTableDetail('${t.name}')">${t.name}</span>`
  ).join('');
}

function pgInsertTable(tableName){
  const ed = document.getElementById('pg-editor');
  const cur = ed.selectionStart;
  const val = ed.value;
  ed.value = val.slice(0, cur) + tableName + val.slice(cur);
  ed.selectionStart = ed.selectionEnd = cur + tableName.length;
  ed.focus();
}

function pgShowTableDetail(tableName){
  const t = PG_TABLES.find(x => x.name === tableName);
  if(!t) return;
  const cols = t.cols.split(', ');
  const overlay = document.getElementById('pg-modal-overlay');
  document.getElementById('pg-modal-title').textContent = tableName;
  document.getElementById('pg-modal-subtitle').textContent = cols.length + ' columns';

  // Build column pills
  let html = '<div class="pg-modal-section-label mono">COLUMNS</div>';
  html += '<div class="pg-col-grid">' + cols.map(c => `<span class="pg-col-pill">${pgEsc(c)}</span>`).join('') + '</div>';

  // Sample rows ‚Äî only available once DB is loaded
  if(pgReady && pgDB){
    try {
      const result = pgDB.exec(`SELECT * FROM "${tableName}" LIMIT 5`);
      if(result && result.length > 0){
        const {columns, values} = result[0];
        html += '<div class="pg-modal-section-label mono">SAMPLE DATA (first 5 rows)</div>';
        html += '<div style="overflow-x:auto"><table class="pg-table" style="margin:0"><thead><tr>';
        columns.forEach(c => { html += `<th class="mono">${pgEsc(c)}</th>`; });
        html += '</tr></thead><tbody>';
        values.forEach(row => {
          html += '<tr>';
          row.forEach(cell => {
            if(cell === null || cell === undefined) html += '<td><span class="pg-null-cell">NULL</span></td>';
            else html += `<td title="${pgEsc(String(cell))}">${pgEsc(String(cell))}</td>`;
          });
          html += '</tr>';
        });
        html += '</tbody></table></div>';
      }
    } catch(e){ /* silently skip sample if error */ }
  } else {
    html += '<div style="padding:12px 18px;font-size:12px;color:var(--gray)">Load the database to see sample rows.</div>';
  }

  html += `<div style="padding:12px 18px 16px"><button class="pg-modal-use-btn mono" onclick="pgCloseModal();pgInsertTable('${tableName}')">Insert table name into editor ‚Üó</button></div>`;

  document.getElementById('pg-modal-body').innerHTML = html;
  overlay.classList.add('visible');
}

function pgCloseModal(){
  document.getElementById('pg-modal-overlay').classList.remove('visible');
}

function pgHandleKey(e){
  if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
    e.preventDefault();
    pgRun();
    return;
  }
  if(e.key === 'Tab'){
    e.preventDefault();
    const ed = e.target;
    const s = ed.selectionStart, en = ed.selectionEnd;
    ed.value = ed.value.slice(0,s) + '  ' + ed.value.slice(en);
    ed.selectionStart = ed.selectionEnd = s + 2;
  }
}

function pgClear(){
  document.getElementById('pg-editor').value = '';
  document.getElementById('pg-results-body').innerHTML = '<div class="pg-placeholder">Run a query to see results here.</div>';
  document.getElementById('pg-results-count').style.display = 'none';
  document.getElementById('pg-results-time').style.display = 'none';
  document.getElementById('pg-rows-meta').style.display = 'none';
  document.getElementById('pg-time-meta').style.display = 'none';
}

function pgRun(){
  if(!pgReady || !pgDB){ alert('Database is still loading. Please wait.'); return; }
  const sql = document.getElementById('pg-editor').value.trim();
  if(!sql) return;
  const runBtn = document.getElementById('pg-run-btn');
  const dot = document.getElementById('pg-status-dot');
  const statusText = document.getElementById('pg-status-text');
  runBtn.disabled = true;
  dot.className = 'pg-status-dot loading';
  statusText.textContent = 'Running...';
  setTimeout(() => {
    const t0 = performance.now();
    try {
      const results = pgDB.exec(sql);
      const elapsed = parseFloat((performance.now() - t0).toFixed(1));
      pgRenderResults(results, elapsed);
      dot.className = 'pg-status-dot ready';
      statusText.textContent = 'Query complete';
      const rowCount = results && results.length > 0 ? results.reduce((s,r) => s + r.values.length, 0) : 0;
      pgAddHistory(sql, elapsed, rowCount, null);
    } catch(err){
      const elapsed = parseFloat((performance.now() - t0).toFixed(1));
      pgRenderError(err.message);
      dot.className = 'pg-status-dot error';
      statusText.textContent = 'Query error';
      pgAddHistory(sql, elapsed, null, err.message);
    } finally {
      runBtn.disabled = false;
    }
  }, 10);
}

// ===== QUERY HISTORY =====
let pgHistory = JSON.parse(localStorage.getItem('ssq_pg_history') || '[]');

function pgSummarizeQuery(sql){
  // Produce a plain-English one-liner describing what the query does
  const s = sql.replace(/\s+/g,' ').trim();
  const upper = s.toUpperCase();

  // Extract the first table name after FROM
  const fromMatch = s.match(/FROM\s+["']?(\w+)["']?/i);
  const table = fromMatch ? fromMatch[1] : null;
  const tableNice = table ? table.replace(/_/g,' ') : null;

  // Detect key clauses
  const hasWhere   = /\bWHERE\b/i.test(s);
  const hasGroup   = /\bGROUP BY\b/i.test(s);
  const hasOrder   = /\bORDER BY\b/i.test(s);
  const hasLimit   = /\bLIMIT\b/i.test(s);
  const hasJoin    = /\bJOIN\b/i.test(s);
  const hasAgg     = /\b(COUNT|SUM|AVG|MAX|MIN)\s*\(/i.test(s);
  const hasWith    = /^\s*WITH\b/i.test(s);
  const isSelect   = /^\s*(WITH\b.*)?SELECT\b/i.test(s);

  // Extract SELECT columns (rough)
  const selMatch = s.match(/SELECT\s+(.*?)\s+FROM/i);
  const selPart = selMatch ? selMatch[1].trim() : '';
  const isStar = selPart === '*' || selPart.endsWith('.*');

  // What are they selecting?
  let what = isStar ? 'all columns' : (selPart.length < 60 ? selPart : 'selected columns');

  // Build summary sentence
  if(!isSelect){
    // Non-SELECT: just echo first few words
    return s.slice(0,80) + (s.length > 80 ? '‚Ä¶' : '');
  }

  let parts = [];
  if(hasAgg && hasGroup) parts.push('aggregated data');
  else if(hasAgg) parts.push('calculated aggregate values');
  else parts.push('fetched ' + what);

  if(tableNice) parts.push('from ' + tableNice);
  if(hasJoin)   parts.push('with a join');
  if(hasWhere)  parts.push('with filters');
  if(hasGroup)  parts.push('grouped');
  if(hasOrder)  parts.push('sorted');
  if(hasLimit){
    const limMatch = s.match(/LIMIT\s+(\d+)/i);
    if(limMatch) parts.push('limited to ' + limMatch[1] + ' rows');
  }
  if(hasWith)   parts.unshift('CTE query ‚Äî');

  let summary = parts.join(' ');
  return summary.charAt(0).toUpperCase() + summary.slice(1);
}

function pgAddHistory(sql, elapsed, rowCount, errorMsg){
  const now = new Date();
  const entry = {
    ts: now.toISOString(),
    sql: sql,
    summary: pgSummarizeQuery(sql),
    elapsed,
    rowCount,
    error: errorMsg || null
  };
  pgHistory.unshift(entry); // newest first
  if(pgHistory.length > 50) pgHistory = pgHistory.slice(0, 50); // cap at 50
  localStorage.setItem('ssq_pg_history', JSON.stringify(pgHistory));
  pgRenderHistory();
}

function pgRenderHistory(){
  const body = document.getElementById('pg-history-body');
  const empty = document.getElementById('pg-history-empty');
  if(!body) return;
  if(pgHistory.length === 0){
    if(empty) empty.style.display = '';
    // Remove any existing items
    body.querySelectorAll('.pg-history-item').forEach(el => el.remove());
    return;
  }
  if(empty) empty.style.display = 'none';

  // Re-render all items
  const existing = body.querySelectorAll('.pg-history-item');
  existing.forEach(el => el.remove());

  pgHistory.forEach((entry, idx) => {
    const d = new Date(entry.ts);
    const dateStr = d.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    const timeStr = d.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true});

    const isError = !!entry.error;
    const metaText = isError
      ? '<span style="color:#c0392b">Error</span>'
      : (entry.rowCount !== null ? entry.rowCount + ' row' + (entry.rowCount === 1 ? '' : 's') + ' ¬∑ ' + entry.elapsed.toFixed(1) + 'ms' : entry.elapsed.toFixed(1) + 'ms');

    const item = document.createElement('div');
    item.className = 'pg-history-item';
    item.innerHTML = `
      <div class="pg-history-time mono">${dateStr}<br>${timeStr}</div>
      <div>
        <div class="pg-history-summary">${pgEsc(entry.summary)}</div>
        <div class="pg-history-sql mono">${pgEsc(entry.sql.replace(/\n/g,' '))}</div>
      </div>
      <div class="pg-history-meta">
        ${metaText}
        <span class="pg-history-rerun" onclick="pgRerunHistory(${idx})">Re-run ‚Üó</span>
      </div>`;
    body.appendChild(item);
  });
}

function pgRerunHistory(idx){
  const entry = pgHistory[idx];
  if(!entry) return;
  document.getElementById('pg-editor').value = entry.sql;
  pgRun();
  // Scroll to top so user sees results
  document.getElementById('pg-editor').scrollIntoView({behavior:'smooth', block:'center'});
}

function pgToggleHistory(){
  const body = document.getElementById('pg-history-body');
  const caret = document.getElementById('pg-history-caret');
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  caret.classList.toggle('open', !isOpen);
}

function pgClearHistory(e){
  e.stopPropagation(); // don't also toggle the section
  pgHistory = [];
  localStorage.removeItem('ssq_pg_history');
  pgRenderHistory();
}

function pgRenderResults(results, elapsed){
  const body = document.getElementById('pg-results-body');
  const countEl = document.getElementById('pg-results-count');
  const timeEl = document.getElementById('pg-results-time');
  const rowsMeta = document.getElementById('pg-rows-meta');
  const timeMeta = document.getElementById('pg-time-meta');
  if(!results || results.length === 0){
    body.innerHTML = '<div class="pg-placeholder">Query ran successfully ‚Äî no rows returned.</div>';
    countEl.style.display = 'none'; timeEl.style.display = 'none';
    rowsMeta.style.display = 'none'; timeMeta.style.display = 'none';
    return;
  }
  let html = ''; let totalRows = 0;
  const MAX_ROWS = 1000;
  results.forEach((result, idx) => {
    const {columns, values} = result;
    totalRows += values.length;
    if(results.length > 1) html += `<div style="padding:6px 12px;font-size:10px;color:var(--gray);font-weight:700;letter-spacing:1px;background:var(--light-bg)">RESULT SET ${idx+1}</div>`;
    html += '<table class="pg-table"><thead><tr>';
    columns.forEach(col => { html += `<th class="mono">${pgEsc(col)}</th>`; });
    html += '</tr></thead><tbody>';
    values.slice(0, MAX_ROWS).forEach(row => {
      html += '<tr>';
      row.forEach(cell => {
        if(cell === null || cell === undefined) html += '<td><span class="pg-null-cell">NULL</span></td>';
        else html += `<td title="${pgEsc(String(cell))}">${pgEsc(String(cell))}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    if(values.length > MAX_ROWS) html += `<div style="padding:8px 12px;font-size:11px;color:var(--gray);background:var(--light-bg)">Showing first ${MAX_ROWS} of ${values.length} rows.</div>`;
  });
  body.innerHTML = html;
  countEl.textContent = totalRows + (totalRows === 1 ? ' row' : ' rows');
  countEl.style.display = '';
  timeEl.textContent = elapsed.toFixed(1) + 'ms';
  timeEl.style.display = '';
  document.getElementById('pg-row-count').textContent = totalRows;
  rowsMeta.style.display = '';
  document.getElementById('pg-exec-time').textContent = elapsed.toFixed(1) + 'ms';
  timeMeta.style.display = '';
}

function pgRenderError(message){
  document.getElementById('pg-results-body').innerHTML = `<div class="pg-error-box">Error: ${pgEsc(message)}</div>`;
  document.getElementById('pg-results-count').style.display = 'none';
  document.getElementById('pg-results-time').style.display = 'none';
  document.getElementById('pg-rows-meta').style.display = 'none';
  document.getElementById('pg-time-meta').style.display = 'none';
}

function pgEsc(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== LIVE PRACTICE ENGINE =====
async function ensureDBReady(){
  if(pgReady && pgDB) return pgDB;
  if(!pgInitStarted){
    pgInitStarted=true;
    const SQL=await initSqlJs({locateFile:f=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`});
    const resp=await fetch('/survivor.db');
    if(!resp.ok) throw new Error('Could not load survivor.db');
    const buf=new Uint8Array(await resp.arrayBuffer());
    pgDB=new SQL.Database(buf);
    pgReady=true;
  } else {
    await new Promise(resolve=>{const iv=setInterval(()=>{if(pgReady){clearInterval(iv);resolve();}},150);});
  }
  return pgDB;
}

async function liveRun(key){
  const editor=document.getElementById('live-editor-'+key);
  const btn=document.getElementById('live-run-btn-'+key);
  const box=document.getElementById('live-results-box-'+key);
  const ctEl=document.getElementById('live-results-ct-'+key);
  const msEl=document.getElementById('live-results-ms-'+key);
  const body=document.getElementById('live-results-body-'+key);
  const sql=(editor.value||'').trim();
  if(!sql) return;
  btn.disabled=true;
  box.classList.add('visible');
  body.innerHTML='<div style="padding:18px;text-align:center;color:#4a7a5a;font-size:13px">‚è≥ Loading database...</div>';
  ctEl.style.display='none'; msEl.style.display='none';
  try{
    const db=await ensureDBReady();
    const t0=performance.now();
    const results=db.exec(sql);
    const ms=parseFloat((performance.now()-t0).toFixed(1));
    renderLiveResults(body,ctEl,msEl,results,ms);
  }catch(err){
    body.innerHTML=`<div class="pg-error-box">Error: ${pgEsc(err.message)}</div>`;
    ctEl.style.display='none'; msEl.style.display='none';
  }finally{
    btn.disabled=false;
  }
}

function renderLiveResults(body,ctEl,msEl,results,ms){
  if(!results||results.length===0){
    body.innerHTML='<div style="padding:14px;text-align:center;color:#4a7a5a;font-size:13px">Query ran ‚Äî no rows returned.</div>';
    ctEl.style.display='none'; msEl.style.display='none'; return;
  }
  let html=''; let total=0;
  results.forEach(r=>{
    const {columns,values}=r; total+=values.length;
    html+='<table class="pg-table"><thead><tr>';
    columns.forEach(c=>{html+=`<th class="mono">${pgEsc(c)}</th>`;});
    html+='</tr></thead><tbody>';
    values.slice(0,200).forEach(row=>{
      html+='<tr>';
      row.forEach(cell=>{
        if(cell===null||cell===undefined) html+='<td><span class="pg-null-cell">NULL</span></td>';
        else html+=`<td title="${pgEsc(String(cell))}">${pgEsc(String(cell))}</td>`;
      });
      html+='</tr>';
    });
    html+='</tbody></table>';
    if(values.length>200) html+=`<div style="padding:6px 12px;font-size:11px;color:#4a7a5a">Showing first 200 of ${values.length} rows.</div>`;
  });
  body.innerHTML=html;
  ctEl.textContent=total+(total===1?' row':' rows'); ctEl.style.display='';
  msEl.textContent=ms+'ms'; msEl.style.display='';
}

function toggleLivePanel(btn,id){
  const el=document.getElementById(id);
  const nowHidden=el.classList.toggle('hidden');
  btn.classList.toggle('open',!nowHidden);
}

// ===== FINAL TRIBAL COUNCIL =====
const FTC_TORCH_COLORS = ['#d4611e','#e8943e','#2e6b47','#6ab57a','#c4b8a8','#8a7e70'];

// Survivor-themed chart color palette
const FTC_PALETTE = [
  '#d4611e','#e8943e','#f5c97a',  // torch / amber
  '#2e6b47','#6ab57a','#a8d8b8',  // jungle greens
  '#8a7060','#c4b8a8','#f5e6cc',  // sand / neutral
  '#1a3a5c','#3b7ab5','#7ab5e8',  // ocean blues
];

let ftcDB = null;
let ftcInitStarted = false;
let ftcCurrentPhase = 1;
let ftcChartInstances = {}; // phase -> Chart instance
let ftcChartTypes = {1:'bar', 3:'bar'};
let ftcResultData = {}; // phase -> {columns, rows}

// Jury questions ‚Äî 3 questions requiring specific SQL techniques
const FTC_JURY = [
  {
    juror:'üßë‚Äç‚öñÔ∏è', name:'Jury Member 1 ‚Äî The Stats Nerd',
    role:'Former data analyst, eliminated at final 5',
    question:'"You keep talking about domination. Prove it. Give me the top 5 seasons by average IMDB rating ‚Äî with a GROUP BY."',
    hint:'SELECT season, AVG(imdb_rating) AS avg_rating FROM episodes GROUP BY season ORDER BY avg_rating DESC LIMIT 5;',
    validate: (sql) => {
      const s = sql.toUpperCase();
      return s.includes('GROUP BY') && s.includes('AVG') && (s.includes('IMDB') || s.includes('RATING')) && s.includes('LIMIT');
    }
  },
  {
    juror:'üë©‚Äç‚öñÔ∏è', name:'Jury Member 2 ‚Äî The Alliance Queen',
    role:'Social player, pulled off 3 blindsides',
    question:'"I want to know about relationships. Show me which castaways played together more than once ‚Äî that\'s your real alliance. Use a JOIN."',
    hint:'Join castaways to castaway_details on castaway_id, or self-join castaways to find repeat players with COUNT(*) > 1 GROUP BY castaway_id.',
    validate: (sql) => {
      const s = sql.toUpperCase();
      return (s.includes('JOIN') || s.includes('GROUP BY')) && (s.includes('CASTAWAY') || s.includes('SEASON'));
    }
  },
  {
    juror:'üßì', name:'Jury Member 3 ‚Äî The Superfan',
    role:'Watched every season, knew every strategic move',
    question:'"Impress me. Write something with a CTE or a window function. I want to see rank, running totals, or era comparisons. Make it complex."',
    hint:'Use WITH ... AS (...) for a CTE, or RANK()/SUM() OVER (...) for a window function. Example: rank seasons by viewership within each era.',
    validate: (sql) => {
      const s = sql.toUpperCase();
      return s.includes('WITH ') || s.includes(' OVER ') || s.includes('PARTITION BY') || s.includes('RANK()') || s.includes('ROW_NUMBER()');
    }
  }
];

let ftcJurySolved = [false, false, false];

function ftcInit() {
  if (ftcInitStarted) return;
  ftcInitStarted = true;
  // Share the playground DB if already loaded
  if (pgDB) { ftcDB = pgDB; ftcPhaseReady(); return; }
  // Show loading indicator
  const loadingEl = document.getElementById('ftc-loading');
  if (loadingEl) loadingEl.classList.remove('hidden');
  // Start loading DB independently (safe path)
  ftcLoadDBIndependent();
}

async function ftcLoadDBIndependent() {
  // If pgInitStarted already, just poll for pgDB
  if (pgInitStarted) {
    const poll = setInterval(() => {
      if (pgDB) { clearInterval(poll); ftcDB = pgDB; const l=document.getElementById('ftc-loading');if(l)l.classList.add('hidden'); ftcPhaseReady(); }
    }, 300);
    return;
  }
  // Load DB ourselves
  try {
    const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}` });
    const resp = await fetch('/survivor.db');
    const buf = await resp.arrayBuffer();
    pgDB = new SQL.Database(new Uint8Array(buf));
    pgInitStarted = true; // so playground reuses it
    ftcDB = pgDB;
    const l = document.getElementById('ftc-loading');
    if (l) l.classList.add('hidden');
    ftcPhaseReady();
  } catch(e) {
    const l = document.getElementById('ftc-loading');
    if (l) l.innerHTML = `<span style="color:#e87878">‚ö†Ô∏è Could not load database: ${e.message}</span>`;
  }
}

function ftcPhaseReady() {
  document.getElementById('ftc-loading')?.classList.add('hidden');
  ftcRenderJuryQuestions();
  ftcSetRibbonStep(ftcCurrentPhase);
}

function ftcSetRibbonStep(step) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('ftc-step-' + i);
    if (!el) continue;
    el.classList.remove('active','done');
    if (i < step) el.classList.add('done');
    else if (i === step) el.classList.add('active');
  }
}

function ftcAdvance(toPhase) {
  ftcCurrentPhase = toPhase;
  for (let i = 1; i <= 4; i++) {
    const ph = document.getElementById('ftc-phase-' + i);
    if (ph) ph.classList.toggle('hidden', i !== toPhase);
  }
  ftcSetRibbonStep(toPhase);
  if (toPhase === 4) {
    const name = localStorage.getItem('ssq_username') || 'You';
    document.getElementById('ftc-winner-name').textContent = name;
  }
  window.scrollTo(0, 0);
}

function ftcLoadPrompt(phase, sql) {
  const ed = document.getElementById('ftc-editor-' + phase);
  if (ed) ed.value = sql;
}

function ftcClear(phase) {
  const ed = document.getElementById('ftc-editor-' + phase);
  if (ed) ed.value = '';
  const ra = document.getElementById('ftc-results-' + phase);
  if (ra) { ra.classList.add('hidden'); ra.innerHTML = ''; }
  const ca = document.getElementById('ftc-chart-area-' + phase);
  if (ca) ca.classList.add('hidden');
  if (ftcChartInstances[phase]) { ftcChartInstances[phase].destroy(); delete ftcChartInstances[phase]; }
}

async function ftcRun(phase) {
  if (!ftcDB) {
    const ra = document.getElementById('ftc-results-' + phase);
    ra.innerHTML = '<div class="ftc-error-box">Database not ready yet ‚Äî please wait a moment.</div>';
    ra.classList.remove('hidden'); return;
  }
  const sql = (document.getElementById('ftc-editor-' + phase)?.value || '').trim();
  if (!sql) return;
  const btn = document.getElementById('ftc-run-' + phase);
  btn.disabled = true; btn.textContent = '‚è≥ Running...';
  const ra = document.getElementById('ftc-results-' + phase);
  ra.classList.remove('hidden');
  try {
    const results = ftcDB.exec(sql);
    if (!results || !results.length) {
      ra.innerHTML = '<div style="padding:14px;color:#6a6258;font-size:13px">Query ran successfully ‚Äî no rows returned.</div>';
      ftcResultData[phase] = null;
    } else {
      const {columns, values} = results[0];
      ftcResultData[phase] = {columns, rows: values};
      // Build table
      let th = columns.map(c=>`<th>${c}</th>`).join('');
      let tb = values.slice(0,200).map(r=>`<tr>${r.map(v=>`<td>${v==null?'<span style="color:#5a5248;font-style:italic">null</span>':v}</td>`).join('')}</tr>`).join('');
      ra.innerHTML = `<table class="ftc-table"><thead><tr>${th}</tr></thead><tbody>${tb}</tbody></table>`;
      // Show chart controls if 2+ columns
      if (columns.length >= 2) ftcShowChartControls(phase, columns);
    }
  } catch(e) {
    ra.innerHTML = `<div class="ftc-error-box">${e.message}</div>`;
    ftcResultData[phase] = null;
  }
  btn.disabled = false; btn.textContent = '‚ñ∂ Run Query';
}

function ftcShowChartControls(phase, columns) {
  const ca = document.getElementById('ftc-chart-area-' + phase);
  ca.classList.remove('hidden');
  // Populate axis selects
  const xsel = document.getElementById('ftc-xcol-' + phase);
  const ysel = document.getElementById('ftc-ycol-' + phase);
  if (!xsel || !ysel) return;
  const opts = columns.map((c,i)=>`<option value="${i}">${c}</option>`).join('');
  xsel.innerHTML = opts;
  ysel.innerHTML = opts;
  // Default: x=col0, y=col1
  xsel.value = '0';
  ysel.value = columns.length > 1 ? '1' : '0';
  ftcRenderChart(phase);
}

function ftcSetChartType(phase, type, btn) {
  ftcChartTypes[phase] = type;
  document.querySelectorAll(`.ftc-chart-type-btn[data-phase="${phase}"]`).forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ftcRenderChart(phase);
}

function ftcRenderChart(phase) {
  const data = ftcResultData[phase];
  if (!data) return;
  const xIdx = parseInt(document.getElementById('ftc-xcol-' + phase)?.value || '0');
  const yIdx = parseInt(document.getElementById('ftc-ycol-' + phase)?.value || '1');
  const titleEl = document.getElementById('ftc-chart-title-' + phase);
  const chartTitle = titleEl ? titleEl.value || 'Survivor Data' : 'Survivor Data';
  const type = ftcChartTypes[phase] || 'bar';

  const labels = data.rows.map(r => String(r[xIdx] ?? ''));
  const values = data.rows.map(r => {
    const v = r[yIdx];
    return v == null ? 0 : (isNaN(Number(v)) ? 0 : Number(v));
  });

  const canvas = document.getElementById('ftc-canvas-' + phase);
  if (!canvas) return;

  if (ftcChartInstances[phase]) { ftcChartInstances[phase].destroy(); }

  // Survivor-themed chart config
  const isHoriz = type === 'horizontalBar';
  const chartType = isHoriz ? 'bar' : type;
  const isDoughnut = type === 'doughnut';

  const bgColors = isDoughnut
    ? data.rows.map((_,i) => FTC_PALETTE[i % FTC_PALETTE.length])
    : FTC_PALETTE[0];
  const borderColors = isDoughnut
    ? data.rows.map((_,i) => FTC_PALETTE[i % FTC_PALETTE.length])
    : '#c0551a';

  ftcChartInstances[phase] = new Chart(canvas, {
    type: chartType,
    data: {
      labels,
      datasets: [{
        label: data.columns[yIdx],
        data: values,
        backgroundColor: bgColors,
        borderColor: borderColors,
        borderWidth: isDoughnut ? 2 : 1,
        borderRadius: isDoughnut ? 0 : 4,
      }]
    },
    options: {
      indexAxis: isHoriz ? 'y' : 'x',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: isDoughnut, labels: { color: '#3a3228', font: { family: 'Newsreader,Georgia,serif', size: 12 } } },
        title: {
          display: true,
          text: chartTitle,
          color: '#d4611e',
          font: { family: 'Newsreader,Georgia,serif', size: 16, weight: 'bold' },
          padding: { bottom: 12 }
        }
      },
      scales: isDoughnut ? {} : {
        x: {
          ticks: { color: '#6a6258', font: { family: "'JetBrains Mono',monospace", size: 10 }, maxRotation: 45 },
          grid: { color: '#e8e0d4' }
        },
        y: {
          ticks: { color: '#6a6258', font: { family: "'JetBrains Mono',monospace", size: 10 } },
          grid: { color: '#e8e0d4' }
        }
      }
    }
  });
  // Fix canvas height
  canvas.parentElement.style.height = '360px';
}

function ftcSaveChart(phase) {
  const canvas = document.getElementById('ftc-canvas-' + phase);
  if (!canvas || !ftcChartInstances[phase]) {
    alert('Run a query and build a chart first!'); return;
  }
  // Draw onto a new canvas with white background + Survivor watermark
  const src = canvas;
  const out = document.createElement('canvas');
  out.width = src.width; out.height = src.height;
  const ctx = out.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, out.width, out.height);
  ctx.drawImage(src, 0, 0);
  // Watermark
  ctx.font = 'bold 11px JetBrains Mono, monospace';
  ctx.fillStyle = 'rgba(212,97,30,0.4)';
  ctx.textAlign = 'right';
  ctx.fillText('üî• Learn SQL with SURVIVOR ‚Äî cornettlabs.com', out.width - 10, out.height - 8);
  const link = document.createElement('a');
  const titleEl = document.getElementById('ftc-chart-title-' + phase);
  const titleText = (titleEl?.value || 'survivor-chart').replace(/\s+/g,'-').toLowerCase();
  link.download = `${titleText}.png`;
  link.href = out.toDataURL('image/png');
  link.click();
}

function ftcRenderJuryQuestions() {
  const container = document.getElementById('ftc-jury-questions');
  if (!container) return;
  container.innerHTML = FTC_JURY.map((jq, i) => {
    const idx = i;
    return `<div class="ftc-jury-card ${ftcJurySolved[idx]?'solved':''}" id="ftc-jury-card-${idx}">
      <div class="ftc-jury-juror">
        <div class="ftc-juror-avatar">${jq.juror}</div>
        <div><div class="ftc-juror-name">${jq.name}</div><div class="ftc-juror-role mono">${jq.role}</div></div>
        ${ftcJurySolved[idx]?'<span style="margin-left:auto;font-size:20px">‚úÖ</span>':''}
      </div>
      <p class="ftc-jury-q">${jq.question}</p>
      <div class="ftc-jury-hint">üí° ${jq.hint}</div>
      <div class="ftc-editor-wrap">
        <div class="ftc-editor-hdr">
          <span class="ftc-editor-label mono">YOUR ANSWER</span>
          <div style="display:flex;gap:6px">
            <button class="ftc-run-btn mono" onclick="ftcRunJury(${idx})">‚ñ∂ Run & Check</button>
          </div>
        </div>
        <textarea class="ftc-editor mono" id="ftc-jury-editor-${idx}" style="min-height:80px" spellcheck="false" placeholder="-- Write your SQL here...">${ftcJurySolved[idx]?'-- ‚úÖ Already answered!':''}</textarea>
      </div>
      <div id="ftc-jury-results-${idx}" style="margin-top:8px;max-height:200px;overflow:auto;background:#1a1612;border:1px solid #3a3228;border-radius:7px;display:none"></div>
      <div class="ftc-jury-feedback ${ftcJurySolved[idx]?'correct':''}" id="ftc-jury-fb-${idx}" style="${ftcJurySolved[idx]?'':'display:none'}">
        ${ftcJurySolved[idx]?'üéâ The jury nods. That\'s a good answer.':''}
      </div>
    </div>`;
  }).join('');
}

async function ftcRunJury(idx) {
  if (!ftcDB) { alert('Database still loading ‚Äî try again in a moment.'); return; }
  const sql = (document.getElementById('ftc-jury-editor-' + idx)?.value || '').trim();
  if (!sql) return;
  const resultsEl = document.getElementById('ftc-jury-results-' + idx);
  const fbEl = document.getElementById('ftc-jury-fb-' + idx);

  try {
    const results = ftcDB.exec(sql);
    resultsEl.style.display = 'block';
    if (!results || !results.length) {
      resultsEl.innerHTML = '<div style="padding:10px;color:#6a6258;font-size:12px">No rows returned.</div>';
    } else {
      const {columns, values} = results[0];
      let th = columns.map(c=>`<th>${c}</th>`).join('');
      let tb = values.slice(0,50).map(r=>`<tr>${r.map(v=>`<td>${v==null?'null':v}</td>`).join('')}</tr>`).join('');
      resultsEl.innerHTML = `<table class="ftc-table"><thead><tr>${th}</tr></thead><tbody>${tb}</tbody></table>`;
    }
    // Validate
    const jq = FTC_JURY[idx];
    const passed = jq.validate(sql);
    fbEl.style.display = 'block';
    if (passed) {
      ftcJurySolved[idx] = true;
      fbEl.className = 'ftc-jury-feedback correct';
      fbEl.textContent = 'üéâ The jury nods. That\'s a good answer.';
      document.getElementById('ftc-jury-card-' + idx).classList.add('solved');
      // Check if all solved
      if (ftcJurySolved.every(Boolean)) {
        document.getElementById('ftc-jury-advance').classList.remove('hidden');
      }
    } else {
      fbEl.className = 'ftc-jury-feedback incorrect';
      fbEl.textContent = 'ü§î The jury isn\'t convinced. Check the hint ‚Äî make sure you\'re using the right SQL technique for this question.';
    }
  } catch(e) {
    resultsEl.style.display = 'block';
    resultsEl.innerHTML = `<div class="ftc-error-box">${e.message}</div>`;
    fbEl.style.display = 'none';
  }
}

// ===== INIT =====
renderModuleGrid();updateGlobal();pgRenderHistory();
</script>
</body>
</html>
